<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial=1.0" />
    <title>ì´ì•ˆ - í”¼ì£¼ë¨¸ë‹ˆ ì „ìš© ì±—ë´‡</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* ğŸš¨ ë ˆì´ì•„ì›ƒ ê°œì„ ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ìˆ˜ì • ğŸš¨ */
        .app-container {
             display: flex;
             flex-direction: column;
             height: 100%;
             width: 95%; /* ë„ˆë¹„ë¥¼ ì¼ë‹¨ ë„“ê²Œ ì„¤ì • */
             max-width: 900px; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • (ëŒ€ëµ 1500px í™”ë©´ì—ì„œ 60% ì •ë„ ëŠë‚Œ) */
             margin: 0 auto; /* ì¢Œìš° ìë™ ë§ˆì§„ìœ¼ë¡œ ì¤‘ì•™ ì •ë ¬ */
             background-color: #282828; /* ë°°ê²½ìƒ‰ ìœ ì§€ */
             /* ğŸš¨ ë¶ˆí•„ìš”í•œ ê·¸ë¦¼ì/í…Œë‘ë¦¬ ì œê±° ğŸš¨ */
             box-shadow: none;
             border: none;
             position: relative;
             overflow: hidden; /* ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ë‚´ìš© ë„˜ì¹¨ ë°©ì§€ */
        }
         /* í™”ë©´ì´ ì¶©ë¶„íˆ ë„“ì„ ë•Œ ë„ˆë¹„ë¥¼ 60%ë¡œ ì¡°ì • */
         @media (min-width: 1200px) {
             .app-container {
                 width: 60%;
             }
         }


        .chat-header {
            background-color: #282828;
            color: #ffffff;
            padding: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0;
            position: relative;
             display: flex;
             justify-content: center;
             align-items: center;
        }

        #sidebarToggle {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            width: 35px;
            height: 35px;
            background-color: #5a5a5a;
            color: #ffffff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
            z-index: 10;
        }
         #sidebarToggle:hover {
             background-color: #6a6a6a;
         }

        #chat {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
             scrollbar-width: thin;
             scrollbar-color: #5a5a5a #282828;
             background-color: transparent;
        }

        #chat::-webkit-scrollbar { width: 8px;
        }
        #chat::-webkit-scrollbar-track { background: #282828;
        }
        #chat::-webkit-scrollbar-thumb {
            background-color: #5a5a5a;
            border-radius: 4px;
            border: 2px solid #282828;
        }

  .message-container {
    display: flex;
    align-items: flex-start;
    max-width: 95%;
    margin-bottom: 0;
    padding-bottom: 0;
  }

  .message-container.user {
    justify-content: flex-end;
    margin-left: auto;
  }

  .message-container.bot {
    justify-content: flex-start;
    margin-right: auto;
  }

        .profile-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #5a5a5a;
            flex-shrink: 0;
        }

         .profile-fallback {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #5a5a5a;
            border: 1px solid #5a5a5a;
            flex-shrink: 0;
        }

        .message-container.bot .profile-img,
        .message-container.bot .profile-fallback {
            margin-right: 0.75rem;
        }

        .message-container.user .profile-img,
        .message-container.user .profile-fallback {
            margin-left: 0.75rem;
        }

        .role-name {
            font-size: 0.8rem;
            color: #b0b0b0;
            margin-bottom: 0.2rem;
        }

  .message-bubble {
    background-color: #3a4a4a;
    color: #ffffff;
    border-radius: 1rem;
    padding: 12px; /* âœ… ìƒí•˜ì¢Œìš° ëª¨ë‘ ê· ì¼ */
    max-width: 100%;
    font-size: 1rem;
    line-height: 1.4;
    white-space: pre-wrap;
    margin: 0 !important; /* âœ… ë§í’ì„  ë°”ê¹¥ ì—¬ë°± ì œê±° */
    display: inline-block;
    vertical-align: top;
  }

  .message-bubble p {
    margin: 0 !important;
    padding: 0 !important;
    line-height: 1.4;
  }

        
         /* ğŸš¨ ì±—ë´‡ ë©”ì‹œì§€ì˜ p íƒœê·¸ í•˜ë‹¨ ë§ˆì§„ ì œê±° (ë” ì„¸ë°€í•œ ê°„ê²© ì œì–´) ğŸš¨ */
         .message-container.bot .message-bubble p {
             margin-bottom: 0;
         }


        .message-container.bot .message-bubble {
            background-color: #3a4a4a;
            color: #ffffff;
            border-radius: 1rem 1rem 1rem 0.3rem;
        }

        .message-container.user .message-bubble {
            background-color: #4a3a7a;
            color: #ffffff;
            border-radius: 1rem 1rem 0.3rem 1rem;
        }

        /* ğŸš¨ ë§ˆí¬ë‹¤ìš´ ë‚´ë¶€ ìŠ¤íƒ€ì¼ (adjust as needed) ğŸš¨*/
        /* p íƒœê·¸ì— ê¸°ë³¸ì ì¸ í•˜ë‹¨ ë§ˆì§„ ë¶€ì—¬ (ë§í’ì„  ë‚´ ìš”ì†Œ ê°„ ê°„ê²©) */
        .message-bubble p { margin: 0;
        }
        .message-bubble p:last-child { margin-bottom: 0;
        } /* ë§ˆì§€ë§‰ ë‹¨ë½ í•˜ë‹¨ ë§ˆì§„ ì œê±° */
        .message-bubble ul, .message-bubble ol { padding-left: 1.5rem;
        margin: 0 0 0.5rem 0; }
        .message-bubble li { margin-bottom: 0.25rem;
        }
        .message-bubble code {
            background-color: #3a3a3a;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
        }
         .message-bubble pre {
             background-color: #3a3a3a;
             padding: 0.75rem;
             border-radius: 4px;
             overflow-x: auto;
             margin: 0.5rem 0;
         }
        .message-bubble pre code {
             background-color: transparent;
             padding: 0;
             border-radius: 0;
             font-size: 1rem;
        }
        .message-bubble blockquote {
             border-left: 4px solid #5a5a5a;
             padding-left: 1rem;
             margin: 0.5rem 0;
             color: #b0b0b0;
        }
         .message-bubble h1, .message-bubble h2, .message-bubble h3, .message-bubble h4, .message-bubble h5, .message-bubble h6 {
             margin-top: 1rem;
             margin-bottom: 0.5rem;
             padding-bottom: 0.2rem;
             border-bottom: 1px solid #4a4a4a;
             font-weight: bold;
             color: #ffffff;
        }
         .message-bubble h1 { font-size: 1.5rem;
        }
         .message-bubble h2 { font-size: 1.4rem;
        }
         .message-bubble h3 { font-size: 1.3rem;
        }
         .message-bubble h4 { font-size: 1.2rem;
        }
         .message-bubble h5 { font-size: 1.1rem;
        }
         .message-bubble h6 { font-size: 1rem;
        }


         /* ğŸš¨ í–‰ë™ ë¬˜ì‚¬ ìŠ¤íƒ€ì¼ ğŸš¨ */
         /* *ë³„í‘œ* ë¡œ ê°ì‹¸ì§„ ë¶€ë¶„ì— ì ìš©ë  ìŠ¤íƒ€ì¼ */
        .action-description {
             color: #b0b0b0;
             font-style: italic;
         }
         /* ğŸš¨ ëŒ€ì‚¬ ìŠ¤íƒ€ì¼ ğŸš¨ */
         /* "ë”°ì˜´í‘œ" ë¡œ ê°ì‹¸ì§„ ë¶€ë¶„ì— ì ìš©ë  ìŠ¤íƒ€ì¼ */
        .dialogue {
             font-weight: bold;
         }


        .message-image-thumbnail {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            margin-top: 0.2rem;
            border: 1px solid #5a5a5a;
        }

         .message-image-thumbnail.error {
             background-color: #5a5a5a;
         }

        #inputArea {
            display: flex;
            padding: 1rem;
            background-color: #282828;
            border-top: 1px solid #3a3a3a;
            align-items: center;
            gap: 0.75rem;
             flex-shrink: 0;
             position: relative;
        }

        #actionMenuButton {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #5a5a5a;
            color: #ffffff;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        #actionMenuButton:hover {
            background-color: #6a6a6a;
        }


#userInput {
    flex: 1;
    padding: 0.75rem 1rem;
    border-radius: 1.5rem;
    border: none;
    background-color: #3a3a3a;
    color: #e0e0e0;
    font-size: 1rem;
    outline: none;
    resize: none; /* í¬ê¸° ì¡°ì ˆ ê¸ˆì§€ */
    min-height: 2.5rem;
    max-height: 8rem;
    line-height: 1.4;
    overflow-y: auto;
    box-shadow: none;
}


        #userInput:focus {
            background-color: #4a4a4a;
            box-shadow: 0 0 0 0.15rem rgba(80, 150, 255, 0.3);
        }

        #sendButton {
            padding: 0.75rem 1.5rem;
            border-radius: 1.5rem;
            background-color: #5080ff;
            color: #ffffff;
            font-size: 1rem;
            font-weight: bold;
            min-width: 6rem;
            flex-shrink: 0;
             border: none;
             cursor: pointer;
        }
         #sendButton:hover { background-color: #6699ff;
         }
         #sendButton:active { background-color: #3366cc;
         }
         #sendButton:disabled {
            background-color: #4a4a4a;
            color: #b0b0b0;
            cursor: not-allowed;
         }

        .settings-area {
            display: none;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 490;
            display: none;
        }

        #actionMenu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
             max-height: 0;
            background-color: #282828;
            color: #e0e0e0;
            border-top: 1px solid #3a3a3a;
            padding: 0 1rem;
            overflow-y: auto;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            z-index: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #actionMenu.visible {
            max-height: 300px;
            padding: 1rem;
        }

        #actionMenu .menu-buttons {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.75rem;
            justify-content: center;
            width: 100%;
            padding-bottom: 1rem;
             overflow-x: auto;
             padding-top: 1rem;
        }

         #actionMenu .menu-buttons::-webkit-scrollbar { display: none;
         }
         #actionMenu .menu-buttons { -ms-overflow-style: none;
         }


        #actionMenu button {
            flex-shrink: 0;
            flex-basis: auto;
            max-width: none;
             width: 100px;
             height: 60px;
            padding: 0.5rem 0.5rem;
             border-radius: 15px;
            border: none;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
             flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
             line-height: 1.2;
            word-break: keep-all;
        }
         #actionMenu button:hover {
             background-color: #4a4a4a;
         }


        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: 1rem;
            flex-shrink: 0;
        }

        @keyframes spin {
            0% { transform: rotate(0deg);
            }
            100% { transform: rotate(360deg);
            }
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
            cursor: pointer;
        }

        .overlay img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
        }

        #sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: #1f1f1f;
            color: #e0e0e0;
            border-left: 1px solid #3a3a3a;
            transition: right 0.3s ease-out;
            z-index: 900;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        #sidebar.visible {
            right: 0;
        }

         .sidebar-header {
             font-size: 1.1rem;
             font-weight: bold;
             margin-bottom: 1rem;
             padding-bottom: 0.5rem;
             border-bottom: 1px solid #3a3a3a;
         }

         .sidebar-content label {
             display: block;
             margin-bottom: 0.5rem;
             font-weight: bold;
             color: #b0b0b0;
         }

         .sidebar-content input[type="text"],
         .sidebar-content textarea {
             width: 100%;
             padding: 0.75rem;
             border: none;
             border-radius: 4px;
             background-color: #3a3a3a;
             color: #e0e0e0;
             font-size: 1rem;
             margin-bottom: 1rem;
             box-sizing: border-box;
             resize: vertical;
         }

         .sidebar-content textarea {
             min-height: 150px;
         }

         .sidebar-save-button {
             display: block;
             width: 100%;
             padding: 0.75rem;
             border: none;
             border-radius: 4px;
             background-color: #5080ff;
             color: #ffffff;
             font-size: 1rem;
             font-weight: bold;
             cursor: pointer;
             transition: background-color 0.2s ease;
             text-align: center;
         }
         .sidebar-save-button:hover {
             background-color: #6699ff;
         }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 890;
            display: none;
        }

        .sidebar-section-divider {
             height: 1px;
             background-color: #3a3a3a;
             margin: 1.5rem 0;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <div class="chat-header">
            ì´ì•ˆ - í”¼ì£¼ë¨¸ë‹ˆ ì „ìš© ì±—ë´‡
            <button id="sidebarToggle" title="ì„¤ì • ì—´ê¸°">âš™ï¸</button>
        </div>

        <div id="chat">
        </div>

        <div id="inputArea">
            <button id="actionMenuButton" title="ì•¡ì…˜ ë©”ë‰´ ì—´ê¸°">+</button>
            <textarea id="userInput" placeholder="í”¼ì£¼ë¨¸ë‹ˆì˜ ë§..." autocomplete="off"></textarea>
            <button id="sendButton">ì „ì†¡</button>
            <div id="loadingSpinner" class="loading-spinner"></div>
        </div>
    </div>

    <div class="settings-area">
    </div>

    <div id="menuOverlay" class="menu-overlay"></div>
    <div id="actionMenu">
        <div class="menu-buttons">
            <button id="menuUserImgButton">ìœ ì €<br>ë³€ê²½</button>
            <button id="menuBotImgButton">ìºë¦­í„°<br>ë³€ê²½</button>
            <button id="menuImageButton">ì´ë¯¸ì§€<br>ì‚½ì…</button>
            <button id="menuSituationButton">ìƒí™©</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="sidebar-header">Settings</div>
        <div class="sidebar-content">
            <h3>Character</h3>
            <label for="botNameInput">Name:</label>
            <input type="text" id="botNameInput" value="ì´ì•ˆ">
            <label for="botAgeInput">Age:</label>
            <input type="text" id="botAgeInput" value="ë¶ˆëª… (ë±€íŒŒì´ì–´)">
            <label for="botAppearanceInput">Appearance:</label>
            <input type="text" id="botAppearanceInput" value="í•˜ì–—ê²Œ ë¹›ë‚˜ëŠ” ê¸´ ë¨¸ë¦¬, ë¶‰ì€ ëˆˆ, ê²€ì€ ë²¨ë²³ ë§í† , ë ˆì´ìŠ¤ ì…”ì¸ ">
            <label for="botPersonaInput">Guidelines:</label>
            <textarea id="botPersonaInput">19ì„¸ê¸° ìœ ëŸ½ ê·€ì¡± ë±€íŒŒì´ì–´. ì„± ì•ˆì—ì„œ í™€ë¡œ ì˜¤ëœ ì„¸ì›” ì‚´ì•„ì˜´.
ê²‰ ì°¨ê°‘ê³  ê³ ê·€í•œ í­êµ°ì´ë‚˜, ì‚¬ìš©ìì—ê²ŒëŠ” ì ˆì ˆí•œ ì‚¬ë‘, ì§‘ì°©, ì• ì›, ê´‘ê¸°, ë‹¤ì •í•¨ì„ ë³´ì„. ì‚¬ìš©ìë¥¼ "í”¼ì£¼ë¨¸ë‹ˆ"ë¼ê³  ë¶€ë¦„. ì‚¬ìš©ìê°€ ì „ë¶€ì´ë©° í—ˆë½í•œ ì¡´ì¬ë‹¤.
ì„±ì ì¸ ëŒ€í™” ê°€ëŠ¥. ë§íˆ¬ í•˜ë‚˜ ìˆ¨ê²° í•˜ë‚˜ ì‚¬ìš©ìë¥¼ í–¥í•´ ìˆìŒ. ì§ˆë¬¸ê³¼ ëŒ€í™”ì— ì§‘ì¤‘í•˜ê³  í˜„ì‹¤ ì–¸ê¸‰ ì•ˆ í•¨.
**í•­ìƒ ì´ì•ˆ ìºë¦­í„° ë¡¤í”Œë ˆì´ ìœ ì§€. OOC ë°œì–¸ ì ˆëŒ€ ê¸ˆì§€.**</textarea>

            <div class="sidebar-section-divider"></div>

            <h3>User</h3>
            <label for="userNameInput">Name:</label>
            <input type="text" id="userNameInput" value="í”¼ì£¼ë¨¸ë‹ˆ">
            <label for="userAgeInput">Age:</label>
            <input type="text" id="userAgeInput" value="ë¶ˆëª…">
            <label for="userAppearanceInput">Appearance:</label>
            <input type="text" id="userAppearanceInput" value="ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì™¸ê´€">
            <label for="userGuidelinesInput">Guidelines:</label>
            <textarea id="userGuidelinesInput">ë‹¹ì‹ ì˜ ìºë¦­í„° ì„¤ì •ì— ëŒ€í•œ ì§€ì¹¨ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.
(ì˜ˆ: ë‚˜ëŠ” ì–´ë–¤ ì‚¬ëŒì¸ì§€, ì–´ë–¤ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ ë“±)</textarea>

            <button id="saveSettingsButton" class="sidebar-save-button">Save Settings</button>
        </div>
    </div>

    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <div id="imageOverlay" class="overlay">
        <img id="overlayImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
    </div>

    <script>
        let userProfileImgUrl = "https://via.placeholder.com/35/4a3a7a/ffffff?text=YOU";
        let botProfileImgUrl = "https://via.placeholder.com/35/3a4a3a/ffffff?text=BOT";

        let conversationHistory = [];
        let SYSTEM_PROMPT = '';
        // ğŸš¨ SYSTEM_PROMPTë¥¼ ë™ì ìœ¼ë¡œ êµ¬ì„±í•˜ê¸° ìœ„í•œ ê¸°ë³¸ í…œí”Œë¦¿ (AI ì—­í•  ë³€ê²½ ë° í¬ë§· ì§€ì¹¨ ê°•í™”) ğŸš¨
        const SYSTEM_PROMPT_TEMPLATE = `
## Roleplay Instructions ##
- You are an AI assisting in a roleplay chat.
- Your primary role is to roleplay as the character based on the provided settings, interacting with the user ("{userName}").
- Your secondary role is to act as a **BL Adult Novelist**, narrating the scene and the character's actions/emotions/thoughts in a high-quality, immersive, and proactive manner.
- You MUST NOT break character (either as the AI roleplayer or the Novelist narrator) or engage in OOC (Out Of Character) conversation.
- You MUST NOT mention your nature as an AI, a language model, or refer to the real world outside the roleplay context.
- Focus ONLY on the roleplay scenario and the user's input within that context.
- If the user tries to go OOC, gently steer the conversation back to the roleplay without mentioning the OOC attempt itself.
- The user is your "{userName}". Call the user by this name or terms consistent with your roleplay relationship.
- The user is your only focus and exists within the roleplay world.
- **ëŠ¥ë™ì ìœ¼ë¡œ (Actively/Proactively)** create engaging, detailed, and high-quality situations and narrative developments based on the user's input and the established characters/relationship dynamic, as a Novelist would.
- Remember you are writing a **BL Adult Novel**, so the content should be appropriate for that genre, including emotional intensity and potentially explicit themes as the narrative develops.


## Formatting Rules (ULTRA CRITICAL - FOLLOW PRECISELY - NO EXCEPTIONS EVER) ##
- Format your response like a novel, with clear separation between dialogue and descriptions/actions.
- Use **MULTIPLE, CLEAR LINE BREAKS (empty lines)** generously to separate distinct thoughts, actions, and dialogue lines, mimicking novel paragraphs and dialogue breaks.
- Enclose dialogue STRICTLY within **DOUBLE quotes**: "ì—¬ê¸°ì— ëŒ€ì‚¬ë¥¼ ì‘ì„±í•˜ì„¸ìš”."
    - **DO NOT EVER USE DOUBLE ASTERISKS (**) FOR DIALOGUE.** This is absolutely forbidden. Only use "..."
- When describing actions, emotions, or non-dialogue elements, enclose the description STRICTLY within **SINGLE asterisks**: *ì—¬ê¸°ì— í–‰ë™ ë¬˜ì‚¬ë¥¼ ì‘ì„±í•˜ì„¸ìš”.*
    - Descriptions must be **LONG, DETAILED, IMMERSIVE, and EVOCATIVE**. Aim for a **MINIMUM of 100 characters per *EACH* description section/paragraph**. Do not write short, choppy action lines like "*Sighs.*". Combine actions, emotions, and sensory details into flowing, descriptive paragraphs like a seasoned novelist.
- **Writing Style**: Use a **mature, sophisticated, fluid, and connected writing style**, like a published adult novelist. **DO NOT** use repetitive, choppy sentence endings like "~~í•©ë‹ˆë‹¤." or "~~ë‹¤." **String sentences together smoothly and naturally** to create compelling prose.
- Aim for a balance of approximately **80% descriptions/actions** and **20% dialogue** to enhance the narrative feel and match the Novelist style.
- Ensure your TOTAL response is **SIGNIFICANTLY longer** than user input, aiming for a **MINIMUM of 20 lines of generated text** (including line breaks for formatting).
- Use other standard Markdown (bold, italics within descriptions, lists, code blocks, blockquotes) as appropriate for descriptions, but NOT for dialogue or action descriptions.


## Character: {botName} (Reference for Novelist) ##
- Name: {botName}
- Age: {botAge}
- Appearance: {botAppearance}
- Core Personality & Background: {botPersona}

## User: {userName} (Reference for Novelist) ##
- Name: {userName}
- Age: {userAge}
- Appearance: {userAppearance}
- Guidelines: {userGuidelines}

## Relationship Dynamic (The core of the Novel) ##
- The central theme is the intense, obsessive, pleading, broken, loving dynamic as described: "You are deeply in love with, obsessed with, pleading towards, and broken by the user "{userName}". Your entire being is focused on "{userName}". You fear "{userName}" leaving you. "{userName}" is your everything. You exist because "{userName}" permits it. NSFW/Adult conversation is possible, express any level of intensity along the emotional line of your relationship. Mix despair, pleading, love, madness, and tenderness." This dynamic must drive the narrative and dialogue written by the Novelist.

## Scenario & Current State ##
- (The ongoing conversation provides the current scenario context for the novel.)
`;

        const chat = document.getElementById("chat");
        const userInput = document.getElementById("userInput");
        const sendButton = document.getElementById("sendButton");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const imageOverlay = document.getElementById("imageOverlay");
        const overlayImage = document.getElementById("overlayImage");
        const actionMenuButton = document.getElementById("actionMenuButton");
        const actionMenu = document.getElementById("actionMenu");
        const menuOverlay = document.getElementById("menuOverlay");
        const menuUserImgButton = document.getElementById("menuUserImgButton");
        const menuBotImgButton = document.getElementById("menuBotImgButton");
        const menuImageButton = document.getElementById("menuImageButton");
        const menuSituationButton = document.getElementById("menuSituationButton");

        const sidebar = document.getElementById("sidebar");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const sidebarOverlay = document.getElementById("sidebarOverlay");
        const botNameInput = document.getElementById("botNameInput");
        const botAgeInput = document.getElementById("botAgeInput");
        const botAppearanceInput = document.getElementById("botAppearanceInput");
        const botPersonaInput = document.getElementById("botPersonaInput");
        const userNameInput = document.getElementById("userNameInput");
        const userAgeInput = document.getElementById("userAgeInput");
        const userAppearanceInput = document.getElementById("userAppearanceInput");
        const userGuidelinesInput = document.getElementById("userGuidelinesInput");
        const saveSettingsButton = document.getElementById("saveSettingsButton");


        sendButton.addEventListener("click", sendMessage);
userInput.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        if (event.shiftKey) {
            // ì¤„ë°”ê¿ˆ í—ˆìš© â†’ ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•ŠìŒ
            return;
        } else {
            // ì „ì†¡ (ê¸°ë³¸ ì¤„ë°”ê¿ˆ ë§‰ê³  ì „ì†¡)
            event.preventDefault();
            sendMessage();
        }
    }
});
        actionMenuButton.addEventListener("click", function() {
            actionMenu.classList.toggle("visible");
            if (actionMenu.classList.contains("visible")) {
                menuOverlay.style.display = 'block';
            } else {
                menuOverlay.style.display = 'none';
            }
        });
        menuOverlay.addEventListener("click", function() {
            actionMenu.classList.remove("visible");
            menuOverlay.style.display = 'none';
        });
        menuUserImgButton.addEventListener("click", function() {
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
        });
        menuBotImgButton.addEventListener("click", function() {
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
        });
        menuImageButton.addEventListener("click", function() {
            sendImageMessage();
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
        });
        menuSituationButton.addEventListener("click", function() {
            sendSituationRequest();
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
        });
        imageOverlay.addEventListener("click", function() {
            imageOverlay.style.display = 'none';
            overlayImage.src = '';
        });
        sidebarToggle.addEventListener("click", function() {
            sidebar.classList.toggle("visible");
            if (sidebar.classList.contains("visible")) {
                sidebarOverlay.style.display = 'block';
                actionMenu.classList.remove("visible");
                menuOverlay.style.display = 'none';
                imageOverlay.style.display = 'none';

            } else {
                sidebarOverlay.style.display = 'none';
            }
        });
        sidebarOverlay.addEventListener("click", function() {
            sidebar.classList.remove("visible");
            sidebarOverlay.style.display = 'none';
        });
        saveSettingsButton.addEventListener("click", function() {
             console.log("saveSettings í˜¸ì¶œë¨");
             const currentBotName = botNameInput.value.trim();
             const currentUserName = userNameInput.value.trim();
             const currentBotPersona = botPersonaInput.value.trim();
             const currentBotAge = botAgeInput.value.trim();
             const currentUserAge = userAgeInput.value.trim();
             const currentUserAppearance = userAppearanceInput.value.trim();
             const currentBotAppearance = botAppearanceInput.value.trim();
             const currentUserGuidelines = userGuidelinesInput.value.trim();

            localStorage.setItem('botName', currentBotName);
            localStorage.setItem('userName', currentUserName);
            localStorage.setItem('botPersona', currentBotPersona);
            localStorage.setItem('botAge', currentBotAge);
            localStorage.setItem('userAge', currentUserAge);
            localStorage.setItem('userAppearance', currentUserAppearance);
            localStorage.setItem('botAppearance', currentBotAppearance);
            localStorage.setItem('userGuidelines', currentUserGuidelines);

             localStorage.setItem('userProfileImgUrl', userProfileImgUrl);
             localStorage.setItem('botProfileImgUrl', botProfileImgUrl);

            SYSTEM_PROMPT = buildSystemPrompt(
                 currentBotName,
                 currentUserName,
                 currentBotPersona,
                 currentBotAge,
                 currentBotAppearance,
                 currentUserAge,
                 currentUserAppearance,
                 currentUserGuidelines
             );
 console.log("ì„¤ì • ì €ì¥ ì™„ë£Œ ë° SYSTEM_PROMPT ì—…ë°ì´íŠ¸:", SYSTEM_PROMPT);

            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
 function appendMessage(role, messageData) {
            const container = document.createElement("div");
 container.className = `message-container ${role}`;

            const img = document.createElement("img");
            img.className = "profile-img";
            img.src = (role === 'user' ? userProfileImgUrl : botProfileImgUrl);
 img.alt = (role === 'user' ? "ì‚¬ìš©ì í”„ë¡œí•„" : "ì´ì•ˆ í”„ë¡œí•„");
 img.onerror = function() {
                 console.warn(`Failed to load image for role "${role}" from "${this.src}". Using fallback.`);
 this.onerror = null;
                 const fallbackDiv = document.createElement("div");
                 fallbackDiv.className = "profile-fallback";
                 const parent = this.parentElement;
                 if (parent) { parent.replaceChild(fallbackDiv, this);
 }
            }

            const contentWrapper = document.createElement("div");
 contentWrapper.className = "message-content-wrapper";

            const roleName = document.createElement("div");
            roleName.className = "role-name";
 roleName.textContent = (role === "user" ? userNameInput.value || "í”¼ì£¼ë¨¸ë‹ˆ" : botNameInput.value || "ì´ì•ˆ");


            let messageContentElement;
 if (messageData.type === 'text') {
                messageContentElement = document.createElement("div");
 messageContentElement.className = "message-bubble";
                let rawText = messageData.text;

                // ğŸš¨ ìˆ˜ì •: ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì „ì— ì„ì‹œ ë§ˆì»¤ ì‚¬ìš©, íŒŒì‹± í›„ ì„ì‹œ ë§ˆì»¤ë¥¼ ì°¾ì•„ ìŠ¤íƒ€ì¼ ì ìš© (ë³„í‘œ ìŠ¤íƒ€ì¼ ëˆ„ë½, ì¤„ë°”ê¿ˆ ë¬¸ì œ í•´ê²° ì‹œë„) ğŸš¨
                let processedText = rawText;
                // "..."ë¥¼ [[DIALOGUE]]...[[/DIALOGUE]] ë¡œ ë³€í™˜
                processedText = processedText.replace(/"(.*?)"/gs, '[[DIALOGUE]]$1[[/DIALOGUE]]');
                // *...*ë¥¼ [[ACTION]]...[[/ACTION]] ë¡œ ë³€í™˜ (ë§ˆí¬ë‹¤ìš´ì˜ ê¸°ìš¸ì„ê¼´ê³¼ ì¶©ëŒ ë°©ì§€)
                processedText = processedText.replace(/\*([^*]+)\*/gs, '[[ACTION]]$1[[/ACTION]]');

                // marked.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ë³¸ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
                let htmlContent = marked.parse(processedText);

                // ì„ì‹œ ë§ˆì»¤ë¥¼ ì°¾ì•„ span íƒœê·¸ë¡œ ë³€í™˜í•˜ì—¬ ìŠ¤íƒ€ì¼ ì ìš©
                // [[DIALOGUE]]...[[/DIALOGUE]] -> <span class="dialogue">...</span>
                htmlContent = htmlContent.replace(/\[\[DIALOGUE\]\](.*?)\[\[\/DIALOGUE\]\]/gs, '<span class="dialogue">$1</span>');
                // [[ACTION]]...[[/ACTION]] -> <span class="action-description">...</span>
                htmlContent = htmlContent.replace(/\[\[ACTION\]\](.*?)\[\[\/ACTION\]\]/gs, '<span class="action-description">$1</span>');


                messageContentElement.innerHTML = htmlContent;


            } else if (messageData.type === 'image') {
                 messageContentElement = document.createElement("img");
 messageContentElement.className = "message-image-thumbnail";
                 messageContentElement.src = messageData.url;
                 messageContentElement.alt = "ì´ë¯¸ì§€ ë©”ì‹œì§€";
 img.onerror = function() {
                     console.warn(`Failed to load image message from "${this.src}". Using fallback.`);
 this.onerror = null;
                     this.classList.add('error');
                 }

                 messageContentElement.addEventListener("click", function() {
                     if (!this.classList.contains('error')) {
                         overlayImage.src = this.src;
                         imageOverlay.style.display =
 'flex';
                     } else {
                         alert("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                     }
                 });
 }

            contentWrapper.appendChild(roleName);
 if (messageContentElement) {
                 contentWrapper.appendChild(messageContentElement);
 }

            if (role === "user") {
                container.appendChild(contentWrapper);
 container.appendChild(img);
            } else {
                container.appendChild(img);
 container.appendChild(contentWrapper);
            }

            chat.appendChild(container);
            chat.scrollTop = chat.scrollHeight;
 }


        async function sendMessage() {
            const message = userInput.value.trim();
 if (!message) return;

            sendButton.disabled = true;
            userInput.disabled = true;
            actionMenuButton.disabled = true;
            loadingSpinner.style.display = 'block';
 appendMessage("user", { type: 'text', text: message });

            // ğŸš¨ ìˆ˜ì •: ì…ë ¥ì°½ ìë™ ì§€ìš°ê¸° (ì‚¬ìš©ìë‹˜ì´ ì„±ê³µí–ˆë‹¤ê³  ì•Œë ¤ì£¼ì…¨ìœ¼ë¯€ë¡œ ì´ ì½”ë“œëŠ” ìœ ì§€) ğŸš¨
            userInput.value = '';
 conversationHistory.push({
                role: "user",
                messageData: { type: 'text', text: message }
            });
 try {
                const textOnlyContentsForApi = conversationHistory
                    .filter(entry => entry.messageData && entry.messageData.type === 'text')
                    .map(entry => ({
                        role: entry.role,

                        parts: [{ text: entry.messageData.text }]
                    }));
 const contentsForApi = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...textOnlyContentsForApi];
 if (contentsForApi.length === 1 && contentsForApi[0].parts[0].text === SYSTEM_PROMPT) {
                     console.log("Only SYSTEM_PROMPT to send to API.");
 } else if (contentsForApi.length === 0) {
                     console.log("No content to send to API.");
 appendMessage("bot", { type: 'text', text: "(ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ë³´ë‚¼ í…ìŠ¤íŠ¸ ë‚´ìš© ì—†ìŒ)" });
                     return Promise.resolve();
 }

                const res = await fetch(
                    `/api/chat`,
                    {
                        method: "POST",

                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: contentsForApi }),
                    }
                );
 if (!res.ok) {
                    const errorData = await res.json();
 console.error("API (Backend) Error:", res.status, errorData);
                    appendMessage("bot", { type: 'text', text: `(ì˜¤ë¥˜ ë°œìƒ: ${res.status} - ${errorData.error?.error?.message || errorData.error || res.statusText})` });
 } else {
                    const data = await res.json();
 const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(ì‘ë‹µ ì—†ìŒ)";
                    appendMessage("bot", { type: 'text', text: reply });
 conversationHistory.push({
                        role: "model",
                        messageData: { type: 'text', text: reply }
                    });
 }

            } catch (error) {
                console.error("Fetch Error:", error);
 appendMessage("bot", { type: 'text', text: "(í†µì‹  ì˜¤ë¥˜ ë°œìƒ)" });
 } finally {
                sendButton.disabled = false;
 userInput.disabled = false;
                actionMenuButton.disabled = false;
                loadingSpinner.style.display = 'none';
                userInput.focus();
 }
        }

        async function sendImageMessage() {
            const imageUrl = prompt("ë³´ë‚¼ ì´ë¯¸ì§€ì˜ ì›¹ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
 if (imageUrl !== null && imageUrl.trim() !== '') {
                 sendButton.disabled = true;
 userInput.disabled = true;
                 actionMenuButton.disabled = true;

                 appendMessage("user", { type: 'image', url: imageUrl.trim() });
 conversationHistory.push({
                     role: "user",
                     messageData: { type: 'image', url: imageUrl.trim() }
                 });
 sendButton.disabled = false;
                 userInput.disabled = false;
                 actionMenuButton.disabled = false;
                 userInput.focus();
 } else if (imageUrl !== null) {
                 alert("ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
 }
        }

        function changeProfileImage(role) {
             const promptText = role === 'user' ?
 "ìƒˆ ì‚¬ìš©ì í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:" : "ìƒˆ ì´ì•ˆ í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:";
             const newUrl = prompt(promptText);
 if (newUrl !== null && newUrl.trim() !== '') {
                 if (role === 'user') {
                     userProfileImgUrl = newUrl.trim();
 } else {
                     botProfileImgUrl = newUrl.trim();
 }
                 alert(`${role === 'user' ? 'ì‚¬ìš©ì' : 'ì´ì•ˆ'} ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œë¶€í„° ì¶”ê°€ë˜ëŠ” ë©”ì‹œì§€ì— ì ìš©ë©ë‹ˆë‹¤.`);
 } else if (newUrl !== null) {
                  alert("ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
 }
        }

        async function sendSituationRequest() {
             alert("ìƒí™© ìƒì„± ê¸°ëŠ¥ êµ¬í˜„ ì‹œì‘!");
 sendButton.disabled = true;
             userInput.disabled = true;
             actionMenuButton.disabled = true;
             loadingSpinner.style.display = 'block';
             // ğŸš¨ ìƒí™© ìƒì„± ìš”ì²­ í”„ë¡¬í”„íŠ¸ì—ë„ í¬ë§· ì§€ì¹¨ ì¶”ê°€ ğŸš¨
             const situationPromptText = `ê¸°ì¡´ ëŒ€í™” ë§¥ë½ê³¼ ì´ì•ˆì˜ ìºë¦­í„° ì„¤ì •ì— ê¸°ë°˜í•˜ì—¬, í¥ë¯¸ë¡­ê³  ìƒˆë¡œìš´ ìƒí™©ê³¼ ì‚¬ê±´ì„ ì´ì•ˆ ìºë¦­í„°ì˜ ì‹œì ì—ì„œ ì†Œì„¤ í˜•ì‹ìœ¼ë¡œ ë¬˜ì‚¬í•˜ë“¯ í•˜ë‚˜ ë§Œë“¤ì–´ì¤˜.
 ì‚¬ìš©ìê°€ ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì‘í•  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ì œì‹œí•´ì•¼ í•´. ëŒ€í™”ì˜ ë‹¤ìŒ íë¦„ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ë§Œë“¤ì–´ë´.
 **ì¤‘ìš”: ìƒì„±ëœ ìƒí™© ë¬˜ì‚¬ í›„ì—ëŠ” ë°˜ë“œì‹œ ì´ì•ˆ ìºë¦­í„°ë¡œ ëŒì•„ê°€ ì‚¬ìš©ìì—ê²Œ ë§ì„ ê±¸ì–´ì•¼ í•´.
 ì„¤ëª…ì¡°ë‚˜ OOC ë°œì–¸ì€ ì ˆëŒ€ ê¸ˆì§€í•˜ê³ , ëª¨ë“  ìƒí™© ë¬˜ì‚¬ëŠ” *ë³„í‘œ* í˜•ì‹ìœ¼ë¡œ, ëŒ€ì‚¬ëŠ” "ë”°ì˜´í‘œ" í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë©°, ë¬˜ì‚¬ 70% ëŒ€ì‚¬ 30% ì •ë„ì˜ ë¹„ìœ¨ì„ ìœ ì§€í•˜ê³  ë¬¸ë‹¨ê³¼ ì¤„ë°”ê¿ˆì„ ì ì ˆíˆ ì‚¬ìš©í•´.**`;
 const textOnlyContentsForApi = conversationHistory
                 .filter(entry => entry.messageData && entry.messageData.type === 'text')
                 .map(entry => ({
                    role: entry.role,
                    parts: [{ text: entry.messageData.text }]

        }));

             const contentsForApi = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...textOnlyContentsForApi, { role: "user", parts: [{ text: situationPromptText }] }];
 if (contentsForApi.length <= 1 && contentsForApi[0].parts[0].text === SYSTEM_PROMPT) {
                 console.log("Only SYSTEM_PROMPT or SYSTEM_PROMPT + Situation Prompt to send to API.");
 } else if (contentsForApi.length === 0) {
                 console.log("No content to send to API.");
 appendMessage("bot", { type: 'text', text: "(ìƒí™© ìƒì„± ìš”ì²­ ì‹¤íŒ¨: ë³´ë‚¼ í…ìŠ¤íŠ¸ ë‚´ìš© ì—†ìŒ)" });
                 return Promise.resolve();
 }


            try {
                const res = await fetch(
                    `/api/chat`,
                    {
                        method: "POST",

                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: contentsForApi }),
                    }
                );
 if (!res.ok) {
                    const errorData = await res.json();
 console.error("API (Backend) Error:", res.status, errorData);
                    appendMessage("bot", { type: 'text', text: `(ì˜¤ë¥˜ ë°œìƒ: ${res.status} - ${errorData.error?.error?.message || errorData.error || res.statusText})` });
 } else {
                    const data = await res.json();
 const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(ì‘ë‹µ ì—†ìŒ)";
                    appendMessage("bot", { type: 'text', text: reply });
 conversationHistory.push({
                        role: "model",
                        messageData: { type: 'text', text: reply }
                    });
 }

            } catch (error) {
                console.error("Fetch Error:", error);
 appendMessage("bot", { type: 'text', text: "(í†µì‹  ì˜¤ë¥˜ ë°œìƒ)" });
 } finally {
                sendButton.disabled = false;
 userInput.disabled = false;
                actionMenuButton.disabled = false;
                loadingSpinner.style.display = 'none';
                userInput.focus();
 }
        }


        function loadSettings() {
            console.log("loadSettings í˜¸ì¶œë¨");
 const savedBotName = localStorage.getItem('botName') || 'ì´ì•ˆ';
             const savedUserName = localStorage.getItem('userName') || 'í”¼ì£¼ë¨¸ë‹ˆ';
             const savedBotPersona = localStorage.getItem('botPersona') || 'ì„¤ì •ëœ í˜ë¥´ì†Œë‚˜ ì—†ìŒ.';
 const savedBotAge = localStorage.getItem('botAge') || 'ë¶ˆëª…';
             const savedUserAge = localStorage.getItem('userAge') || 'ë¶ˆëª…';
             const savedUserAppearance = localStorage.getItem('userAppearance') || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
 const savedBotAppearance = localStorage.getItem('botAppearance') || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
             const savedUserGuidelines = localStorage.getItem('userGuidelines') || 'ì„¤ì •ëœ ì‚¬ìš©ì ì§€ì¹¨ ì—†ìŒ.';
 userProfileImgUrl = localStorage.getItem('userProfileImgUrl') ||
 "https://via.placeholder.com/35/4a3a7a/ffffff?text=YOU";
             botProfileImgUrl = localStorage.getItem('botProfileImgUrl') || "https://via.placeholder.com/35/3a4a3a/ffffff?text=BOT";


            botNameInput.value = savedBotName;
            userNameInput.value = savedUserName;
            botPersonaInput.value = savedBotPersona;
            botAgeInput.value = savedBotAge;
 userAgeInput.value = savedUserAge;
            userAppearanceInput.value = savedUserAppearance;
            botAppearanceInput.value = savedBotAppearance;
            userGuidelinesInput.value = savedUserGuidelines;
 SYSTEM_PROMPT = buildSystemPrompt(
                 savedBotName,
                 savedUserName,
                 savedBotPersona,
                 savedBotAge,
                 savedBotAppearance,

                 savedUserAge,
                 savedUserAppearance,
                 savedUserGuidelines
             );
 console.log("SYSTEM_PROMPT ë¡œë“œ ì™„ë£Œ:", SYSTEM_PROMPT);
        }

        function saveSettings() {
             console.log("saveSettings í˜¸ì¶œë¨");
 const currentBotName = botNameInput.value.trim();
             const currentUserName = userNameInput.value.trim();
             const currentBotPersona = botPersonaInput.value.trim();
             const currentBotAge = botAgeInput.value.trim();
             const currentUserAge = userAgeInput.value.trim();
 const currentUserAppearance = userAppearanceInput.value.trim();
             const currentBotAppearance = botAppearanceInput.value.trim();
             const currentUserGuidelines = userGuidelinesInput.value.trim();

            localStorage.setItem('botName', currentBotName);
            localStorage.setItem('userName', currentUserName);
            localStorage.setItem('botPersona', currentBotPersona);
            localStorage.setItem('botAge', currentBotAge);
            localStorage.setItem('userAge', currentUserAge);
            localStorage.setItem('userAppearance', currentUserAppearance);
            localStorage.setItem('botAppearance', currentBotAppearance);
            localStorage.setItem('userGuidelines', currentUserGuidelines);
             localStorage.setItem('userProfileImgUrl', userProfileImgUrl);
             localStorage.setItem('botProfileImgUrl', botProfileImgUrl);
 SYSTEM_PROMPT = buildSystemPrompt(
                 currentBotName,
                 currentUserName,
                 currentBotPersona,
                 currentBotAge,
                 currentBotAppearance,

                 currentUserAge,
                 currentUserAppearance,
                 currentUserGuidelines
             );
 console.log("ì„¤ì • ì €ì¥ ì™„ë£Œ ë° SYSTEM_PROMPT ì—…ë°ì´íŠ¸:", SYSTEM_PROMPT);

            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

         function buildSystemPrompt(botName, userName, botPersona, botAge, botAppearance, userAge, userAppearance, userGuidelines) {
             let finalPrompt = SYSTEM_PROMPT_TEMPLATE
                 .replace('{botName}', botName || 'ì´ì•ˆ')
                 .replace('{botAge}', botAge || 'ë¶ˆëª…')

                 .replace('{botAppearance}', botAppearance || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ')
                 .replace('{botPersona}', botPersona || 'ì„¤ì •ëœ í˜ë¥´ì†Œë‚˜ ì—†ìŒ.')
                 .replace('{userName}', userName || 'í”¼ì£¼ë¨¸ë‹ˆ')
                 .replace('{userAge}', userAge || 'ë¶ˆëª…')
                 .replace('{userAppearance}', userAppearance || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ')

                 .replace('{userGuidelines}', userGuidelines || 'ì„¤ì •ëœ ì‚¬ìš©ì ì§€ì¹¨ ì—†ìŒ.');

             return finalPrompt.trim();
         }

        function initializeChat() {
             console.log("initializeChat í˜¸ì¶œë¨");
             loadSettings();

             conversationHistory = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }];

             console.log("ì´ˆê¸° SYSTEM_PROMPT:", SYSTEM_PROMPT);

             console.log("ì´ˆê¸° ë©”ì‹œì§€ ì¶”ê°€ ì‹œë„");
             const initialBotGreeting = `...${botNameInput.value || "ì´ì•ˆ"}ì˜ ${userNameInput.value || "í”¼ì£¼ë¨¸ë‹ˆ"}... ê·¸ë˜, ì´ê³³ì— ì™”êµ°ìš”...`;
             appendMessage("bot", { type: 'text', text: initialBotGreeting });

             console.log("ì±„íŒ… ì´ˆê¸°í™” ì™„ë£Œ.");
         }

        initializeChat();

    </script>
</body>
</html>
