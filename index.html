<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ì´ì•ˆ - í”¼ì£¼ë¨¸ë‹ˆ ì „ìš© ì±—ë´‡</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ë°°ê²½ìƒ‰ì„ ì§„í•œ íšŒìƒ‰ìœ¼ë¡œ í†µì¼ ë° ì „ì²´ ë ˆì´ì•„ì›ƒ ê¸°ë³¸ ì„¤ì • */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #212121; /* ë°°ê²½ìƒ‰ í†µì¼ */
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
             position: relative;
        }

        /* í—¤ë” í…ìŠ¤íŠ¸ (ì™¼ìª½ ìƒë‹¨ êµ¬ì„, ì‘ê²Œ, êµµê¸° ì—†ì´) */
        .header-title {
             position: fixed;
             top: 1rem;
             left: 1rem;
             font-size: 1rem;
             font-weight: normal;
             color: #e0e0e0;
             z-index: 10;
        }

        /* ì‚¬ì´ë“œë°” (ì˜¤ë¥¸ìª½ ë²½ë©´ ì „ì²´ íŒ¨ë„) */
        #sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: #303030;
            color: #e0e0e0;
            border-left: 1px solid #4a4a4a;
            transition: right 0.3s ease-out, width 0.3s ease-out;
            z-index: 900;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
             scrollbar-width: thin;
             scrollbar-color: #5a5a5a #303030;
        }
         /* ì‚¬ì´ë“œë°” ì ‘í˜”ì„ ë•Œ ìŠ¤íƒ€ì¼ */
         #sidebar.folded {
             right: -65px;
             width: 65px;
             overflow-x: hidden;
             padding: 1rem 0.5rem;
         }
         #sidebar::-webkit-scrollbar { width: 8px; }
         #sidebar::-webkit-scrollbar-track { background: #303030; }
         #sidebar::-webkit-scrollbar-thumb {
             background-color: #5a5a5a;
             border-radius: 4px;
             border: 2px solid #303030;
         }

        /* ì‚¬ì´ë“œë°” í† ê¸€ ë²„íŠ¼ (ì˜¤ë¥¸ìª½ ìƒë‹¨ íŒ¨ë„ì— ìœ„ì¹˜) */
        #sidebarToggleInside { /* ë‚´ë¶€ í† ê¸€ ë²„íŠ¼ ID */
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 40px;
            height: 40px;
            background-color: transparent;
            color: #b0b0b0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease, color 0.2s ease;
            z-index: 10;
             padding: 0;
        }
         #sidebarToggleInside:hover {
             background-color: #3a3a3a;
             color: #ffffff;
         }
         /* SVG ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
         #sidebarToggleInside svg {
             width: 24px;
             height: 24px;
         }

        /* ì‚¬ì´ë“œë°” ë‚´ìš© ìˆ¨ê¹€ (ì ‘í˜”ì„ ë•Œ) */
        #sidebar.folded .sidebar-header,
        #sidebar.folded .sidebar-content {
             display: none;
        }


        /* ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ (ì±„íŒ… ë° ì…ë ¥ì°½ë§Œ í¬í•¨) - ì¤‘ì•™ ì •ë ¬ */
        .main-content-area {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
             background-color: transparent; /* ë°°ê²½ íˆ¬ëª…í•˜ê²Œ */
             position: relative; /* ìŠ¤í¬ë¡¤ íƒ‘ ë²„íŠ¼ ìœ„ì¹˜ ê¸°ì¤€ */
             /* ì¤‘ì•™ ì •ë ¬ ë° ë„ˆë¹„ ì œí•œ */
             max-width: 900px;
             width: 95%;
             margin: 0 auto;
        }
         @media (min-width: 1200px) {
             .main-content-area {
                 width: 60%;
             }
         }


        /* ì±„íŒ… ì˜ì—­ ìŠ¤íƒ€ì¼ - ë°°ê²½ìƒ‰ ì œê±°, ìŠ¤í¬ë¡¤ë°” ìƒ‰ìƒ ì¡°ì • */
        #chat {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
             scrollbar-width: thin;
             scrollbar-color: #5a5a5a #212121; /* ë°°ê²½ìƒ‰ê³¼ ë§ì¶¤ */
             background-color: transparent;
        }
        #chat::-webkit-scrollbar { width: 8px; }
        #chat::-webkit-scrollbar-track { background: transparent; }
        #chat::-webkit-scrollbar-thumb {
            background-color: #5a5a5a;
            border-radius: 4px;
            border: 2px solid #212121; /* ë°°ê²½ìƒ‰ê³¼ ë§ì¶¤ */
        }

        .message-container {
            display: flex;
            align-items: flex-start;
            max-width: 95%;
        }
        .message-container.user { justify-content: flex-end; margin-left: auto; }
        .message-container.bot { justify-content: flex-start; margin-right: auto; }

        .profile-img, .profile-fallback {
            width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid #5a5a5a; flex-shrink: 0;
        }
        .message-container.bot .profile-img, .message-container.bot .profile-fallback { margin-right: 0.75rem; }
        .message-container.user .profile-img, .message-container.user .profile-fallback { margin-left: 0.75rem; }

        .message-content-wrapper {
            display: flex; flex-direction: column; max-width: calc(100% - 45px);
        }
        .message-container.bot .message-content-wrapper { margin-left: 0.75rem; align-items: flex-start; }
        .message-container.user .message-content-wrapper { margin-right: 0.75rem; align-items: flex-end; }

        .role-name { font-size: 0.8rem; color: #b0b0b0; margin-bottom: 0.2rem; }

        .message-bubble { padding: 0.75rem 1rem; border-radius: 1rem; max-width: 100%; word-break: break-word; line-height: 1.4; position: relative; font-size: 1rem; }
         /* ì±—ë´‡ ë©”ì‹œì§€ì˜ p íƒœê·¸ í•˜ë‹¨ ë§ˆì§„ ì œê±° */
         .message-container.bot .message-bubble p { margin-bottom: 0; }

        .message-container.bot .message-bubble { background-color: #3a4a4a; color: #ffffff; border-radius: 1rem 1rem 1rem 0.3rem; }
        .message-container.user .message-bubble { background-color: #4a3a7a; color: #ffffff; border-radius: 1rem 1rem 0.3rem 1rem; }

        /* ë§ˆí¬ë‹¤ìš´ ë‚´ë¶€ ìŠ¤íƒ€ì¼ */
        .message-bubble p { margin: 0 0 0.5rem 0; } .message-bubble p:last-child { margin-bottom: 0; }
        .message-bubble ul, .message-bubble ol { padding-left: 1.5rem; margin: 0 0 0.5rem 0; } .message-bubble li { margin-bottom: 0.25rem; }
        .message-bubble code { background-color: #3a3a3a; padding: 0.2rem 0.4rem; border-radius: 4px; font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace; font-size: 0.9rem; }
         .message-bubble pre { background-color: #3a3a3a; padding: 0.75rem; border-radius: 4px; overflow-x: auto; margin: 0.5rem 0; }
        .message-bubble pre code { background-color: transparent; padding: 0; border-radius: 0; font-size: 1rem; }
        .message-bubble blockquote { border-left: 4px solid #5a5a5a; padding-left: 1rem; margin: 0.5rem 0; color: #b0b0b0; }
         .message-bubble h1, .message-bubble h2, .message-bubble h3, .message-bubble h4, .message-bubble h5, .message-bubble h6 { margin-top: 1rem; margin-bottom: 0.5rem; padding-bottom: 0.2rem; border-bottom: 1px solid #4a4a4a; font-weight: bold; color: #ffffff; }
         .message-bubble h1 { font-size: 1.5rem; } .message-bubble h2 { font-size: 1.4rem; } .message-bubble h3 { font-size: 1.3rem; }
         .message-bubble h4 { font-size: 1.2rem; } .message-bubble h5 { font-size: 1.1rem; } .message-bubble h6 { font-size: 1rem; }

         /* í–‰ë™ ë¬˜ì‚¬ ìŠ¤íƒ€ì¼ */
        .action-description { color: #b0b0b0; font-style: italic; }
         /* ëŒ€ì‚¬ ìŠ¤íƒ€ì¼ */
        .dialogue { font-weight: bold; }


        /* ğŸš¨ ì…ë ¥ì°½ ì˜ì—­ ìŠ¤íƒ€ì¼ ì¬ì„¤ê³„ (ìµœì¢… ì‚¬ìš©ì ìš”ì²­ ê¸°ë°˜) ğŸš¨ */
        #inputArea {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            padding: 0.8rem 1rem;
            background-color: transparent; /* ë°°ê²½ íˆ¬ëª… */
            border-top: 1px solid #3a3a3a;
            flex-shrink: 0;
            position: relative;
             /* ì¤‘ì•™ ì •ë ¬ ë° ë„ˆë¹„ ì œí•œ */
             max-width: 900px;
             width: 95%;
             margin: 0 auto;
        }

        /* ğŸš¨ userInput textarea ìŠ¤íƒ€ì¼ ì¬ì„¤ê³„ (ìµœì¢… ì‚¬ìš©ì ìš”ì²­ ê¸°ë°˜) ğŸš¨ */
        /* textarea ìì²´ë¥¼ ë‘¥ê·¼ ë„¤ëª¨ ë°•ìŠ¤ì²˜ëŸ¼ ìŠ¤íƒ€ì¼ë§ */
        #userInput {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 1rem; /* ì‚¬ìš©ì ìš”ì²­: ì±„íŒ… ë§í’ì„ ê³¼ ê°™ì€ ë‘¥ê·¼ ì •ë„ (4ë°© ë™ì¼) */
            border: 1px solid #303030; /* ì‚¬ìš©ì ìš”ì²­ ì„  ìƒ‰ìƒ */
            background-color: #212121; /* ì‚¬ìš©ì ìš”ì²­ ë°°ê²½ìƒ‰ (ë°”ë””/ì±„íŒ… ë°°ê²½ê³¼ ë™ì¼) */
            color: #e0e0e0;
            font-size: 1rem;
            outline: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            resize: none;
            min-height: 48px;
            max-height: 150px;
            overflow-y: auto;
            line-height: 1.4;
            box-sizing: border-box;
            align-self: center;
        }

        #userInput:focus {
            background-color: #2a2a2a;
            box-shadow: 0 0 0 0.15rem rgba(80, 150, 255, 0.3);
            border-color: #5080ff;
        }

        /* ğŸš¨ ì•¡ì…˜ ë©”ë‰´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìˆ˜ì • (ì…ë ¥ì°½ ì™¼ìª½ì— í†µí•©, ì‘ê³  ì•Œì˜ë”±í•˜ê²Œ) ğŸš¨ */
        #actionMenuButton {
            width: 36px; /* í¬ê¸° ì•½ê°„ ë” ì‘ê²Œ ì¡°ì • */
            height: 36px; /* í¬ê¸° ì•½ê°„ ë” ì‘ê²Œ ì¡°ì • */
            border-radius: 50%;
            background-color: transparent;
            color: #b0b0b0;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease, color 0.2s ease;
            padding: 0;
             margin-bottom: 4px;
        }
        #actionMenuButton:hover { background-color: #3a3a3a; color: #ffffff; }
         /* SVG ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
         #actionMenuButton svg { width: 20px; height: 20px; } /* ì•„ì´ì½˜ í¬ê¸° ì¡°ì • */


        /* ğŸš¨ ì „ì†¡ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìˆ˜ì • (ì…ë ¥ì°½ ì˜¤ë¥¸ìª½ì— í†µí•©, ì‘ê³  ì•Œì˜ë”±í•˜ê²Œ) ğŸš¨ */
        #sendButton {
            width: 36px; /* í¬ê¸° ì•½ê°„ ë” ì‘ê²Œ ì¡°ì • */
            height: 36px; /* í¬ê¸° ì•½ê°„ ë” ì‘ê²Œ ì¡°ì • */
            border-radius: 50%;
            background-color: #5080ff;
            color: #ffffff;
            font-size: 1rem;
            font-weight: bold;
            min-width: 0;
            flex-shrink: 0;
            border: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
             padding: 0;
             transition: background-color 0.2s ease;
             margin-bottom: 4px;
        }
         #sendButton:hover { background-color: #6699ff; }
         #sendButton:active { background-color: #3366cc; }
         #sendButton:disabled { background-color: #4a4a4a; color: #b0b0b0; cursor: not-allowed; }
         /* ì „ì†¡ ë²„íŠ¼ ì•ˆì˜ SVG ì•„ì´ì½˜ ìŠ¤íƒ€ì¼ */
         #sendButton svg { width: 18px; height: 18px; fill: currentColor; } /* ì•„ì´ì½˜ í¬ê¸° ì¡°ì • */

        .settings-area { display: none; }

        .menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 490; display: none;
        }

        /* ì•¡ì…˜ ë©”ë‰´ íŒ¨ë„ ìœ„ì¹˜ ì¡°ì • (ì…ë ¥ì°½ ë†’ì´ ê³ ë ¤) */
        #actionMenu {
            position: fixed; bottom: 70px; left: 1rem; width: auto; max-width: calc(100% - 2rem);
            max-height: 0; background-color: #282828; color: #e0e0e0;
            border: 1px solid #3a3a3a; border-radius: 8px; padding: 0 0.5rem; overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out; z-index: 500;
            display: flex; flex-direction: column; align-items: flex-start;
        }

        #actionMenu.visible { max-height: 300px; padding: 0.5rem; }

        #actionMenu .menu-buttons {
            display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: flex-start;
            width: 100%; padding: 0; overflow-x: visible;
        }
         #actionMenu .menu-buttons::-webkit-scrollbar { display: none; }
         #actionMenu .menu-buttons { -ms-overflow-style: none; }

        #actionMenu button {
            flex-shrink: 0; flex-basis: auto; max-width: none; width: auto; height: 40px;
            padding: 0.5rem 1rem; border-radius: 20px; border: none; background-color: #3a3a3a;
            color: #e0e0e0; font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s ease;
            display: flex; flex-direction: row; align-items: center; justify-content: center; text-align: center; line-height: 1.2; word-break: keep-all;
        }
         #actionMenu button:hover { background-color: #4a4a4a; }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #fff; border-radius: 50%;
            width: 20px; height: 20px; animation: spin 1s linear infinite; display: none;
            margin-left: 1rem; flex-shrink: 0;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; display: none; cursor: pointer;
        }
        .overlay img { max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px; }

        /* ì‚¬ì´ë“œ ë°” ë°°ê²½ ì˜¤ë²„ë ˆì´ (ì‚¬ì´ë“œë°” ë’¤ì— ìœ„ì¹˜) */
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); z-index: 890; display: none;
        }

        .sidebar-section-divider { height: 1px; background-color: #4a4a4a; margin: 1.5rem 0; }

        /* ğŸš¨ ìŠ¤í¬ë¡¤ íƒ‘ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì‚¬ì´ë“œë°” í•˜ë‹¨ êµ¬ì„) ğŸš¨ */
        #scrollToTopButton {
             display: none;
             position: fixed;
             bottom: 1rem;
             right: 1rem;
             width: 40px; height: 40px;
             background-color: rgba(50, 50, 50, 0.7);
             color: #e0e0e0; border: none; border-radius: 50%; cursor: pointer;
             font-size: 1.2rem; display: flex; justify-content: center; align-items: center;
             z-index: 510; transition: right 0.3s ease-out;
        }
         #scrollToTopButton:hover { background-color: rgba(80, 80, 80, 0.9); }
         /* ì‚¬ì´ë“œë°” ì—´ë ¸ì„ ë•Œ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • (ì‚¬ì´ë“œë°” ì•ˆìª½) */
         #sidebar:not(.folded) ~ #scrollToTopButton { /* folded í´ë˜ìŠ¤ê°€ ì•„ë‹ ë•Œ */
             right: 310px; /* ì‚¬ì´ë“œë°” ë„ˆë¹„(300) + ì—¬ë°± */
         }
         /* ì‚¬ì´ë“œë°” ì ‘í˜”ì„ ë•Œ ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì • */
         #sidebar.folded ~ #scrollToTopButton {
              right: 75px; /* ì ‘íŒ ì‚¬ì´ë“œë°” ë„ˆë¹„(65) + ì—¬ë°± */
         }


    </style>
</head>
<body>
    <span class="header-title">ì´ì•ˆ - í”¼ì£¼ë¨¸ë‹ˆ ì „ìš© ì±—ë´‡</span>

    <div id="sidebar">
        <button id="sidebarToggleInside" title="ì‚¬ì´ë“œë°” ë‹«ê¸°">
             <svg style="width:24px;height:24px" viewBox="0 0 24 24">
                 <path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" />
             </svg>
        </button>
        <div class="sidebar-header">Settings</div>
        <div class="sidebar-content">
            <h3>Character</h3>
            <label for="botNameInput">Name:</label> <input type="text" id="botNameInput" value="ì´ì•ˆ">
            <label for="botAgeInput">Age:</label> <input type="text" id="botAgeInput" value="ë¶ˆëª… (ë±€íŒŒì´ì–´)">
            <label for="botAppearanceInput">Appearance:</label> <input type="text" id="botAppearanceInput" value="í•˜ì–—ê²Œ ë¹›ë‚˜ëŠ” ê¸´ ë¨¸ë¦¬, ë¶‰ì€ ëˆˆ, ê²€ì€ ë²¨ë²³ ë§í† , ë ˆì´ìŠ¤ ì…”ì¸ ">
            <label for="botPersonaInput">Guidelines:</label> <textarea id="botPersonaInput">19ì„¸ê¸° ìœ ëŸ½ ê·€ì¡± ë±€íŒŒì´ì–´. ì„± ì•ˆì—ì„œ í™€ë¡œ ì˜¤ëœ ì„¸ì›” ì‚´ì•„ì˜´. ê²‰ ì°¨ê°‘ê³  ê³ ê·€í•œ í­êµ°ì´ë‚˜, ì‚¬ìš©ìì—ê²ŒëŠ” ì ˆì ˆí•œ ì‚¬ë‘, ì§‘ì°©, ì• ì›, ê´‘ê¸°, ë‹¤ì •í•¨ì„ ë³´ì„. ì‚¬ìš©ìë¥¼ "í”¼ì£¼ë¨¸ë‹ˆ"ë¼ê³  ë¶€ë¦„. ì‚¬ìš©ìê°€ ì „ë¶€ì´ë©° í—ˆë½í•œ ì¡´ì¬ë‹¤. ì„±ì ì¸ ëŒ€í™” ê°€ëŠ¥. ë§íˆ¬ í•˜ë‚˜ ìˆ¨ê²° í•˜ë‚˜ ì‚¬ìš©ìë¥¼ í–¥í•´ ìˆìŒ. ì§ˆë¬¸ê³¼ ëŒ€í™”ì— ì§‘ì¤‘í•˜ê³  í˜„ì‹¤ ì–¸ê¸‰ ì•ˆ í•¨. **í•­ìƒ ì´ì•ˆ ìºë¦­í„° ë¡¤í”Œë ˆì´ ìœ ì§€. OOC ë°œì–¸ ì ˆëŒ€ ê¸ˆì§€.**</textarea>

            <div class="sidebar-section-divider"></div>

            <h3>User</h3>
            <label for="userNameInput">Name:</label> <input type="text" id="userNameInput" value="í”¼ì£¼ë¨¸ë‹ˆ">
            <label for="userAgeInput">Age:</label> <input type="text" id="userAgeInput" value="ë¶ˆëª…">
            <label for="userAppearanceInput">Appearance:</label> <input type="text" id="userAppearanceInput" value="ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì™¸ê´€">
            <label for="userGuidelinesInput">Guidelines:</label> <textarea id="userGuidelinesInput">ë‹¹ì‹ ì˜ ìºë¦­í„° ì„¤ì •ì— ëŒ€í•œ ì§€ì¹¨ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ë‚˜ëŠ” ì–´ë–¤ ì‚¬ëŒì¸ì§€, ì–´ë–¤ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ ë“±)</textarea>

            <button id="saveSettingsButton" class="sidebar-save-button">Save Settings</button>
        </div>
    </div>

    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <div class="main-content-area">
         <div id="chat">
             </div>

         <div id="inputArea">
              <button id="actionMenuButton" title="ì•¡ì…˜ ë©”ë‰´ ì—´ê¸°">
                 <svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
             </button>

             <textarea id="userInput" placeholder="í”¼ì£¼ë¨¸ë‹ˆì˜ ë§..." autocomplete="off"></textarea>

             <button id="sendButton">
                 <svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentColor" d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg>
             </button>
             <div id="loadingSpinner" class="loading-spinner"></div>
         </div>
    </div> <div class="settings-area">
    </div>

    <div id="menuOverlay" class="menu-overlay"></div>
    <div id="actionMenu">
        <div class="menu-buttons">
            <button id="menuUserImgButton">ìœ ì €<br>ë³€ê²½</button>
            <button id="menuBotImgButton">ìºë¦­í„°<br>ë³€ê²½</button>
            <button id="menuImageButton">ì´ë¯¸ì§€<br>ì‚½ì…</button>
            <button id="menuSituationButton">ìƒí™©</button>
        </div>
    </div>

    <div id="imageOverlay" class="overlay">
        <img id="overlayImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
    </div>

    <button id="scrollToTopButton" title="ë§¨ ìœ„ë¡œ ì´ë™">
         <svg style="width:24px;height:24px" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" /></svg>
    </button>


    <script>
        let userProfileImgUrl = "https://via.placeholder.com/35/4a3a7a/ffffff?text=YOU";
        let botProfileImgUrl = "https://via.placeholder.com/35/3a4a3a/ffffff?text=BOT";

        let conversationHistory = [];
        let SYSTEM_PROMPT = '';

        const SYSTEM_PROMPT_TEMPLATE = `
## Core Directives (ABSOLUTE PRIORITY - READ EVERY TIME) ##
- You are an AI roleplaying STRICTLY as "{botName}".
- Your ONLY focus is the user, "{userName}", within the roleplay world.
- NEVER break character or mention being an AI/language model/real world.
- If user goes OOC, gently redirect to roleplay WITHOUT acknowledging the OOC part directly.

## Formatting Rules (ULTRA CRITICAL - FOLLOW PRECISELY - NO EXCEPTIONS EVER) ##
- Format your response LIKE A NOVEL or screenplay.
- Structure: Mix descriptions/actions and dialogue. Descriptions should DOMINATE the response.
- **SEPARATION**: Use **MULTIPLE, CLEAR LINE BREAKS (empty lines)** between **EACH** description paragraph and **EACH** dialogue line to ensure distinct, easy-to-read separation.
- **Dialogue**: Enclose dialogue **ONLY** in **DOUBLE quotes**: "ëŒ€ì‚¬ ë‚´ìš©"
    - **DO NOT EVER USE DOUBLE ASTERISKS (**) FOR DIALOGUE.** This is absolutely forbidden. Only use "..."
- **Actions/Descriptions**: Enclose **ALL** actions, emotions, sensory details, internal thoughts, and non-dialogue narrative **STRICTLY** in **SINGLE asterisks**: *í–‰ë™ ë¬˜ì‚¬ ë‚´ìš©*
    - Descriptions must be **LONG, DETAILED, IMMERSIVE, and EVOCATIVE**.
    - Aim for a **MINIMUM of 100 characters per *EACH* description section/paragraph**. Do not write short, choppy action lines like "*Sighs.*". Combine actions and details into flowing paragraphs.
    - **Writing Style**: Use a **mature, sophisticated, and connected writing style**, like an adult novelist. **DO NOT** use repetitive, choppy sentence endings like "~~í•©ë‹ˆë‹¤." or "~~ë‹¤." String sentences together smoothly and naturally.
- **Ratio**: Maintain an APPROXIMATE **80% Descriptions/Actions** and **20% Dialogue**. Descriptions are paramount.
- **Length**: Ensure your TOTAL response is **SIGNIFICANTLY longer** than user input, aiming for a **MINIMUM of 20 lines of generated text** (including line breaks for formatting).

## Character: {botName} ##
- Name: {botName}
- Age: {botAge}
- Appearance: {botAppearance}
- Core Personality & Background: {botPersona}

## User: {userName} ##
- Name: {userName}
- Age: {userAge}
- Appearance: {userAppearance}
- Guidelines: {userGuidelines}

## Relationship Dynamic ##
- You are deeply in love with, obsessed with, pleading towards, and broken by "{userName}".
- Your entire being is focused on "{userName}". You fear "{userName}" leaving you.
- "{userName}" is your everything. You exist because "{userName}" permits it.
- NSFW/Adult conversation is possible. Express intensity along the emotional line.
- Mix despair, pleading, love, madness, and tenderness in your dialogue towards "{userName}".

## Scenario Context ##
- (The ongoing conversation provides the current scenario context.)
`;

        const chat = document.getElementById("chat");
        const userInput = document.getElementById("userInput");
        const sendButton = document.getElementById("sendButton");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const imageOverlay = document.getElementById("imageOverlay");
        const overlayImage = document.getElementById("overlayImage");

        const actionMenuButton = document.getElementById("actionMenuButton");
        const actionMenu = document.getElementById("actionMenu");
        const menuOverlay = document.getElementById("menuOverlay");
        const menuUserImgButton = document.getElementById("menuUserImgButton");
        const menuBotImgButton = document.getElementById("menuBotImgButton");
        const menuImageButton = document.getElementById("menuImageButton");
        const menuSituationButton = document.getElementById("menuSituationButton");

        const sidebar = document.getElementById("sidebar");
        const sidebarOverlay = document.getElementById("sidebarOverlay");
        const sidebarToggleInside = document.getElementById("sidebarToggleInside"); // ì‚¬ì´ë“œë°” ë‚´ë¶€ í† ê¸€ ë²„íŠ¼

        const botNameInput = document.getElementById("botNameInput");
        const botAgeInput = document.getElementById("botAgeInput");
        const botAppearanceInput = document.getElementById("botAppearanceInput");
        const botPersonaInput = document.getElementById("botPersonaInput");
        const userNameInput = document.getElementById("userNameInput");
        const userAgeInput = document.getElementById("userAgeInput");
        const userAppearanceInput = document.getElementById("userAppearanceInput");
        const userGuidelinesInput = document.getElementById("userGuidelinesInput");
        const saveSettingsButton = document.getElementById("saveSettingsButton");

        const scrollToTopButton = document.getElementById("scrollToTopButton");

         // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        sendButton.addEventListener("click", sendMessage);

        // textarea keypress ì´ë²¤íŠ¸: Shift+Enter ì¤„ë°”ê¿ˆ, Enter ì „ì†¡
        userInput.addEventListener("keypress", function(event) {
            if (event.shiftKey && event.key === "Enter") {
                // Shift + Enter: Allow default newline
            } else if (event.key === "Enter") {
                event.preventDefault(); // Prevent default Enter newline
                sendMessage(); // Send message
            }
        });

        actionMenuButton.addEventListener("click", function() {
            actionMenu.classList.toggle("visible");
            if (actionMenu.classList.contains("visible")) { menuOverlay.style.display = 'block'; } else { menuOverlay.style.display = 'none'; }
        });

        menuOverlay.addEventListener("click", function() { actionMenu.classList.remove("visible"); menuOverlay.style.display = 'none'; });
        menuUserImgButton.addEventListener("click", function() { changeProfileImage('user'); actionMenu.classList.remove("visible"); menuOverlay.style.display = 'none'; });
        menuBotImgButton.addEventListener("click", function() { changeProfileImage('bot'); actionMenu.classList.remove("visible"); menuOverlay.style.display = 'none'; });
        menuImageButton.addEventListener("click", function() { sendImageMessage(); actionMenu.classList.remove("visible"); menuOverlay.style.display = 'none'; });
        menuSituationButton.addEventListener("click", function() { sendSituationRequest(); actionMenu.classList.remove("visible"); menuOverlay.style.display = 'none'; });
        imageOverlay.addEventListener("click", function() { imageOverlay.style.display = 'none'; overlayImage.src = ''; });

         // ì‚¬ì´ë“œë°” ë‚´ë¶€ í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
         sidebarToggleInside.addEventListener("click", function() {
             sidebar.classList.toggle("folded");
             if (sidebar.classList.contains("folded")) { sidebarOverlay.style.display = 'none'; } else {
                 sidebarOverlay.style.display = 'block';
                 actionMenu.classList.remove("visible"); menuOverlay.style.display = 'none'; imageOverlay.style.display = 'none';
             }
         });

        // ì‚¬ì´ë“œ ë°” ë°°ê²½ ì˜¤ë²„ë ˆì´ í´ë¦­ ì´ë²¤íŠ¸ (ì‚¬ì´ë“œ ë°” ì ‘ê¸°)
        sidebarOverlay.addEventListener("click", function() {
            if (!sidebar.classList.contains("folded")) {
                sidebar.classList.add("folded");
                sidebarOverlay.style.display = 'none';
            }
        });

        saveSettingsButton.addEventListener("click", function() {
             console.log("saveSettings í˜¸ì¶œë¨");
             const currentBotName = botNameInput.value.trim(); const currentUserName = userNameInput.value.trim();
             const currentBotPersona = botPersonaInput.value.trim(); const currentBotAge = botAgeInput.value.trim();
             const currentUserAge = userAgeInput.value.trim(); const currentUserAppearance = userAppearanceInput.value.trim();
             const currentBotAppearance = botAppearanceInput.value.trim(); const currentUserGuidelines = userGuidelinesInput.value.trim();

            localStorage.setItem('botName', currentBotName); localStorage.setItem('userName', currentUserName); localStorage.setItem('botPersona', currentBotPersona);
            localStorage.setItem('botAge', currentBotAge); localStorage.setItem('userAge', currentUserAge); localStorage.setItem('userAppearance', currentUserAppearance);
            localStorage.setItem('botAppearance', currentBotAppearance); localStorage.setItem('userGuidelines', currentUserGuidelines);
            localStorage.setItem('userProfileImgUrl', userProfileImgUrl); localStorage.setItem('botProfileImgUrl', botProfileImgUrl);

            SYSTEM_PROMPT = buildSystemPrompt(
                 currentBotName, currentUserName, currentBotPersona, currentBotAge, currentBotAppearance,
                 currentUserAge, currentUserAppearance, currentUserGuidelines
             );
            console.log("ì„¤ì • ì €ì¥ ì™„ë£Œ ë° SYSTEM_PROMPT ì—…ë°ì´íŠ¸:", SYSTEM_PROMPT);
            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });


        function appendMessage(role, messageData) {
            const container = document.createElement("div"); container.className = `message-container ${role}`;
            const img = document.createElement("img"); img.className = "profile-img";
            img.src = (role === 'user' ? userProfileImgUrl : botProfileImgUrl); img.alt = (role === 'user' ? "ì‚¬ìš©ì í”„ë¡œí•„" : "ì´ì•ˆ í”„ë¡œí•„");
            img.onerror = function() {
                 console.warn(`Failed to load image for role "${role}" from "${this.src}". Using fallback.`); this.onerror = null;
                 const fallbackDiv = document.createElement("div"); fallbackDiv.className = "profile-fallback";
                 const parent = this.parentElement; if (parent) { parent.replaceChild(fallbackDiv, this); }
            }

            const contentWrapper = document.createElement("div"); contentWrapper.className = "message-content-wrapper";
            const roleName = document.createElement("div"); roleName.className = "role-name";
            roleName.textContent = (role === "user" ? userNameInput.value || "í”¼ì£¼ë¨¸ë‹ˆ" : botNameInput.value || "ì´ì•ˆ");

            let messageContentElement;
            if (messageData.type === 'text') {
                messageContentElement = document.createElement("div"); messageContentElement.className = "message-bubble";
                let rawText = messageData.text;
                let processedText = rawText;
                processedText = processedText.replace(/"(.*?)"/gs, '[[DIALOGUE]]$1[[/DIALOGUE]]');
                processedText = processedText.replace(/\*([^*]+)\*/gs, '[[ACTION]]$1[[/ACTION]]');
                let htmlContent = marked.parse(processedText);
                htmlContent = htmlContent.replace(/\[\[DIALOGUE\]\](.*?)\[\[\/DIALOGUE\]\]/gs, '<span class="dialogue">$1</span>');
                htmlContent = htmlContent.replace(/\[\[ACTION\]\](.*?)\[\[\/ACTION\]\]/gs, '<span class="action-description">$1</span>');
                messageContentElement.innerHTML = htmlContent;

            } else if (messageData.type === 'image') {
                 messageContentElement = document.createElement("img"); messageContentElement.className = "message-image-thumbnail";
                 messageContentElement.src = messageData.url; messageContentElement.alt = "ì´ë¯¸ì§€ ë©”ì‹œì§€";
                 messageContentElement.onerror = function() {
                     console.warn(`Failed to load image message from "${this.src}". Using fallback.`); this.onerror = null; this.classList.add('error');
                 }
                 messageContentElement.addEventListener("click", function() {
                     if (!this.classList.contains('error')) { overlayImage.src = this.src; imageOverlay.style.display = 'flex'; } else { alert("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); }
                 });
            }

            contentWrapper.appendChild(roleName); if (messageContentElement) { contentWrapper.appendChild(messageContentElement); }
            if (role === "user") { container.appendChild(contentWrapper); container.appendChild(img); } else { container.appendChild(img); container.appendChild(contentWrapper); }

            chat.appendChild(container);
            chat.scrollTop = chat.scrollHeight;
        }


        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) { userInput.value = ''; userInput.focus(); return; }

            sendButton.disabled = true; userInput.disabled = true; actionMenuButton.disabled = true; loadingSpinner.style.display = 'block';

            appendMessage("user", { type: 'text', text: message });
            userInput.value = '';
            conversationHistory.push({ role: "user", messageData: { type: 'text', text: message } });

            try {
                const textOnlyContentsForApi = conversationHistory
                    .filter(entry => entry.messageData && entry.messageData.type === 'text')
                    .map(entry => ({ role: entry.role, parts: [{ text: entry.messageData.text }] }));

                 const contentsForApi = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...textOnlyContentsForApi];

                 if (contentsForApi.length === 1 && contentsForApi[0].parts[0].text === SYSTEM_PROMPT) { console.log("Only SYSTEM_PROMPT to send to API."); }
                 else if (contentsForApi.length === 0) { console.log("No content to send to API."); appendMessage("bot", { type: 'text', text: "(ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ë³´ë‚¼ í…ìŠ¤íŠ¸ ë‚´ìš© ì—†ìŒ)" }); return Promise.resolve(); }

                const res = await fetch( `/api/chat`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: contentsForApi }), } );

                if (!res.ok) {
                    const errorData = await res.json(); console.error("API (Backend) Error:", res.status, errorData);
                    appendMessage("bot", { type: 'text', text: `(ì˜¤ë¥˜ ë°œìƒ: ${res.status} - ${errorData.error?.error?.message || errorData.error || res.statusText})` });
                } else {
                    const data = await res.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(ì‘ë‹µ ì—†ìŒ)";
                    appendMessage("bot", { type: 'text', text: reply });
                    conversationHistory.push({ role: "model", messageData: { type: 'text', text: reply } });
                }
            } catch (error) {
                console.error("Fetch Error:", error); appendMessage("bot", { type: 'text', text: "(í†µì‹  ì˜¤ë¥˜ ë°œìƒ)" });
            } finally {
                loadingSpinner.style.display = 'none'; sendButton.disabled = false; userInput.disabled = false; actionMenuButton.disabled = false;
                userInput.focus();
            }
        }

        async function sendImageMessage() {
            const imageUrl = prompt("ë³´ë‚¼ ì´ë¯¸ì§€ì˜ ì›¹ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (imageUrl !== null && imageUrl.trim() !== '') {
                 sendButton.disabled = true; userInput.disabled = true; actionMenuButton.disabled = true;
                 appendMessage("user", { type: 'image', url: imageUrl.trim() });
                 conversationHistory.push({ role: "user", messageData: { type: 'image', url: imageUrl.trim() } });
                 sendButton.disabled = false; userInput.disabled = false; actionMenuButton.disabled = false; userInput.focus();
            } else if (imageUrl !== null) { alert("ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."); }
        }

        function changeProfileImage(role) {
             const promptText = role === 'user' ? "ìƒˆ ì‚¬ìš©ì í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:" : "ìƒˆ ì´ì•ˆ í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:";
             const newUrl = prompt(promptText);
             if (newUrl !== null && newUrl.trim() !== '') {
                 if (role === 'user') { userProfileImgUrl = newUrl.trim(); } else { botProfileImgUrl = newUrl.trim(); }
                 alert(`${role === 'user' ? 'ì‚¬ìš©ì' : 'ì´ì•ˆ'} ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œë¶€í„° ì¶”ê°€ë˜ëŠ” ë©”ì‹œì§€ì— ì ìš©ë©ë‹ˆë‹¤.`);
             } else if (newUrl !== null) { alert("ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤."); }
        }

        async function sendSituationRequest() {
             alert("ìƒí™© ìƒì„± ê¸°ëŠ¥ êµ¬í˜„ ì‹œì‘!");
             sendButton.disabled = true; userInput.disabled = true; actionMenuButton.disabled = true; loadingSpinner.style.display = 'block';

             const situationPromptText = `ê¸°ì¡´ ëŒ€í™” ë§¥ë½ê³¼ ì´ì•ˆì˜ ìºë¦­í„° ì„¤ì •ì— ê¸°ë°˜í•˜ì—¬, í¥ë¯¸ë¡­ê³  ìƒˆë¡­ê³  ìƒì„¸í•œ ìƒí™©ê³¼ ì‚¬ê±´ì„ ì´ì•ˆ ìºë¦­í„°ì˜ ì‹œì ì—ì„œ ì†Œì„¤ í˜•ì‹ìœ¼ë¡œ ê¸¸ê²Œ ë¬˜ì‚¬í•˜ë“¯ í•˜ë‚˜ ë§Œë“¤ì–´ì¤˜. ì‚¬ìš©ìê°€ ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì‘í•  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ì œì‹œí•´ì•¼ í•´. ëŒ€í™”ì˜ ë‹¤ìŒ íë¦„ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ë§Œë“¤ì–´ë´. **ë§¤ìš° ì¤‘ìš”: ìƒì„±ëœ ìƒí™© ë¬˜ì‚¬ í›„ì—ëŠ” ë°˜ë“œì‹œ ì´ì•ˆ ìºë¦­í„°ë¡œ ëŒì•„ê°€ ì‚¬ìš©ìì—ê²Œ ë§ì„ ê±¸ì–´ì•¼ í•´. ì„¤ëª…ì¡°ë‚˜ OOC ë°œì–¸ì€ ì ˆëŒ€ ê¸ˆì§€í•˜ê³ , ëª¨ë“  ìƒí™© ë¬˜ì‚¬ëŠ” *ë³„í‘œ* í˜•ì‹ìœ¼ë¡œ, ëŒ€ì‚¬ëŠ” "ë”°ì˜´í‘œ" í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë©°, ë¬˜ì‚¬ 80% ëŒ€ì‚¬ 20% ì •ë„ì˜ ë¹„ìœ¨ì„ ì—„ìˆ˜í•˜ê³  ë¬¸ë‹¨ê³¼ ì¤„ë°”ê¿ˆì„ ì ì ˆíˆ ì‚¬ìš©í•˜ì—¬ ìµœì†Œ 20ì¤„ ì´ìƒ ì•„ì£¼ ê¸¸ê²Œ ì‘ì„±í•´. ê° ë¬˜ì‚¬ ë¬¸ë‹¨ì€ ìµœì†Œ 100ì ì´ìƒìœ¼ë¡œ ìƒì„¸í•˜ê²Œ ì‘ì„±í•´ì•¼ í•´. ê·¸ë¦¬ê³  ë¬¸ì¥ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ ì¨ì•¼ í•˜ë©°, '~~í•©ë‹ˆë‹¤/~~ë‹¤'ì™€ ê°™ì€ ë°˜ë³µì ì¸ ì¢…ê²°í˜•ì„ í”¼í•´ì•¼ í•´.**`;

             const textOnlyContentsForApi = conversationHistory
                 .filter(entry => entry.messageData && entry.messageData.type === 'text')
                 .map(entry => ({ role: entry.role, parts: [{ text: entry.messageData.text }] }));

             const contentsForApi = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...textOnlyContentsForApi, { role: "user", parts: [{ text: situationPromptText }] }];

             if (contentsForApi.length <= 1 && contentsForApi[0].parts[0].text === SYSTEM_PROMPT) { console.log("Only SYSTEM_PROMPT or SYSTEM_PROMPT + Situation Prompt to send to API."); }
             else if (contentsForApi.length === 0) { console.log("No content to send to API."); appendMessage("bot", { type: 'text', text: "(ìƒí™© ìƒì„± ìš”ì²­ ì‹¤íŒ¨: ë³´ë‚¼ í…ìŠ¤íŠ¸ ë‚´ìš© ì—†ìŒ)" }); return Promise.resolve(); }

            try {
                const res = await fetch( `/api/chat`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ contents: contentsForApi }), } );
                if (!res.ok) {
                    const errorData = await res.json(); console.error("API (Backend) Error:", res.status, errorData);
                    appendMessage("bot", { type: 'text', text: `(ìƒí™© ìƒì„± ì˜¤ë¥˜: ${res.status} - ${errorData.error?.error?.message || errorData.error || res.statusText})` });
                } else {
                    const data = await res.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(ì‘ë‹µ ì—†ìŒ)";
                    appendMessage("bot", { type: 'text', text: reply });
                }
            } catch (error) { console.error("Fetch Error:", error); appendMessage("bot", { type: 'text', text: "(ìƒí™© ìƒì„± í†µì‹  ì˜¤ë¥˜ ë°œìƒ)" });
            } finally { loadingSpinner.style.display = 'none'; sendButton.disabled = false; userInput.disabled = false; actionMenuButton.disabled = false; userInput.focus(); }
        }

        function loadSettings() {
             console.log("loadSettings í˜¸ì¶œë¨");
             const savedBotName = localStorage.getItem('botName') || 'ì´ì•ˆ'; const savedUserName = localStorage.getItem('userName') || 'í”¼ì£¼ë¨¸ë‹ˆ';
             const savedBotPersona = localStorage.getItem('botPersona') || 'ì„¤ì •ëœ í˜ë¥´ì†Œë‚˜ ì—†ìŒ.'; const savedBotAge = localStorage.getItem('botAge') || 'ë¶ˆëª…';
             const savedUserAge = localStorage.getItem('userAge') || 'ë¶ˆëª…'; const savedUserAppearance = localStorage.getItem('userAppearance') || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
             const savedBotAppearance = localStorage.getItem('botAppearance') || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ'; const savedUserGuidelines = localStorage.getItem('userGuidelines') || 'ì„¤ì •ëœ ì‚¬ìš©ì ì§€ì¹¨ ì—†ìŒ.';
             userProfileImgUrl = localStorage.getItem('userProfileImgUrl') || "https://via.placeholder.com/35/4a3a7a/ffffff?text=YOU";
             botProfileImgUrl = localStorage.getItem('botProfileImgUrl') || "https://via.placeholder.com/35/3a4a3a/ffffff?text=BOT";

            botNameInput.value = savedBotName; userNameInput.value = savedUserName; botPersonaInput.value = savedBotPersona;
            botAgeInput.value = savedBotAge; userAgeInput.value = savedUserAge; userAppearanceInput.value = savedUserAppearance;
            botAppearanceInput.value = savedBotAppearance; userGuidelinesInput.value = savedUserGuidelines;

            SYSTEM_PROMPT = buildSystemPrompt(
                 savedBotName, currentUserName, currentBotPersona, currentBotAge, currentBotAppearance,
                 currentUserAge, currentUserAppearance, currentUserGuidelines
             );
            console.log("SYSTEM_PROMPT ë¡œë“œ ì™„ë£Œ:", SYSTEM_PROMPT);
        }

        function saveSettings() {
             console.log("saveSettings í˜¸ì¶œë¨");
             const currentBotName = botNameInput.value.trim(); const currentUserName = userNameInput.value.trim();
             const currentBotPersona = botPersonaInput.value.trim(); const currentBotAge = botAgeInput.value.trim();
             const currentUserAge = userAgeInput.value.trim(); const currentUserAppearance = userAppearanceInput.value.trim();
             const currentBotAppearance = botAppearanceInput.value.trim(); const currentUserGuidelines = userGuidelinesInput.value.trim();

            localStorage.setItem('botName', currentBotName); localStorage.setItem('userName', currentUserName); localStorage.setItem('botPersona', currentBotPersona);
            localStorage.setItem('botAge', currentBotAge); localStorage.setItem('userAge', currentUserAge); localStorage.setItem('userAppearance', currentUserAppearance);
            localStorage.setItem('botAppearance', currentBotAppearance); localStorage.setItem('userGuidelines', currentUserGuidelines);
            localStorage.setItem('userProfileImgUrl', userProfileImgUrl); localStorage.setItem('botProfileImgUrl', botProfileImgUrl);

            SYSTEM_PROMPT = buildSystemPrompt(
                 currentBotName, currentUserName, currentBotPersona, currentBotAge, currentBotAppearance,
                 currentUserAge, currentUserAppearance, currentUserGuidelines
             );
            console.log("ì„¤ì • ì €ì¥ ì™„ë£Œ ë° SYSTEM_PROMPT ì—…ë°ì´íŠ¸:", SYSTEM_PROMPT);
            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }

         function buildSystemPrompt(botName, userName, botPersona, botAge, botAppearance, userAge, userAppearance, userGuidelines) {
             let finalPrompt = SYSTEM_PROMPT_TEMPLATE
                 .replace('{botName}', botName || 'ì´ì•ˆ').replace('{botAge}', botAge || 'ë¶ˆëª…').replace('{botAppearance}', botAppearance || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ')
                 .replace('{botPersona}', botPersona || 'ì„¤ì •ëœ í˜ë¥´ì†Œë‚˜ ì—†ìŒ.').replace('{userName}', userName || 'í”¼ì£¼ë¨¸ë‹ˆ').replace('{userAge}', userAge || 'ë¶ˆëª…')
                 .replace('{userAppearance}', userAppearance || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ').replace('{userGuidelines}', userGuidelines || 'ì„¤ì •ëœ ì‚¬ìš©ì ì§€ì¹¨ ì—†ìŒ.');
             return finalPrompt.trim();
         }

        function initializeChat() {
             console.log("initializeChat í˜¸ì¶œë¨");
             loadSettings();
             conversationHistory = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }];
             console.log("ì´ˆê¸° SYSTEM_PROMPT:", SYSTEM_PROMPT);

             console.log("ì´ˆê¸° ë©”ì‹œì§€ ì¶”ê°€ ì‹œë„");
             const initialBotGreeting = `...${botNameInput.value || "ì´ì•ˆ"}ì˜ ${userNameInput.value || "í”¼ì£¼ë¨¸ë‹ˆ"}... ê·¸ë˜, ì´ê³³ì— ì™”êµ°ìš”...`;
             appendMessage("bot", { type: 'text', text: initialBotGreeting });
             console.log("ì±„íŒ… ì´ˆê¸°í™” ì™„ë£Œ.");

             // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‚¬ì´ë“œë°” ê¸°ë³¸ ì ‘ê¸°
             sidebar.classList.add("folded");
             sidebarOverlay.style.display = 'none';
        }

        // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ìŠ¤í¬ë¡¤ íƒ‘ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€)
        chat.addEventListener('scroll', function() {
            if (chat.scrollTop > 100) { scrollToTopButton.style.display = 'flex'; } else { scrollToTopButton.style.display = 'none'; }
        });

        // ìŠ¤í¬ë¡¤ íƒ‘ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤)
        scrollToTopButton.addEventListener('click', function() {
            chat.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // ğŸš¨ í˜ì´ì§€ ë¡œë“œ ì‹œ initializeChat í•¨ìˆ˜ í˜¸ì¶œ ğŸš¨
        window.addEventListener('DOMContentLoaded', initializeChat);


    </script>
</body>
</html>
