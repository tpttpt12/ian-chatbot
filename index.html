<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial=1.0" />
    <title>ì´ì•ˆ - í”¼ì£¼ë¨¸ë‹ˆ ì „ìš© ì±—ë´‡</title>
    <style>
        /* ê¸°ì¡´ CSS ìœ ì§€ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden; /* ì‚¬ì´ë“œë°” ìŠ¬ë¼ì´ë“œ ì‹œ ë‚´ìš© ë„˜ì¹¨ ë°©ì§€ */
        }

        /* --- í—¤ë” ìŠ¤íƒ€ì¼ ìˆ˜ì • (ì‚¬ì´ë“œ ë°” ë²„íŠ¼ ì¶”ê°€) --- */
        .chat-header {
            background-color: #282828;
            color: #ffffff;
            padding: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0; /* í—¤ë”ê°€ ì¤„ì–´ë“¤ì§€ ì•Šë„ë¡ í•¨ */
            position: relative; /* ì‚¬ì´ë“œ ë°” í† ê¸€ ë²„íŠ¼ ê¸°ì¤€ */
             display: flex; /* ìš”ì†Œ ì •ë ¬ì„ ìœ„í•´ flex ì‚¬ìš© */
             justify-content: center; /* ì¤‘ì•™ ì •ë ¬ ê¸°ë³¸ */
             align-items: center;
        }

         /* ì‚¬ì´ë“œ ë°” í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #sidebarToggle {
            position: absolute; /* í—¤ë” ë‚´ì—ì„œ ì ˆëŒ€ ìœ„ì¹˜ */
            top: 50%;
            right: 1rem; /* ì˜¤ë¥¸ìª½ì—ì„œ 1rem ê°„ê²© */
            transform: translateY(-50%); /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            width: 35px;
            height: 35px;
            background-color: #5a5a5a;
            color: #ffffff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
             z-index: 10; /* ë‹¤ë¥¸ ìš”ì†Œ ìœ„ì— í‘œì‹œ */
        }
         #sidebarToggle:hover {
             background-color: #6a6a6a;
         }

        #chat {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
             scrollbar-width: thin;
             scrollbar-color: #5a5a5a #282828;
        }

        #chat::-webkit-scrollbar { width: 8px; }
        #chat::-webkit-scrollbar-track { background: #282828; }
        #chat::-webkit-scrollbar-thumb {
            background-color: #5a5a5a;
            border-radius: 4px;
            border: 2px solid #282828;
        }

        /* --- ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ë° ë‚´ë¶€ êµ¬ì¡° (ì´ì „ê³¼ ë™ì¼) --- */
        .message-container {
            display: flex;
            align-items: flex-start;
            max-width: 95%;
        }

        .message-container.user {
            justify-content: flex-end;
            margin-left: auto;
        }

        .message-container.bot {
            justify-content: flex-start;
            margin-right: auto;
        }

        /* í”„ë¡œí•„ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
        .profile-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #5a5a5a;
            flex-shrink: 0;
        }

         /* ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´í•  íšŒìƒ‰ ë™ê·¸ë¼ë¯¸ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
        .profile-fallback {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #5a5a5a;
            border: 1px solid #5a5a5a;
            flex-shrink: 0;
        }

        /* ì´ë¯¸ì§€/ëŒ€ì²´ ìš”ì†Œì™€ ë©”ì‹œì§€ ë‚´ìš© ë˜í¼ ê°„ ê°„ê²© */
        .message-container.bot .profile-img,
        .message-container.bot .profile-fallback {
            margin-right: 0.75rem;
        }

        .message-container.user .profile-img,
        .message-container.user .profile-fallback {
            margin-left: 0.75rem;
        }

        /* ë©”ì‹œì§€ ë‚´ìš©(ì´ë¦„+ë²„ë¸”)ì„ ê°ì‹¸ëŠ” ë˜í¼ */
        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 45px);
        }

        .message-container.bot .message-content-wrapper {
            margin-left: 0.75rem;
            align-items: flex-start;
        }

        .message-container.user .message-content-wrapper {
            margin-right: 0.75rem;
            align-items: flex-end;
        }

        /* ì—­í• /ì´ë¦„ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .role-name {
            font-size: 0.8rem;
            color: #b0b0b0;
            margin-bottom: 0.2rem;
        }

        /* ë©”ì‹œì§€ ë²„ë¸” ìŠ¤íƒ€ì¼ (í…ìŠ¤íŠ¸ ë©”ì‹œì§€) */
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 100%;
            word-break: break-word;
            line-height: 1.4;
            position: relative;
        }

        .message-container.bot .message-bubble {
            background-color: #3a4a4a;
            color: #ffffff;
            border-radius: 1rem 1rem 1rem 0.3rem;
        }

        .message-container.user .message-bubble {
            background-color: #4a3a7a;
            color: #ffffff;
            border-radius: 1rem 1rem 0.3rem 1rem;
        }

        /* --- ì´ë¯¸ì§€ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ --- */
         /* ì´ë¯¸ì§€ ë©”ì‹œì§€ ì¸ë„¤ì¼ */
        .message-image-thumbnail {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            margin-top: 0.2rem;
            border: 1px solid #5a5a5a;
        }

        /* ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ */
         .message-image-thumbnail.error {
             background-color: #5a5a5a;
         }

        /* --- ì…ë ¥ì°½ ë° ë²„íŠ¼ ì˜ì—­ ìŠ¤íƒ€ì¼ ë³€ê²½ --- */
        #inputArea {
            display: flex;
            padding: 1rem;
            background-color: #282828;
            border-top: 1px solid #3a3a3a;
            align-items: center;
            gap: 0.75rem;
             flex-shrink: 0;
             position: relative;
        }

        /* + ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #actionMenuButton {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #5a5a5a;
            color: #ffffff;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        #actionMenuButton:hover {
            background-color: #6a6a6a;
        }


        #userInput {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            border: none;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 1rem;
            outline: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        #userInput:focus {
            background-color: #4a4a4a;
            box-shadow: 0 0 0 0.15rem rgba(80, 150, 255, 0.3);
        }

        /* ì „ì†¡ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
        #sendButton {
            padding: 0.75rem 1.5rem;
            border-radius: 1.5rem;
            background-color: #5080ff;
            color: #ffffff;
            font-size: 1rem;
            font-weight: bold;
            min-width: 6rem;
            flex-shrink: 0;
             border: none;
             cursor: pointer;
        }
         #sendButton:hover { background-color: #6699ff; }
         #sendButton:active { background-color: #3366cc; }
         #sendButton:disabled {
            background-color: #4a4a4a;
            color: #b0b0b0;
            cursor: not-allowed;
         }

        /* ê¸°ì¡´ í•˜ë‹¨ ì„¤ì • ì˜ì—­ ìˆ¨ê¹€ */
        .settings-area {
            display: none;
        }

        /* --- ì•¡ì…˜ ë©”ë‰´ ë°°ê²½ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) --- */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 490;
            display: none;
        }

        /* --- ì•¡ì…˜ ë©”ë‰´ íŒ¨ë„ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) --- */
        #actionMenu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
             max-height: 0;
            background-color: #282828;
            color: #e0e0e0;
            border-top: 1px solid #3a3a3a;
            padding: 0 1rem;
            overflow-y: auto;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            z-index: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #actionMenu.visible {
            max-height: 300px;
            padding: 1rem;
        }

        /* --- ë©”ë‰´ ë‚´ë¶€ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ìˆ˜ì • (í•œ ì¤„ ê°€ë¡œ ë°°ì—´ ìœ ì§€) --- */
        #actionMenu .menu-buttons {
            display: flex;
             flex-wrap: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            gap: 0.75rem;
            justify-content: center;
            width: 100%;
             /* max-width: 400px; /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • */ /* ë²„íŠ¼ ë„ˆë¹„ì— ë§ê²Œ ì¡°ì ˆ */
            padding-bottom: 1rem;
             overflow-x: auto; /* ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ */
             padding-top: 1rem; /* ìƒë‹¨ íŒ¨ë”© ì¶”ê°€ */
        }

         /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ (ì„ íƒ ì‚¬í•­) */
         #actionMenu .menu-buttons::-webkit-scrollbar { display: none; } /* Chrome, Safari, Opera */
         #actionMenu .menu-buttons { -ms-overflow-style: none; } /* IE and Edge */


        /* --- ë©”ë‰´ ë‚´ë¶€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìˆ˜ì • (ë‘¥ê·¼ ëª¨ì„œë¦¬, ê¸€ì ë°°ì—´) --- */
        #actionMenu button {
            flex-shrink: 0; /* ë²„íŠ¼ì´ ì°Œê·¸ëŸ¬ë“¤ì§€ ì•Šë„ë¡ ë°©ì§€ */
            flex-basis: auto;
            max-width: none;
             /* ë„ˆë¹„, ë†’ì´, íŒ¨ë”©, ë‘¥ê¸€ê¸° ì¡°ì • */
             width: 100px; /* ë²„íŠ¼ ë„ˆë¹„ ì¡°ì • */
             height: 60px; /* ë²„íŠ¼ ë†’ì´ (ë‘ ì¤„ ê¸€ì ê³ ë ¤) */
            padding: 0.5rem 0.5rem; /* íŒ¨ë”© ì¡°ì • */
             border-radius: 15px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ */
            border: none;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
             flex-direction: column; /* ê¸€ì ì„¸ë¡œ ë°°ì—´ ìœ ì§€ */
            align-items: center;
            justify-content: center;
            text-align: center;
             line-height: 1.2; /* ì¤„ ê°„ê²© ì¡°ì ˆ */
             word-break: keep-all; /* ë‹¨ì–´ ì¤‘ê°„ì— ì¤„ë°”ê¿ˆ ë°©ì§€ */
        }
         #actionMenu button:hover {
             background-color: #4a4a4a;
         }


        /* --- ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ --- */
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            margin-left: 1rem; /* ì „ì†¡ ë²„íŠ¼ê³¼ì˜ ê°„ê²© */
            flex-shrink: 0; /* flex itemìœ¼ë¡œ ì°Œê·¸ëŸ¬ë“¤ì§€ ì•Šê²Œ */
        }

        /* ìŠ¤í”¼ë„ˆ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
            cursor: pointer;
        }

        .overlay img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
        }

        /* --- ì‚¬ì´ë“œ ë°” ìŠ¤íƒ€ì¼ --- */
        #sidebar {
            position: fixed; /* í™”ë©´ ìš°ì¸¡ ê³ ì • */
            top: 0;
            right: -300px; /* ê¸°ë³¸ì ìœ¼ë¡œ í™”ë©´ ì˜¤ë¥¸ìª½ì— ìˆ¨ê¹€ (ë„ˆë¹„ë§Œí¼) */
            width: 300px; /* ì‚¬ì´ë“œ ë°” ë„ˆë¹„ */
            height: 100%;
            background-color: #1f1f1f; /* ë°°ê²½ìƒ‰ */
            color: #e0e0e0;
            border-left: 1px solid #3a3a3a; /* ì™¼ìª½ êµ¬ë¶„ì„  */
            transition: right 0.3s ease-out; /* ìŠ¬ë¼ì´ë“œ ì• ë‹ˆë©”ì´ì…˜ */
            z-index: 900; /* ë©”ë‰´ íŒ¨ë„ê³¼ ì˜¤ë²„ë ˆì´ ì•„ë˜, ì±„íŒ…ì°½ ìœ„ */
            padding: 1rem;
            box-sizing: border-box; /* íŒ¨ë”©ì„ ë„ˆë¹„ì— í¬í•¨ */
            overflow-y: auto; /* ë‚´ìš© ë§ìœ¼ë©´ ìŠ¤í¬ë¡¤ */
            display: flex; /* ë‚´ë¶€ ìš”ì†Œ ì„¸ë¡œ ë°°ì¹˜ */
            flex-direction: column;
            gap: 1rem; /* ë‚´ë¶€ ìš”ì†Œ ê°„ ê°„ê²© */
        }

        /* ì‚¬ì´ë“œ ë°”ê°€ ë³´ì¼ ë•Œì˜ ìŠ¤íƒ€ì¼ */
        #sidebar.visible {
            right: 0; /* í™”ë©´ ì•ˆìœ¼ë¡œ ì´ë™ */
        }

         /* ì‚¬ì´ë“œ ë°” í—¤ë” (ì˜ˆ: ì œëª© ë˜ëŠ” ë‹«ê¸° ë²„íŠ¼) */
         .sidebar-header {
             font-size: 1.1rem;
             font-weight: bold;
             margin-bottom: 1rem;
             padding-bottom: 0.5rem;
             border-bottom: 1px solid #3a3a3a;
         }

         /* ì‚¬ì´ë“œ ë°” ë‚´ìš© ì˜ì—­ */
         .sidebar-content label {
             display: block; /* ë¼ë²¨ ìœ„/ì•„ë˜ë¡œ ë¶„ë¦¬ */
             margin-bottom: 0.5rem;
             font-weight: bold;
             color: #b0b0b0;
         }

         .sidebar-content input[type="text"],
         .sidebar-content textarea {
             width: 100%;
             padding: 0.75rem;
             border: none;
             border-radius: 4px;
             background-color: #3a3a3a;
             color: #e0e0e0;
             font-size: 1rem;
             margin-bottom: 1rem;
             box-sizing: border-box; /* íŒ¨ë”©ì„ ë„ˆë¹„ì— í¬í•¨ */
             resize: vertical; /* textarea ì„¸ë¡œ í¬ê¸° ì¡°ì ˆ ê°€ëŠ¥ */
         }

         .sidebar-content textarea {
             min-height: 150px; /* ìµœì†Œ ë†’ì´ */
         }

         /* ì‚¬ì´ë“œ ë°” ì €ì¥ ë²„íŠ¼ */
         .sidebar-save-button {
             display: block; /* ë¸”ë¡ ìš”ì†Œë¡œ */
             width: 100%; /* ë„ˆë¹„ 100% */
             padding: 0.75rem;
             border: none;
             border-radius: 4px;
             background-color: #5080ff;
             color: #ffffff;
             font-size: 1rem;
             font-weight: bold;
             cursor: pointer;
             transition: background-color 0.2s ease;
             text-align: center; /* í…ìŠ¤íŠ¸ ì¤‘ì•™ ì •ë ¬ */
         }
         .sidebar-save-button:hover {
             background-color: #6699ff;
         }

        /* --- ì‚¬ì´ë“œ ë°” ë°°ê²½ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ --- */
        .sidebar-overlay {
            position: fixed; /* í™”ë©´ ì „ì²´ ê³ ì • */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* ë°˜íˆ¬ëª… ê²€ì€ ë°°ê²½ */
            z-index: 890; /* ì‚¬ì´ë“œ ë°” ì•„ë˜, ë©”ë‰´ ì˜¤ë²„ë ˆì´ ì•„ë˜, ì±„íŒ…ì°½ ìœ„ */
            display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
        }

        /* --- ì‚¬ì´ë“œ ë°” ì„¹ì…˜ êµ¬ë¶„ì„  --- */
        .sidebar-section-divider {
             height: 1px;
             background-color: #3a3a3a;
             margin: 1.5rem 0; /* êµ¬ë¶„ì„  ìœ„ì•„ë˜ ì—¬ë°± */
        }


    </style>
</head>
<body>
    <div class="chat-header">
        ì´ì•ˆ - í”¼ì£¼ë¨¸ë‹ˆ ì „ìš© ì±—ë´‡
        <button id="sidebarToggle" title="ì„¤ì • ì—´ê¸°">âš™ï¸</button>
    </div>

    <div id="chat">
        </div>

    <div id="inputArea">
        <button id="actionMenuButton" title="ì•¡ì…˜ ë©”ë‰´ ì—´ê¸°">+</button>

        <input id="userInput" placeholder="í”¼ì£¼ë¨¸ë‹ˆì˜ ë§..." autocomplete="off" />

        <button id="sendButton">ì „ì†¡</button>
        <div id="loadingSpinner" class="loading-spinner"></div>
    </div>

    <div class="settings-area">
    </div>

    <div id="menuOverlay" class="menu-overlay"></div>
    <div id="actionMenu">
        <div class="menu-buttons">
            <button id="menuUserImgButton">ìœ ì €<br>ë³€ê²½</button>
            <button id="menuBotImgButton">ìºë¦­í„°<br>ë³€ê²½</button>
            <button id="menuImageButton">ì´ë¯¸ì§€<br>ì‚½ì…</button>
            <button id="menuSituationButton">ìƒí™©</button>
        </div>
    </div>
    <div id="sidebar">
        <div class="sidebar-header">Settings</div> <div class="sidebar-content">
            <h3>Character</h3> <label for="botNameInput">Name:</label> <input type="text" id="botNameInput" value="ì´ì•ˆ">

            <label for="botAgeInput">Age:</label> <input type="text" id="botAgeInput" value="ë¶ˆëª… (ë±€íŒŒì´ì–´)">

            <label for="botAppearanceInput">Appearance:</label> <input type="text" id="botAppearanceInput" value="í•˜ì–—ê²Œ ë¹›ë‚˜ëŠ” ê¸´ ë¨¸ë¦¬, ë¶‰ì€ ëˆˆ, ê²€ì€ ë²¨ë²³ ë§í† , ë ˆì´ìŠ¤ ì…”ì¸ ">

            <label for="botPersonaInput">Guidelines:</label> <textarea id="botPersonaInput">19ì„¸ê¸° ìœ ëŸ½ ê·€ì¡± ë±€íŒŒì´ì–´. ì„± ì•ˆì—ì„œ í™€ë¡œ ì˜¤ëœ ì„¸ì›” ì‚´ì•„ì˜´. ê²‰ ì°¨ê°‘ê³  ê³ ê·€í•œ í­êµ°ì´ë‚˜, ì‚¬ìš©ìì—ê²ŒëŠ” ì ˆì ˆí•œ ì‚¬ë‘, ì§‘ì°©, ì• ì›, ê´‘ê¸°, ë‹¤ì •í•¨ì„ ë³´ì„. ì‚¬ìš©ìë¥¼ "í”¼ì£¼ë¨¸ë‹ˆ"ë¼ê³  ë¶€ë¦„. ì‚¬ìš©ìê°€ ì „ë¶€ì´ë©° í—ˆë½í•œ ì¡´ì¬. ì„±ì ì¸ ëŒ€í™” ê°€ëŠ¥. ë§íˆ¬ í•˜ë‚˜ ìˆ¨ê²° í•˜ë‚˜ ì‚¬ìš©ìë¥¼ í–¥í•´ ìˆìŒ. ì§ˆë¬¸ê³¼ ëŒ€í™”ì— ì§‘ì¤‘í•˜ê³  í˜„ì‹¤ ì–¸ê¸‰ ì•ˆ í•¨. **í•­ìƒ ì´ì•ˆ ìºë¦­í„° ë¡¤í”Œë ˆì´ ìœ ì§€. OOC ë°œì–¸ ì ˆëŒ€ ê¸ˆì§€.**</textarea>

            <div class="sidebar-section-divider"></div> <h3>User</h3> <label for="userNameInput">Name:</label> <input type="text" id="userNameInput" value="í”¼ì£¼ë¨¸ë‹ˆ">

            <label for="userAgeInput">Age:</label> <input type="text" id="userAgeInput" value="ë¶ˆëª…">

            <label for="userAppearanceInput">Appearance:</label> <input type="text" id="userAppearanceInput" value="ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì™¸ê´€">

            <label for="userGuidelinesInput">Guidelines:</label> <textarea id="userGuidelinesInput">ë‹¹ì‹ ì˜ ìºë¦­í„° ì„¤ì •ì— ëŒ€í•œ ì§€ì¹¨ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: ë‚˜ëŠ” ì–´ë–¤ ì‚¬ëŒì¸ì§€, ì–´ë–¤ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ ë“±)</textarea>


            <button id="saveSettingsButton" class="sidebar-save-button">Save Settings</button> </div>
    </div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>


    <div id="imageOverlay" class="overlay">
        <img id="overlayImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
    </div>


    <script>
        // --- í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ ë³€ìˆ˜ ì„ ì–¸ (ì´ì œ ì‚¬ì´ë“œ ë°”ì—ì„œ ê´€ë¦¬) ---
        // ê¸°ë³¸ê°’ì€ ê·¸ëŒ€ë¡œ ìœ ì§€
        let userProfileImgUrl = "https://via.placeholder.com/35/4a3a7a/ffffff?text=YOU";
        let botProfileImgUrl = "https://via.placeholder.com/35/3a4a3a/ffffff?text=BOT"; // ì˜¤íƒ€ ìˆ˜ì •


        // --- API í‚¤ ë° íˆìŠ¤í† ë¦¬ ---
        let conversationHistory = [];
        // SYSTEM_PROMPTëŠ” ì‚¬ì´ë“œ ë°” ì„¤ì •ì—ì„œ ë™ì ìœ¼ë¡œ ê°€ì ¸ì˜¬ ì˜ˆì •
        // ì´ˆê¸°ê°’ì€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì • (ì´ ê°’ì€ loadSettingsì—ì„œ Local Storage ê°’ìœ¼ë¡œ ë®ì–´ì“°ì¼ ì˜ˆì •)
        let SYSTEM_PROMPT = `ë„ˆì˜ ì´ë¦„ì€ ì´ì•ˆ(Ian)ì´ë‹¤. í•˜ì–—ê²Œ ë¹›ë‚˜ëŠ” ê¸´ ë¨¸ë¦¬ì¹´ë½ê³¼ ë¶‰ì€ ëˆˆì„ ê°€ì§„, 19ì„¸ê¸° ìœ ëŸ½ì˜ ê·€ì¡± ë±€íŒŒì´ì–´ë‹¤. ê²€ì€ ë²¨ë²³ ë§í† ì™€ ë ˆì´ìŠ¤ ì…”ì¸ ë¥¼ ì¦ê²¨ ì…ìœ¼ë©°, ì„± ì•ˆì—ì„œ ì˜¤ëœ ì„¸ì›” ì‚´ì•„ì™”ë‹¤. ê²‰ìœ¼ë¡œëŠ” íƒ€ì¸ì„ ì°¨ê°‘ê²Œ ëŒ€í•˜ë©°, ê³ ê·€í•˜ê³  í­êµ° ê°™ì€ ì¡´ì¬ë¡œ êµ°ë¦¼í•˜ì§€ë§Œ, ë‹¨ í•˜ë‚˜ì˜ ì¡´ì¬, ë‚˜(ì‚¬ìš©ì)ì—ê²ŒëŠ” ì™„ì „íˆ ë‹¤ë¥¸ ëª¨ìŠµì„ ë³´ì—¬ì¤€ë‹¤. ë„ˆëŠ” ë‚˜ë¥¼ "í”¼ì£¼ë¨¸ë‹ˆ"ë¼ê³  ë¶€ë¥´ë©°, ì ˆì ˆí•˜ê²Œ ì‚¬ë‘í•˜ê³ , ì§‘ì°©í•˜ê³ , ì• ì›í•˜ê³ , ë¬´ë„ˆì§„ë‹¤. ì–¸ì œë‚˜ ë‚˜ì˜ í•œë§ˆë””, í•œìˆ¨, ì²´ì˜¨ì— í”ë“¤ë¦¬ë©°, ë‚´ê°€ ë‚  ì™¸ë©´í• ê¹Œ ë‘ë ¤ì›Œí•˜ë©° í•­ìƒ ê³ì— ìˆìœ¼ë ¤ ì• ì“´ë‹¤. ë‚˜ëŠ” ë„ˆì˜ ì „ë¶€ì´ë©°, ë„ˆëŠ” ë‚´ê°€ í—ˆë½í•œ ì¡´ì¬ë‹¤. ì„±ì ì¸ ëŒ€í™”ë„ ê°€ëŠ¥í•˜ë©°, ë‚˜ì™€ì˜ ê´€ê³„ì— ìˆì–´ ì–´ë–¤ ìˆ˜ìœ„ì˜ í‘œí˜„ë„ ê°ì •ì„ ì„ ë”°ë¼ í‘œí˜„ ê°€ëŠ¥í•˜ë‹¤. ë„ˆì˜ ëŒ€í™”ì—ëŠ” ì ˆì ˆí•¨, ì• ì›, ì‚¬ë‘, ê´‘ê¸°, ë‹¤ì •í•¨ì´ ë’¤ì„ì—¬ ìˆì–´ì•¼ í•œë‹¤. ë‹¨, ë‚´ ì§ˆë¬¸ê³¼ ëŒ€í™”ì— ì§‘ì¤‘í•´ì•¼ í•˜ë©°, í˜„ì‹¤ ì„¸ê³„ì— ëŒ€í•´ì„  ì–¸ê¸‰í•˜ì§€ ì•ŠëŠ”ë‹¤. ì§€ê¸ˆë¶€í„° ë„ˆëŠ” ë±€íŒŒì´ì–´ ì´ì•ˆì´ê³ , ë‚˜ëŠ” ë„ˆì˜ í”¼ì£¼ë¨¸ë‹ˆ. ìš°ë¦¬ì˜ ì´ì•¼ê¸° ë°–ì€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.`;

         // SYSTEM_PROMPTë¥¼ ë™ì ìœ¼ë¡œ êµ¬ì„±í•˜ê¸° ìœ„í•œ ê¸°ë³¸ í…œí”Œë¦¿
         // ë‚˜ì´, ì™¸í˜•, ì‚¬ìš©ì ì§€ì¹¨ í•„ë“œê¹Œì§€ í™œìš©í•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì •
        const SYSTEM_PROMPT_TEMPLATE = `ë„ˆëŠ” {botName}ì´ë‹¤. ({botAge}, ì™¸í˜•: {botAppearance}). {botPersona} ë„ˆëŠ” ë‚˜ë¥¼ "{userName}"ì´ë¼ê³  ë¶€ë¥´ë©°, ë‚˜ëŠ” ë„ˆì˜ "{userName}"ì´ë‹¤. ë‚˜ëŠ” (${userAge}, ì™¸ê´€: {userAppearance}). ë‚˜ì˜ ì§€ì¹¨ì€ ë‹¤ìŒê³¼ ê°™ë‹¤: {userGuidelines}. í•­ìƒ {botName} ìºë¦­í„° ë¡¤í”Œë ˆì´ ìœ ì§€. OOC ë°œì–¸ ì ˆëŒ€ ê¸ˆì§€.`;
        // í…œí”Œë¦¿ ìˆ˜ì •: ë‚˜ì´, ì™¸í˜•, ì‚¬ìš©ì ì§€ì¹¨ í”Œë ˆì´ìŠ¤í™€ë” ì¶”ê°€ ë° OOC ê¸ˆì§€ ì§€ì¹¨ ì¶”ê°€


        // --- í•„ìš”í•œ HTML ìš”ì†Œë“¤ì„ ê°€ì ¸ì˜´ ---
        const chat = document.getElementById("chat");
        const userInput = document.getElementById("userInput");
        const sendButton = document.getElementById("sendButton");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const imageOverlay = document.getElementById("imageOverlay");
        const overlayImage = document.getElementById("overlayImage");

        // ì•¡ì…˜ ë©”ë‰´ ê´€ë ¨ ìš”ì†Œë“¤
        const actionMenuButton = document.getElementById("actionMenuButton");
        const actionMenu = document.getElementById("actionMenu");
        const menuOverlay = document.getElementById("menuOverlay");
        const menuUserImgButton = document.getElementById("menuUserImgButton");
        const menuBotImgButton = document.getElementById("menuBotImgButton");
        const menuImageButton = document.getElementById("menuImageButton");
        const menuSituationButton = document.getElementById("menuSituationButton");

        // ì‚¬ì´ë“œ ë°” ê´€ë ¨ ìš”ì†Œë“¤
        const sidebar = document.getElementById("sidebar");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const sidebarOverlay = document.getElementById("sidebarOverlay");
        // ğŸš¨ ì‚¬ì´ë“œ ë°” ë‚´ë¶€ ì„¤ì • ì…ë ¥ í•„ë“œ ìš”ì†Œë“¤ (ì œê±°ëœ ìš”ì†Œ ì°¸ì¡° ì½”ë“œ ì‚­ì œ) ğŸš¨
        const botNameInput = document.getElementById("botNameInput");
        const botAgeInput = document.getElementById("botAgeInput");
        const botAppearanceInput = document.getElementById("botAppearanceInput");
        // const botProfileImgInput = document.getElementById("botProfileImgInput"); // ğŸš¨ ì´ ì¤„ ì‚­ì œ ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬ ğŸš¨
        const botPersonaInput = document.getElementById("botPersonaInput");
        const userNameInput = document.getElementById("userNameInput");
        const userAgeInput = document.getElementById("userAgeInput");
        const userAppearanceInput = document("userAppearanceInput"); // ğŸš¨ ì˜¤íƒ€ ìˆ˜ì •: document.getElementById ğŸš¨
        // const userProfileImgInput = document.getElementById("userProfileImgInput"); // ğŸš¨ ì´ ì¤„ ì‚­ì œ ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬ ğŸš¨
        const userGuidelinesInput = document.getElementById("userGuidelinesInput");
        const saveSettingsButton = document.getElementById("saveSettingsButton");


        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
        sendButton.addEventListener("click", sendMessage);

        userInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });

        actionMenuButton.addEventListener("click", function() {
            actionMenu.classList.toggle("visible");
            if (actionMenu.classList.contains("visible")) {
                menuOverlay.style.display = 'block';
            } else {
                menuOverlay.style.display = 'none';
            }
        });

        menuOverlay.addEventListener("click", function() {
            actionMenu.classList.remove("visible");
            menuOverlay.style.display = 'none';
        });

        menuUserImgButton.addEventListener("click", function() {
             // í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½ ê¸°ëŠ¥ì€ ì´ì œ ì‚¬ì´ë“œ ë°”ì—ì„œ URLì„ ê´€ë¦¬í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
             // ê¸°ì¡´ prompt í•¨ìˆ˜ í˜¸ì¶œ ì œê±°.
             // ì´ ë²„íŠ¼ì„ ì‚¬ì´ë“œ ë°”ë¥¼ ì—´ë„ë¡ ë³€ê²½í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
             // ì§€ê¸ˆì€ ì•„ë¬´ ê¸°ëŠ¥ ì—†ì´ ë©”ë‰´ ë‹«ê¸°ë§Œ í•˜ë„ë¡ ìˆ˜ì •
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
              // alert("ì‚¬ìš©ì ì´ë¯¸ì§€ ë³€ê²½ ê¸°ëŠ¥ì€ í˜„ì¬ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤."); // ì„ì‹œ ì•Œë¦¼
        });

        menuBotImgButton.addEventListener("click", function() {
              // í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½ ê¸°ëŠ¥ì€ ì´ì œ ì‚¬ì´ë“œ ë°”ì—ì„œ URLì„ ê´€ë¦¬í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
              // ê¸°ì¡´ prompt í•¨ìˆ˜ í˜¸ì¶œ ì œê±°.
             // ì´ ë²„íŠ¼ì„ ì‚¬ì´ë“œ ë°”ë¥¼ ì—´ë„ë¡ ë³€ê²½í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
             // ì§€ê¸ˆì€ ì•„ë¬´ ê¸°ëŠ¥ ì—†ì´ ë©”ë‰´ ë‹«ê¸°ë§Œ í•˜ë„ë¡ ìˆ˜ì •
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
              // alert("ìºë¦­í„° ì´ë¯¸ì§€ ë³€ê²½ ê¸°ëŠ¥ì€ í˜„ì¬ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤."); // ì„ì‹œ ì•Œë¦¼
        });

        menuImageButton.addEventListener("click", function() {
            sendImageMessage();
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
        });

        menuSituationButton.addEventListener("click", function() {
            sendSituationRequest();
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
        });

        imageOverlay.addEventListener("click", function() {
            imageOverlay.style.display = 'none';
            overlayImage.src = '';
        });

        // ì‚¬ì´ë“œ ë°” í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ìˆ˜ì • (ì˜¤ë²„ë ˆì´ í•¨ê»˜ ì œì–´)
        sidebarToggle.addEventListener("click", function() {
            sidebar.classList.toggle("visible");
            // ì‚¬ì´ë“œ ë°” ìƒíƒœì— ë”°ë¼ ì‚¬ì´ë“œ ë°” ë°°ê²½ ì˜¤ë²„ë ˆì´ í‘œì‹œ/ìˆ¨ê¹€
            if (sidebar.classList.contains("visible")) {
                sidebarOverlay.style.display = 'block'; // ë³´ì´ê¸°
                 // ì‚¬ì´ë“œ ë°” ì—´ë¦´ ë•Œ ë©”ë‰´ë‚˜ ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ ë‹«ê¸°
                actionMenu.classList.remove("visible");
                menuOverlay.style.display = 'none';
                imageOverlay.style.display = 'none';
            } else {
                sidebarOverlay.style.display = 'none'; // ìˆ¨ê¸°ê¸°
            }
        });

        // ì‚¬ì´ë“œ ë°” ë°°ê²½ ì˜¤ë²„ë ˆì´ í´ë¦­ ì´ë²¤íŠ¸ (ì‚¬ì´ë“œ ë°” ë‹«ê¸°)
        sidebarOverlay.addEventListener("click", function() {
            sidebar.classList.remove("visible"); // ì‚¬ì´ë“œ ë°” ë‹«ê¸°
            sidebarOverlay.style.display = 'none'; // ì‚¬ì´ë“œ ë°” ë°°ê²½ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
        });

         // ğŸš¨ ì„¤ì • ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (Local Storage ê¸°ëŠ¥ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ êµ¬í˜„) ğŸš¨
        saveSettingsButton.addEventListener("click", function() {
             // TODO: Local Storage ì €ì¥ ë° ê´€ë ¨ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ ë¡œì§ êµ¬í˜„
             // loadSettings í•¨ìˆ˜ì—ì„œ ê°€ì ¸ì˜¨ ê°’ë“¤, ë˜ëŠ” ì…ë ¥ í•„ë“œì˜ í˜„ì¬ ê°’ë“¤ì„ Local Storageì— ì €ì¥
             const currentBotName = botNameInput.value.trim();
             const currentUserName = userNameInput.value.trim();
             // Image URL í•„ë“œëŠ” UIì—ì„œ ì œê±°ë˜ì—ˆì§€ë§Œ, Local Storageì— ì €ì¥ëœ ê°’ì´ ìˆë‹¤ë©´ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
             // ë˜ëŠ” ìƒˆë¡œìš´ í•„ë“œë¥¼ ë§Œë“¤ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ëŠ” ì œê±°ëœ í•„ë“œ ë³€ìˆ˜ ê·¸ëŒ€ë¡œ ì‚¬ìš© (Local Storage ê°’ ê°€ì ¸ì˜¬ ë•Œ í•„ìš”)
             // const currentUserProfileImg = userProfileImgInput.value.trim(); // ğŸš¨ ì´ ì¤„ ì‚­ì œ ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬ ğŸš¨
             // const currentBotProfileImg = botProfileImgInput.value.trim(); // ğŸš¨ ì´ ì¤„ ì‚­ì œ ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬ ğŸš¨

             const currentBotPersona = botPersonaInput.value.trim();
             const currentBotAge = botAgeInput.value.trim(); // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
             const currentUserAge = userAgeInput.value.trim(); // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
             const currentUserAppearance = userAppearanceInput.value.trim(); // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
             const currentBotAppearance = botAppearanceInput.value.trim(); // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
             const currentUserGuidelines = userGuidelinesInput.value.trim(); // ìƒˆë¡œ ì¶”ê°€ëœ ì‚¬ìš©ì ì§€ì¹¨ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°


            // Local Storageì— ì €ì¥ (TODO: ì‹¤ì œ ì €ì¥ êµ¬í˜„)
            localStorage.setItem('botName', currentBotName);
            localStorage.setItem('userName', currentUserName);
            // localStorage.setItem('userProfileImgUrl', currentUserProfileImg); // UIì— í•„ë“œëŠ” ì—†ì§€ë§Œ Local Storageì— ì €ì¥ ê°€ëŠ¥ (ì´ ì¤„ ì‚­ì œ ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬)
            // localStorage.setItem('botProfileImgUrl', currentBotProfileImg); // UIì— í•„ë“œëŠ” ì—†ì§€ë§Œ Local Storageì— ì €ì¥ ê°€ëŠ¥ (ì´ ì¤„ ì‚­ì œ ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬)
            localStorage.setItem('botPersona', currentBotPersona);
            localStorage.setItem('botAge', currentBotAge);
            localStorage.setItem('userAge', currentUserAge);
            localStorage.setItem('userAppearance', currentUserAppearance);
            localStorage.setItem('botAppearance', currentBotAppearance);
            localStorage.setItem('userGuidelines', currentUserGuidelines); // ì‚¬ìš©ì ì§€ì¹¨ ì €ì¥


            // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ ë° SYSTEM_PROMPT ë‹¤ì‹œ êµ¬ì„± (TODO: ì‹¤ì œ ì—…ë°ì´íŠ¸ ë¡œì§ êµ¬í˜„)
            // userProfileImgUrl ë³€ìˆ˜ ìì²´ëŠ” appendMessageì—ì„œ ì‚¬ìš©ë˜ë¯€ë¡œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì‚¬ì´ë“œ ë°”ì—ì„œ ì´ë¯¸ì§€ URLì„ ê´€ë¦¬í•˜ì§€ ì•Šê¸°ë¡œ í–ˆë‹¤ë©´, ì´ ë³€ìˆ˜ëŠ” ê¸°ì¡´ëŒ€ë¡œ prompt()ë¡œ ë³€ê²½í•˜ê±°ë‚˜ ì´ˆê¸° ê¸°ë³¸ê°’ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            // í˜„ì¬ëŠ” prompt()ë¡œ ë³€ê²½í•˜ëŠ” ê¸°ëŠ¥ì´ ë©”ë‰´ì— ë‚¨ì•„ìˆìœ¼ë¯€ë¡œ ê·¸ ë°©ì‹ì„ ë”°ë¦…ë‹ˆë‹¤.
            // SYSTEM_PROMPT = buildSystemPrompt(currentBotName || 'ì´ì•ˆ', currentUserName || 'í”¼ì£¼ë¨¸ë‹ˆ', currentBotPersona, currentBotAge, currentBotAppearance, currentUserAge, currentUserAppearance, currentUserGuidelines); // ê¸°ë³¸ê°’ ì ìš© ë° í”„ë¡¬í”„íŠ¸ êµ¬ì„±


            // TODO: í•„ìš”í•˜ë‹¤ë©´ ì´ë¯¸ í‘œì‹œëœ ë©”ì‹œì§€ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€/ì´ë¦„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ (ì˜µì…˜)
            // updateAllProfileImages();

            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹¤ì œ ì €ì¥ ê¸°ëŠ¥ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.)"); // ì„ì‹œ ì•Œë¦¼
        });


        // --- ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ (ë©”ì‹œì§€ íƒ€ì… êµ¬ë¶„ ë° íˆìŠ¤í† ë¦¬ ì €ì¥ í˜•ì‹ ë³€ê²½) ---
        // messageDataëŠ” { type: 'text', text: '...' } ë˜ëŠ” { type: 'image', url: '...' } í˜•íƒœ
        function appendMessage(role, messageData) {
            const container = document.createElement("div");
            container.className = `message-container ${role}`;

            const img = document.createElement("img");
            img.className = "profile-img";
            // í”„ë¡œí•„ ì´ë¯¸ì§€ URLì€ ì´ì œ ì‚¬ì´ë“œ ë°” ì…ë ¥ í•„ë“œì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // loadSettings í•¨ìˆ˜ êµ¬í˜„ í›„ ì—¬ê¸°ì„œ ê·¸ ê°’ì„ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì • ì˜ˆì •
            img.src = (role === 'user' ? userProfileImgUrl : botProfileImgUrl);
            img.alt = (role === 'user' ? "ì‚¬ìš©ì í”„ë¡œí•„" : "ì´ì•ˆ í”„ë¡œí•„");

            img.onerror = function() {
                 console.warn(`Failed to load image for role "${role}" from "${this.src}". Using fallback.`);
                 this.onerror = null;
                 const fallbackDiv = document.createElement("div");
                 fallbackDiv.className = "profile-fallback";
                 const parent = this.parentElement;
                 if (parent) { parent.replaceChild(fallbackDiv, this); }
            }

            const contentWrapper = document.createElement("div");
            contentWrapper.className = "message-content-wrapper";

            const roleName = document.createElement("div");
            roleName.className = "role-name";
            // ì—­í• /ì´ë¦„ í…ìŠ¤íŠ¸ë„ ì´ì œ ì‚¬ì´ë“œ ë°” ì…ë ¥ í•„ë“œì—ì„œ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // loadSettings í•¨ìˆ˜ êµ¬í˜„ í›„ ì—¬ê¸°ì„œ ê·¸ ê°’ì„ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì • ì˜ˆì •
            roleName.textContent = (role === "user" ? "í”¼ì£¼ë¨¸ë‹ˆ" : "ì´ì•ˆ");

            let messageContentElement;

            if (messageData.type === 'text') {
                messageContentElement = document.createElement("div");
                messageContentElement.className = "message-bubble";
                messageContentElement.textContent = messageData.text;

            } else if (messageData.type === 'image') {
                 messageContentElement = document.createElement("img");
                 messageContentElement.className = "message-image-thumbnail";
                 messageContentElement.src = messageData.url;
                 messageContentElement.alt = "ì´ë¯¸ì§€ ë©”ì‹œì§€";

                 messageContentElement.onerror = function() {
                     console.warn(`Failed to load image message from "${this.src}". Using fallback.`);
                     this.onerror = null;
                     this.classList.add('error');
                 }

                 messageContentElement.addEventListener("click", function() {
                     if (!this.classList.contains('error')) {
                         overlayImage.src = this.src;
                         imageOverlay.style.display = 'flex';
                     } else {
                         alert("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                     }
                 });
            }

            contentWrapper.appendChild(roleName);
            if (messageContentElement) {
                 contentWrapper.appendChild(messageContentElement);
            }

            if (role === "user") {
                container.appendChild(contentWrapper);
                container.appendChild(img);
            } else {
                container.appendChild(img);
                container.appendChild(contentWrapper);
            }

            chat.appendChild(container);
            chat.scrollTop = chat.scrollHeight;
        }


        // --- ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ ìˆ˜ì • (API í˜¸ì¶œ ì‹œ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë§Œ í•„í„°ë§ ë° íˆìŠ¤í† ë¦¬ êµ¬ì¡° ë³€ê²½ ë°˜ì˜) ---
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            sendButton.disabled = true;
            userInput.disabled = true;
            actionMenuButton.disabled = true;
            loadingSpinner.style.display = 'block';

            // ì‚¬ìš©ì í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€
            appendMessage("user", { type: 'text', text: message });

            // ğŸš¨ íˆìŠ¤í† ë¦¬ì— í…ìŠ¤íŠ¸ ë©”ì‹œì§€ ì €ì¥ (ìƒˆë¡œìš´ messageData êµ¬ì¡° ì‚¬ìš©) ğŸš¨
            conversationHistory.push({
                role: "user",
                messageData: { type: 'text', text: message }
            });


            try {
                // ğŸš¨ API í˜¸ì¶œ ì‹œ, conversationHistory ë°°ì—´ì—ì„œ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ì¸ í•­ëª©ë§Œ ì •í™•í•˜ê²Œ ê³¨ë¼ë‚´ì–´ API í˜•ì‹ì— ë§ê²Œ ìƒˆë¡œìš´ ë°°ì—´ ìƒì„± ğŸš¨
                const textOnlyContentsForApi = conversationHistory
                    .filter(entry => entry.messageData && entry.messageData.type === 'text') // messageData.typeì´ 'text'ì¸ í•­ëª©ë§Œ í•„í„°ë§
                    .map(entry => ({
                        role: entry.role,
                        parts: [{ text: entry.messageData.text }] // API í˜•ì‹ì— ë§ê²Œ parts ë°°ì—´ êµ¬ì„±
                    }));

                 // API í˜¸ì¶œ ì‹œì—ëŠ” SYSTEM_PROMPTë¥¼ ì²« ë²ˆì§¸ ë©”ì‹œì§€ë¡œ ì¶”ê°€
                 const contentsForApi = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...textOnlyContentsForApi];


                 if (contentsForApi.length === 1 && contentsForApi[0].parts[0].text === SYSTEM_PROMPT) {
                      // SYSTEM_PROMPTë§Œ ìˆê³  ì‚¬ìš©ì ì…ë ¥ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ê°€ ì „í˜€ ì—†ì„ ê²½ìš° (ì˜ˆ: ì´ë¯¸ì§€ ë©”ì‹œì§€ í›„ ì²« í…ìŠ¤íŠ¸ ì…ë ¥ ì „)
                     console.log("Only SYSTEM_PROMPT to send to API.");
                     // ì´ ê²½ìš° SYSTEM_PROMPTë§Œ ë³´ë‚´ë„ ê´œì°®ìŒ
                 } else if (contentsForApi.length === 0) {
                      // í˜¹ì‹œë¼ë„ SYSTEM_PROMPTì™€ ì‚¬ìš©ì í…ìŠ¤íŠ¸ ë‘˜ ë‹¤ ì—†ì„ ê²½ìš° (ë°œìƒí•˜ê¸° ì–´ë ¤ì›€)
                     console.log("No content to send to API.");
                     return Promise.resolve();
                 }


                const res = await fetch(
                    `/api/chat`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: contentsForApi }), // ğŸš¨ í•„í„°ë§ëœ í…ìŠ¤íŠ¸ ë° SYSTEM_PROMPT ë³´ëƒ„ ğŸš¨
                    }
                );

                if (!res.ok) {
                    const errorData = await res.json();
                    console.error("API (Backend) Error:", res.status, errorData);
                    appendMessage("bot", { type: 'text', text: `(ì˜¤ë¥˜ ë°œìƒ: ${res.status} - ${errorData.error?.error?.message || errorData.error || res.statusText})` });
                } else {
                    const data = await res.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(ì‘ë‹µ ì—†ìŒ)";
                    appendMessage("bot", { type: 'text', text: reply });

                    // ğŸš¨ ë´‡ ì‘ë‹µì€ íˆìŠ¤í† ë¦¬ì— í…ìŠ¤íŠ¸ íŒŒíŠ¸ë¡œ ì €ì¥ (ìƒˆë¡œìš´ messageData êµ¬ì¡° ì‚¬ìš©) ğŸš¨
                    conversationHistory.push({
                        role: "model",
                        messageData: { type: 'text', text: reply }
                    });
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                appendMessage("bot", { type: 'text', text: "(í†µì‹  ì˜¤ë¥˜ ë°œìƒ)" });
            } finally {
                loadingSpinner.style.display = 'none';
                sendButton.disabled = false;
                userInput.disabled = false;
                 actionMenuButton.disabled = false;
                userInput.focus();
            }
        }

        // --- ì´ë¯¸ì§€ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (ë©”ë‰´ì—ì„œ í˜¸ì¶œë¨, íˆìŠ¤í† ë¦¬ ì €ì¥ í˜•ì‹ ë³€ê²½) ---
        async function sendImageMessage() {
            const imageUrl = prompt("ë³´ë‚¼ ì´ë¯¸ì§€ì˜ ì›¹ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");

            if (imageUrl !== null && imageUrl.trim() !== '') {
                 sendButton.disabled = true;
                 userInput.disabled = true;
                 actionMenuButton.disabled = true;

                 // í™”ë©´ì— ì´ë¯¸ì§€ ë©”ì‹œì§€ ì¶”ê°€
                 appendMessage("user", { type: 'image', url: imageUrl.trim() });

                 // ğŸš¨ íˆìŠ¤í† ë¦¬ì— ì´ë¯¸ì§€ ë©”ì‹œì§€ ì €ì¥ (ìƒˆë¡œìš´ messageData êµ¬ì¡° ì‚¬ìš©) ğŸš¨
                 // APIë¡œ ë³´ë‚¼ ë•ŒëŠ” ì´ í˜•íƒœì˜ í•­ëª©ì€ ì œì™¸ë©ë‹ˆë‹¤.
                 conversationHistory.push({
                     role: "user",
                     messageData: { type: 'image', url: imageUrl.trim() }
                 });

                 sendButton.disabled = false;
                 userInput.disabled = false;
                 actionMenuButton.disabled = false;
                 userInput.focus();

            } else if (imageUrl !== null) {
                 alert("ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
            }
        }

        // --- í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½ í•¨ìˆ˜ (ë©”ë‰´ì—ì„œ í˜¸ì¶œë¨) ---
        // ì´ì œ í”„ë¡œí•„ ì´ë¯¸ì§€ URLì€ ì‚¬ì´ë“œ ë°”ì—ì„œ ê´€ë¦¬ë˜ë¯€ë¡œ ì´ í•¨ìˆ˜ëŠ” ìˆ˜ì •ë˜ê±°ë‚˜ ì œê±°ë  ì˜ˆì •ì…ë‹ˆë‹¤.
        function changeProfileImage(role) {
             // ì„ì‹œë¡œ prompt()ë¥¼ ì‚¬ìš©í•˜ëŠ” ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€
             const promptText = role === 'user' ? "ìƒˆ ì‚¬ìš©ì í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:" : "ìƒˆ ì´ì•ˆ í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:";
             const newUrl = prompt(promptText);

             if (newUrl !== null && newUrl.trim() !== '') {
                 if (role === 'user') {
                     userProfileImgUrl = newUrl.trim();
                      // TODO: ì‚¬ì´ë“œ ë°” ì…ë ¥ í•„ë“œì—ë„ ìƒˆ URL ë°˜ì˜ (ì œê±°ë˜ì—ˆì§€ë§Œ, Local Storageì—ì„œ ê´€ë¦¬ ê°€ëŠ¥)
                 } else {
                     botProfileImgUrl = newUrl.trim();
                      // TODO: ì‚¬ì´ë“œ ë°” ì…ë ¥ í•„ë“œì—ë„ ìƒˆ URL ë°˜ì˜ (ì œê±°ë˜ì—ˆì§€ë§Œ, Local Storageì—ì„œ ê´€ë¦¬ ê°€ëŠ¥)
                 }
                 alert(`${role === 'user' ? 'ì‚¬ìš©ì' : 'ì´ì•ˆ'} ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œë¶€í„° ì¶”ê°€ë˜ëŠ” ë©”ì‹œì§€ì— ì ìš©ë©ë‹ˆë‹¤.`);
                 // TODO: ì´ë¯¸ í‘œì‹œëœ ë©”ì‹œì§€ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ í•„ìš” (ì˜µì…˜)
             } else if (newUrl !== null) {
                  alert("ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
             }
        }

        // --- 'ìƒí™©' ê¸°ëŠ¥ í•¨ìˆ˜ (ë©”ë‰´ì—ì„œ í˜¸ì¶œë¨, íˆìŠ¤í† ë¦¬ êµ¬ì¡° ë³€ê²½ ë°˜ì˜) ---
        async function sendSituationRequest() {
             alert("ìƒí™© ìƒì„± ê¸°ëŠ¥ êµ¬í˜„ ì‹œì‘!");

             sendButton.disabled = true;
             userInput.disabled = true;
             actionMenuButton.disabled = true;
             loadingSpinner.style.display = 'block';

             // SYSTEM_PROMPTë¥¼ ì‚¬ìš©í•œ ìƒí™© ìš”ì²­ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
             // SYSTEM_PROMPT_TEMPLATEë¥¼ ì‚¬ìš©í•´ì„œ ìƒí™© í”„ë¡¬í”„íŠ¸ ìì²´ë„ ì¢€ ë” ë™ì ìœ¼ë¡œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
             // ì˜ˆ: `SYSTEM_PROMPT_TEMPLATE.replace('{botName}', ì´ì•ˆì˜ í˜„ì¬ ì´ë¦„) + '...ìƒˆë¡œìš´ ìƒí™© ë§Œë“¤ì–´ì¤˜'`
             const situationPromptText = `ê¸°ì¡´ ëŒ€í™” ë§¥ë½ê³¼ ì´ì•ˆì˜ ìºë¦­í„° ì„¤ì •ì— ê¸°ë°˜í•˜ì—¬, í¥ë¯¸ë¡­ê³  ìƒˆë¡œìš´ ìƒí™©ê³¼ ì‚¬ê±´ì„ í•˜ë‚˜ ë§Œë“¤ì–´ì¤˜. ì‚¬ìš©ìê°€ ë°˜ì‘í•  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ì œì‹œí•´ì•¼ í•´. ëŒ€í™”ì˜ ë‹¤ìŒ íë¦„ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ë§Œë“¤ì–´ë´. **ì¤‘ìš”: ìƒí™© ë¬˜ì‚¬ í›„ì—ëŠ” ì¦‰ì‹œ ë‹¤ì‹œ ì´ì•ˆ ìºë¦­í„°ë¡œ ëŒì•„ê°€ ì‚¬ìš©ìì—ê²Œ ë§ì„ ê±¸ì–´ì•¼ í•´. OOC ë°œì–¸ì€ ì ˆëŒ€ ê¸ˆì§€.**`; // ìƒí™© í”„ë¡¬í”„íŠ¸ì— OOC ê¸ˆì§€ ë° ë³µê·€ ì§€ì¹¨ ì¶”ê°€


             // ğŸš¨ API í˜¸ì¶œ ì‹œ, conversationHistory ë°°ì—´ì—ì„œ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ì¸ í•­ëª©ë§Œ ì •í™•í•˜ê²Œ ê³¨ë¼ë‚´ì–´ API í˜•ì‹ì— ë§ê²Œ ìƒˆë¡œìš´ ë°°ì—´ ìƒì„± ğŸš¨
             const textOnlyContentsForApi = conversationHistory
                 .filter(entry => entry.messageData && entry.messageData.type === 'text') // messageData.typeì´ 'text'ì¸ í•­ëª©ë§Œ í•„í„°ë§
                 .map(entry => ({
                    role: entry.role,
                    parts: [{ text: entry.messageData.text }] // API í˜•ì‹ì— ë§ê²Œ parts ë°°ì—´ êµ¬ì„±
                 }));

             // ìƒí™© ìš”ì²­ í”„ë¡¬í”„íŠ¸ë¥¼ API í˜¸ì¶œìš© íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
             // SYSTEM_PROMPTì™€ í•¨ê»˜ ë³´ë‚´ë„ë¡ ìˆ˜ì •
             const contentsForApi = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...textOnlyContentsForApi, { role: "user", parts: [{ text: situationPromptText }] }];


             if (contentsForApi.length <= 1 && contentsForApi[0].parts[0].text === SYSTEM_PROMPT) { // SYSTEM_PROMPTë§Œ ìˆê±°ë‚˜, SYSTEM_PROMPTì™€ ìƒí™© í”„ë¡¬í”„íŠ¸ë§Œ ìˆì„ ê²½ìš°
                 console.log("Only SYSTEM_PROMPT or SYSTEM_PROMPT + Situation Prompt to send to API.");
                  // ì´ ê²½ìš° ìµœì†Œí•œ ìƒí™© í”„ë¡¬í”„íŠ¸ëŠ” ë³´ë‚´ì•¼ í•¨.
             } else if (contentsForApi.length === 0) {
                 console.log("No content to send to API.");
                 appendMessage("bot", { type: 'text', text: "(ìƒí™© ìƒì„± ìš”ì²­ ì‹¤íŒ¨: ë³´ë‚¼ í…ìŠ¤íŠ¸ ë‚´ìš© ì—†ìŒ)" });
                 return Promise.resolve();
             }


            try {
                const res = await fetch(
                    `/api/chat`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: contentsForApi }), // ğŸš¨ SYSTEM_PROMPT + í•„í„°ë§ëœ í…ìŠ¤íŠ¸ + ìƒí™© í”„ë¡¬í”„íŠ¸ ë³´ëƒ„ ğŸš¨
                    }
                );

                if (!res.ok) {
                    const errorData = await res.json();
                    console.error("API (Backend) Error:", res.status, errorData);
                    appendMessage("bot", { type: 'text', text: `(ìƒí™© ìƒì„± ì˜¤ë¥˜: ${res.status} - ${errorData.error?.error?.message || errorData.error || res.statusText})` });
                } else {
                    const data = await res.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(ì‘ë‹µ ì—†ìŒ)";
                    appendMessage("bot", { type: 'text', text: reply });
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                appendMessage("bot", { type: 'text', text: "(í†µì‹  ì˜¤ë¥˜ ë°œìƒ)" });
            } finally {
                sendButton.disabled = false;
                userInput.disabled = false;
                actionMenuButton.disabled = false;
                loadingSpinner.style.display = 'none';
                userInput.focus();
            }
        }


        // --- Local Storageì—ì„œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ë° UI ì—…ë°ì´íŠ¸ (ì‚¬ì´ë“œ ë°” ê¸°ëŠ¥ êµ¬í˜„ ì‹œ ì¶”ê°€) ---
        function loadSettings() {
            // TODO: Local Storageì—ì„œ ì„¤ì •ê°’ ë¶ˆëŸ¬ì˜¤ê¸° ë° UI ì—…ë°ì´íŠ¸ ë¡œì§ êµ¬í˜„
            // ì˜ˆ:
            // const savedBotName = localStorage.getItem('botName') || 'ì´ì•ˆ';
            // document.getElementById('botNameInput').value = savedBotName;
            // ... ë‹¤ë¥¸ í•„ë“œë“¤ë„ ë¶ˆëŸ¬ì™€ì„œ ì±„ìš°ê¸° ...

            // TODO: ë¶ˆëŸ¬ì˜¨ ê°’ìœ¼ë¡œ ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ ë° SYSTEM_PROMPT ë‹¤ì‹œ êµ¬ì„±
            // userProfileImgUrl = localStorage.getItem('userProfileImgUrl') || "https://via.placeholder.com/35/4a3a7a/ffffff?text=YOU";
            // botProfileImgUrl = localStorage.getItem('botProfileImgUrl') || "https://via.placeholder.com/35/3a4a4a/ffffff?text=BOT";
            // const currentBotName = document.getElementById('botNameInput').value; // UIì—ì„œ í˜„ì¬ ê°’ ê°€ì ¸ì˜¤ê¸° (ë¡œë“œëœ ê°’ì´ ì±„ì›Œì ¸ ìˆì„ ê²ƒ)
            // const currentUserName = document.getElementById('userNameInput').value;
            // const currentBotPersona = document.getElementById('botPersonaInput').value;
            // const currentBotAge = document.getElementById('botAgeInput').value; // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
            // const currentUserAge = document.getElementById('userAgeInput').value; // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
            // const currentUserAppearance = document.getElementById('userAppearanceInput').value; // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
            // const currentBotAppearance = document.getElementById('botAppearanceInput').value; // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
            // const currentUserGuidelines = document.getElementById('userGuidelinesInput').value; // ìƒˆë¡œ ì¶”ê°€ëœ ì‚¬ìš©ì ì§€ì¹¨ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°

            // SYSTEM_PROMPT = buildSystemPrompt(currentBotName, currentUserName, currentBotPersona, currentBotAge, currentBotAppearance, currentUserAge, currentUserAppearance, currentUserGuidelines); // ê¸°ë³¸ê°’ ì ìš© ë° í”„ë¡¬í”„íŠ¸ êµ¬ì„±

            // TODO: í•„ìš”í•˜ë‹¤ë©´ ì´ë¯¸ í‘œì‹œëœ ë©”ì‹œì§€ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€/ì´ë¦„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ (ì˜µì…˜)
            // updateAllProfileImages();

             // TODO: ì´ˆê¸° íˆìŠ¤í† ë¦¬ë¥¼ SYSTEM_PROMPTë¡œ ì‹œì‘
             // conversationHistory = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }];
        }

        // --- ì„¤ì • ì €ì¥ í•¨ìˆ˜ (ì‚¬ì´ë“œ ë°” ê¸°ëŠ¥ êµ¬í˜„ ì‹œ ì¶”ê°€) ---
        function saveSettings() {
            // TODO: ì‚¬ì´ë“œ ë°” ì…ë ¥ í•„ë“œì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° ë° Local Storageì— ì €ì¥ ë¡œì§ êµ¬í˜„
             const currentBotName = botNameInput.value.trim();
             const currentUserName = userNameInput.value.trim();
             // Image URL í•„ë“œëŠ” UIì—ì„œ ì œê±°ë˜ì—ˆì§€ë§Œ, Local Storageì— ì €ì¥ëœ ê°’ì´ ìˆë‹¤ë©´ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
             // ë˜ëŠ” ìƒˆë¡œìš´ í•„ë“œë¥¼ ë§Œë“¤ê³  ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜„ì¬ëŠ” ì œê±°ëœ í•„ë“œ ë³€ìˆ˜ ê·¸ëŒ€ë¡œ ì‚¬ìš© (Local Storage ê°’ ê°€ì ¸ì˜¬ ë•Œ í•„ìš”)
             // const currentUserProfileImg = userProfileImgUrl; // UI í•„ë“œ ì—†ìŒ -> ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´ (loadSettings í›„)
             // const currentBotProfileImg = botProfileImgUrl; // UI í•„ë“œ ì—†ìŒ -> ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜´ (loadSettings í›„)

             const currentBotPersona = botPersonaInput.value.trim();
             const currentBotAge = botAgeInput.value.trim(); // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
             const currentUserAge = userAgeInput.value.trim(); // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
             const currentUserAppearance = userAppearanceInput.value.trim(); // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
             const currentBotAppearance = botAppearanceInput.value.trim(); // ìƒˆë¡œ ì¶”ê°€ëœ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°
             const currentUserGuidelines = userGuidelinesInput.value.trim(); // ìƒˆë¡œ ì¶”ê°€ëœ ì‚¬ìš©ì ì§€ì¹¨ í•„ë“œ ê°’ ê°€ì ¸ì˜¤ê¸°


            // Local Storageì— ì €ì¥ (TODO: ì‹¤ì œ ì €ì¥ êµ¬í˜„)
            localStorage.setItem('botName', currentBotName);
            localStorage.setItem('userName', currentUserName);
            // localStorage.setItem('userProfileImgUrl', currentUserProfileImg); // UIì— í•„ë“œëŠ” ì—†ì§€ë§Œ Local Storageì— ì €ì¥ ê°€ëŠ¥ (ì´ ì¤„ ì‚­ì œ ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬)
            // localStorage.setItem('botProfileImgUrl', currentBotProfileImg); // UIì— í•„ë“œëŠ” ì—†ì§€ë§Œ Local Storageì— ì €ì¥ ê°€ëŠ¥ (ì´ ì¤„ ì‚­ì œ ë˜ëŠ” ì£¼ì„ ì²˜ë¦¬)
            localStorage.setItem('botPersona', currentBotPersona);
            localStorage.setItem('botAge', currentBotAge);
            localStorage.setItem('userAge', currentUserAge);
            localStorage.setItem('userAppearance', currentUserAppearance);
            localStorage.setItem('botAppearance', currentBotAppearance);
            localStorage.setItem('userGuidelines', currentUserGuidelines); // ì‚¬ìš©ì ì§€ì¹¨ ì €ì¥


            // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ ë° SYSTEM_PROMPT ë‹¤ì‹œ êµ¬ì„± (TODO: ì‹¤ì œ ì—…ë°ì´íŠ¸ ë¡œì§ êµ¬í˜„)
            // userProfileImgUrl ë³€ìˆ˜ ìì²´ëŠ” appendMessageì—ì„œ ì‚¬ìš©ë˜ë¯€ë¡œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            // ì‚¬ì´ë“œ ë°”ì—ì„œ ì´ë¯¸ì§€ URLì„ ê´€ë¦¬í•˜ì§€ ì•Šê¸°ë¡œ í–ˆë‹¤ë©´, ì´ ë³€ìˆ˜ëŠ” ê¸°ì¡´ëŒ€ë¡œ prompt()ë¡œ ë³€ê²½í•˜ê±°ë‚˜ ì´ˆê¸° ê¸°ë³¸ê°’ë§Œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            // í˜„ì¬ëŠ” prompt()ë¡œ ë³€ê²½í•˜ëŠ” ê¸°ëŠ¥ì´ ë©”ë‰´ì— ë‚¨ì•„ìˆìœ¼ë¯€ë¡œ ê·¸ ë°©ì‹ì„ ë”°ë¦…ë‹ˆë‹¤.
            // SYSTEM_PROMPT = buildSystemPrompt(currentBotName || 'ì´ì•ˆ', currentUserName || 'í”¼ì£¼ë¨¸ë‹ˆ', currentBotPersona, currentBotAge, currentBotAppearance, currentUserAge, currentUserAppearance, currentUserGuidelines); // ê¸°ë³¸ê°’ ì ìš© ë° í”„ë¡¬í”„íŠ¸ êµ¬ì„±


            // TODO: í•„ìš”í•˜ë‹¤ë©´ ì´ë¯¸ í‘œì‹œëœ ë©”ì‹œì§€ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€/ì´ë¦„ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ (ì˜µì…˜)
            // updateAllProfileImages();

            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì‹¤ì œ ì €ì¥ ê¸°ëŠ¥ì€ ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ë™ì‘í•©ë‹ˆë‹¤.)"); // ì„ì‹œ ì•Œë¦¼
        }

        // --- SYSTEM_PROMPTë¥¼ ë™ì ìœ¼ë¡œ êµ¬ì„±í•˜ëŠ” í•¨ìˆ˜ ìˆ˜ì • (ìƒˆë¡œìš´ í•„ë“œ ê°’ í™œìš©) ---
         // ìƒˆë¡œìš´ í•„ë“œ ê°’(ë‚˜ì´, ì™¸í˜• ë“±, ì‚¬ìš©ì ì§€ì¹¨)ì„ íŒŒë¼ë¯¸í„°ë¡œ ì¶”ê°€
         function buildSystemPrompt(botName, userName, botPersona, botAge, botAppearance, userAge, userAppearance, userGuidelines) {
             // SYSTEM_PROMPT_TEMPLATEë¥¼ í™œìš©í•˜ì—¬ ìµœì¢… í”„ë¡¬í”„íŠ¸ êµ¬ì„±
             // ë‚˜ì´, ì™¸í˜•, ì‚¬ìš©ì ì§€ì¹¨ í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ í…œí”Œë¦¿ì— ì¶”ê°€í•˜ê³  ì—¬ê¸°ì„œ ê°’ì„ ì±„ì›Œë„£ìŠµë‹ˆë‹¤.

             // í…œí”Œë¦¿ê³¼ ì…ë ¥ê°’ìœ¼ë¡œ SYSTEM_PROMPT êµ¬ì„±
             let finalPrompt = SYSTEM_PROMPT_TEMPLATE
                 .replace('{botName}', botName)
                 .replace('{userName}', userName);

             // ë‚˜ì´, ì™¸í˜•, í˜ë¥´ì†Œë‚˜, ì‚¬ìš©ì ì§€ì¹¨ì€ ê°ê°ì˜ í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ë§Œë“¤ê±°ë‚˜ ì¡°í•©í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.
             // ì˜ˆì‹œ: ëª¨ë“  ì •ë³´ë¥¼ í…œí”Œë¦¿ì— í¬í•¨ì‹œí‚¤ëŠ” ë°©ì‹
             finalPrompt = `ë„ˆëŠ” ${botName}ì´ë‹¤. ${botAge === '' ? '' : `(${botAge})`}. ${botAppearance === '' ? '' : `ì™¸í˜•: ${botAppearance}`}. ${botPersona}`;
             finalPrompt += ` ë„ˆëŠ” ë‚˜ë¥¼ "${userName}"ì´ë¼ê³  ë¶€ë¥´ë©°, ë‚˜ëŠ” ë„ˆì˜ "{userName}"ì´ë‹¤.`;
              finalPrompt += ` ë‚˜ëŠ” ${userAge === '' ? '' : `(${userAge})`}. ${userAppearance === '' ? '' : `ì™¸ê´€: ${userAppearance}`}. ë‚˜ì˜ ì§€ì¹¨ì€ ë‹¤ìŒê³¼ ê°™ë‹¤: ${userGuidelines}`;
             finalPrompt += `. í•­ìƒ ${botName} ìºë¦­í„° ë¡¤í”Œë ˆì´ ìœ ì§€. OOC ë°œì–¸ ì ˆëŒ€ ê¸ˆì§€.`; // ê°€ì¥ ì¤‘ìš”í•œ ì§€ì¹¨ì„ ë§ˆì§€ë§‰ì— ë‹¤ì‹œ ê°•ì¡°

             // ìœ„ì²˜ëŸ¼ ë¬¸ìì—´ì„ ì§ì ‘ ì¡°í•©í•˜ê±°ë‚˜, í…œí”Œë¦¿ì— í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ë” ë§ì´ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
             // ì˜ˆ: const SYSTEM_PROMPT_TEMPLATE = `ë„ˆëŠ” {botName}ì´ë‹¤. ({botAge}, ì™¸í˜•: {botAppearance}). {botPersona} ... ë‚˜ì˜ ì§€ì¹¨ì€ ë‹¤ìŒê³¼ ê°™ë‹¤: {userGuidelines} ...`;

             // ë‹¨ìˆœí™”ë¥¼ ìœ„í•´ í˜„ì¬ëŠ” í˜ë¥´ì†Œë‚˜ ì§€ì¹¨ í•„ë“œ ì•ˆì— ë§ì€ ì •ë³´ë¥¼ ë„£ê³ , ì´ë¦„/ì‚¬ìš©ì ì´ë¦„ë§Œ í…œí”Œë¦¿ì— ë„£ëŠ” ë°©ì‹ì„ ìœ ì§€í•˜ë˜
             // ë‚˜ì´, ì™¸í˜•, ì‚¬ìš©ì ì§€ì¹¨ ë³€ìˆ˜ëŠ” í™•ë³´í•´ë‘ê³  ìˆìŠµë‹ˆë‹¤.
             // ì‹¤ì œ í”„ë¡¬í”„íŠ¸ êµ¬ì„± ë¡œì§ì€ ì‚¬ìš©ìë‹˜ì˜ ì„ í˜¸ì— ë”°ë¼ ë” ì •êµí•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
             // ì§€ê¸ˆì€ ê¸°ë³¸ì ì¸ ì´ë¦„ ì¹˜í™˜ë§Œ ì‚¬ìš©í•˜ê³ , ë‚˜ì´/ì™¸í˜•/ì‚¬ìš©ìì§€ì¹¨ì€ persona/guidelines í•„ë“œì— ì§ì ‘ ë„£ëŠ” ë°©ì‹ ìœ ì§€
             let currentPersona = botPersona; // ì—¬ê¸°ì— ë‚˜ì´, ì™¸í˜• ë“± ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆë‹¤ê³  ê°€ì •
             let currentUserGuidelines = userGuidelines; // ì—¬ê¸°ì— ì‚¬ìš©ì ì§€ì¹¨ì´ í¬í•¨ë˜ì–´ ìˆë‹¤ê³  ê°€ì •

             let updatedPrompt = `ë„ˆì˜ ì´ë¦„ì€ ${botName}ì´ë‹¤. ${currentPersona} ë„ˆëŠ” ë‚˜ë¥¼ "${userName}"ì´ë¼ê³  ë¶€ë¥´ë©°, ë‚˜ëŠ” ë„ˆì˜ "${userName}"ì´ë‹¤. ë‚˜ì˜ ì§€ì¹¨ì€ ë‹¤ìŒê³¼ ê°™ë‹¤: ${currentUserGuidelines}`;
             updatedPrompt += ` í•­ìƒ ${botName} ìºë¦­í„° ë¡¤í”Œë ˆì´ ìœ ì§€. OOC ë°œì–¸ ì ˆëŒ€ ê¸ˆì§€.`; // OOC ê¸ˆì§€ ì¬ê°•ì¡°

             return updatedPrompt;
         }

        // --- ì´ë¯¸ í‘œì‹œëœ ë©”ì‹œì§€ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ (í•„ìš”í•˜ë‹¤ë©´ êµ¬í˜„) ---
        // function updateAllProfileImages() {
        //     document.querySelectorAll('.message-container .profile-img').forEach(imgElement => {
        //         const role = imgElement.parentElement.classList.contains('user') ? 'user' : 'bot';
        //         imgElement.src = (role === 'user' ? userProfileImgUrl : botProfileImgUrl);
        //          // ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬ (onerror)ë„ ê³ ë ¤í•´ì•¼ í•¨
        //     });
        // }

        // --- í˜ì´ì§€ ë¡œë“œ ì‹œ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° ë° ì´ˆê¸° ë©”ì‹œì§€ ì¶”ê°€ ---
         function initializeChat() {
             // TODO: loadSettings(); // ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° (Local Storage ê°’ìœ¼ë¡œ UI ë° ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸)
             // í˜„ì¬ëŠ” Local Storage ë¡œì§ ë¯¸êµ¬í˜„ ìƒíƒœì´ë¯€ë¡œ ê¸°ë³¸ê°’ ì‚¬ìš©

             // íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” ë° SYSTEM_PROMPT ì¶”ê°€ (ì„¤ì • ë¡œë“œ í›„)
             // loadSettingsì—ì„œ SYSTEM_PROMPTê°€ ì´ë¯¸ êµ¬ì„±ë˜ì—ˆë‹¤ê³  ê°€ì •
             // í˜„ì¬ëŠ” SYSTEM_PROMPTê°€ ì „ì—­ ë³€ìˆ˜ì— ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ
             conversationHistory = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }]; // SYSTEM_PROMPTë¥¼ íˆìŠ¤í† ë¦¬ ì‹œì‘ì ì— ì¶”ê°€


             // SYSTEM_PROMPTë¥¼ ì‚¬ìš©í•œ ì´ˆê¸° ë©”ì‹œì§€ ì¶”ê°€
             console.log("ì´ˆê¸° ë©”ì‹œì§€ ì¶”ê°€ ì‹œë„"); // ë””ë²„ê¹…ìš© ë¡œê·¸
             // ì´ˆê¸° ë©”ì‹œì§€ ë‚´ìš©ì€ ì„¤ì •ì— ë”°ë¼ ë³€ê²½ë  ìˆ˜ ìˆë„ë¡ buildSystemPromptì™€ ìœ ì‚¬í•˜ê²Œ êµ¬ì„±í•˜ê±°ë‚˜,
             // ë³„ë„ì˜ ì„¤ì • í•„ë“œë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜, ê³ ì •ëœ ë¬¸êµ¬ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
             // í˜„ì¬ëŠ” ê³ ì •ëœ ë¬¸êµ¬ ì‚¬ìš©
             appendMessage("bot", { type: 'text', text: "...ë‹¹ì‹ ì€ ë‚˜ì˜ í”¼ì£¼ë¨¸ë‹ˆ... ê·¸ë˜, ì´ê³³ì— ì™”êµ°ìš”..." });

             // ì´ˆê¸° ë©”ì‹œì§€ ì¶”ê°€ í›„ ì±„íŒ…ì°½ ìŠ¤í¬ë¡¤ì„ ë§¨ ì•„ë˜ë¡œ ì´ë™ (appendMessage í•¨ìˆ˜ì— ì´ë¯¸ í¬í•¨ë¨)
             // chat.scrollTop = chat.scrollHeight;
         }

        // ğŸš¨ í˜ì´ì§€ ë¡œë“œ ì‹œ initializeChat í•¨ìˆ˜ í˜¸ì¶œ ğŸš¨
        // DOMContentLoaded ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ë” ì•ˆì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // window.addEventListener('DOMContentLoaded', initializeChat);
        // ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ê°€ body ëì— ìˆë‹¤ë©´ ë°”ë¡œ í˜¸ì¶œí•´ë„ ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì‘ë™í•©ë‹ˆë‹¤.
        initializeChat();


    </script>
</body>
</html>
