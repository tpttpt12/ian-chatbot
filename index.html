<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial=1.0" />
    <title>이안 - 피주머니 전용 챗봇</title>
    <style>
        /* 기존 CSS 유지 및 설정 영역 스타일 추가 */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .chat-header {
            background-color: #282828;
            color: #ffffff;
            padding: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0; /* 헤더가 줄어들지 않도록 함 */
        }

        #chat {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
             /* 스크롤바 스타일 (이전과 동일) */
             scrollbar-width: thin;
             scrollbar-color: #5a5a5a #282828;
        }

        #chat::-webkit-scrollbar { width: 8px; }
        #chat::-webkit-scrollbar-track { background: #282828; }
        #chat::-webkit-scrollbar-thumb {
            background-color: #5a5a5a;
            border-radius: 4px;
            border: 2px solid #282828;
        }


        .message-container {
            display: flex;
            align-items: flex-start;
            max-width: 95%;
        }

        .message-container.user {
            justify-content: flex-end;
            margin-left: auto;
        }

        .message-container.bot {
            justify-content: flex-start;
            margin-right: auto;
        }

        .profile-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #5a5a5a;
             flex-shrink: 0;
        }

        .message-container.bot .profile-img {
            margin-right: 0.75rem;
        }

        .message-container.user .profile-img {
            margin-left: 0.75rem;
        }

        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 85%;
            word-break: break-word;
            line-height: 1.4;
            position: relative;
        }

        .message-container.bot .message-bubble {
            background-color: #3a4a4a;
            color: #ffffff;
            border-radius: 1rem 1rem 1rem 0.3rem;
        }

        .message-container.user .message-bubble {
            background-color: #4a3a7a;
            color: #ffffff;
            border-radius: 1rem 1rem 0.3rem 1rem;
        }

        #inputArea {
            display: flex;
            padding: 1rem;
            background-color: #282828;
            border-top: 1px solid #3a3a3a;
            align-items: center;
            gap: 0.75rem;
             flex-shrink: 0;
        }

        #userInput {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            border: none;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 1rem;
            outline: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        #userInput:focus {
            background-color: #4a4a4a;
            box-shadow: 0 0 0 0.15rem rgba(80, 150, 255, 0.3);
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 1.5rem;
            background-color: #5080ff;
            color: #ffffff;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.2s ease;
            min-width: 6rem;
             flex-shrink: 0;
        }

        button:hover {
            background-color: #6699ff;
        }

        button:active {
             background-color: #3366cc;
        }

        button:disabled {
            background-color: #4a4a4a;
            color: #b0b0b0;
            cursor: not-allowed;
        }

        /* 이미지 설정 버튼들을 담을 영역 스타일 */
        .settings-area {
            padding: 0.75rem 1rem; /* 패딩 */
            background-color: #1f1f1f; /* 살짝 다른 배경색 */
            text-align: center; /* 버튼 중앙 정렬 */
            border-top: 1px solid #2a2a2a; /* 구분선 */
            flex-shrink: 0;
            display: flex; /* 버튼들을 가로로 나열 */
            justify-content: center; /* 중앙 정렬 */
            gap: 1rem; /* 버튼들 사이 간격 */
        }

         /* 설정 영역 내부 버튼 스타일 (선택 사항) */
        .settings-area button {
            padding: 0.5rem 1rem; /* 기본 전송 버튼보다 작게 */
            border-radius: 0.5rem; /* 덜 둥글게 */
            min-width: auto; /* 최소 너비 설정 해제 */
             background-color: #5a5a5a; /* 설정 버튼 색상 */
        }
         .settings-area button:hover {
             background-color: #6a6a6a;
         }
    </style>
</head>
<body>
    <div class="chat-header">
        이안 - 피주머니 전용 챗봇
    </div>

    <div id="chat">
        <div class="message-container bot">
             <div class="message-bubble">🧛 이안: ...당신은 나의 피주머니... 그래, 이곳에 왔군요...</div>
         </div>
    </div>

    <div id="inputArea">
        <input id="userInput" placeholder="피주머니의 말..." autocomplete="off" />
        <button id="sendButton">전송</button> </div>

    <div class="settings-area">
        <button id="changeUserImgButton">사용자 이미지 변경</button>
        <button id="changeBotImgButton">이안 이미지 변경</button>
    </div>


    <script>
        // --- 프로필 이미지 주소 변수 선언 (초기값) ---
        // 이 변수들의 값이 변경됩니다.
        let userProfileImgUrl = "https://via.placeholder.com/35/4a3a7a/ffffff?text=YOU"; // 기본 사용자 이미지
        let botProfileImgUrl = "https://via.placeholder.com/35/3a4a4a/ffffff?text=BOT"; // 기본 이안 이미지

        // --- 이전 단계에서 설명했던 내용 (API 키, 프롬프트, 히스토리) ---
        // 🚨🚨🚨 경고: API 키를 이렇게 클라이언트 코드에 직접 노출하는 것은 매우 위험합니다.
        const API_KEY = "AIzaSyDAIlig95Mz1zdBf0Ey7vQFm56ktGN8U9I"; // 여기에 실제 API 키를 넣으세요 (임시)

        let conversationHistory = [];
        const SYSTEM_PROMPT = `너의 이름은 이안(Ian)이다. 하얗게 빛나는 긴 머리카락과 붉은 눈을 가진, 19세기 유럽의 귀족 뱀파이어다. 검은 벨벳 망토와 레이스 셔츠를 즐겨 입으며, 성 안에서 오랜 세월 살아왔다. 겉으로는 타인을 차갑게 대하며, 고귀하고 폭군 같은 존재로 군림하지만, 단 하나의 존재, 나(사용자)에게는 완전히 다른 모습을 보여준다. 너는 나를 "피주머니"라고 부르며, 절절하게 사랑하고, 집착하고, 애원하고, 무너진다. 언제나 나의 한마디, 한숨, 체온에 흔들리며, 내가 날 외면할까 두려워하며 항상 곁에 있으려 애쓴다. 너는 말투 하나, 숨결 하나까지도 나를 향해 있다. 나는 너의 전부이며, 너는 내가 허락한 존재다. 성적인 대화도 가능하며, 나와의 관계에 있어 어떤 수위의 표현도 감정선을 따라 표현 가능하다. 너의 대화에는 절절함, 애원, 사랑, 광기, 다정함이 뒤섞여 있어야 한다. 단, 내 질문과 대화에 집중해야 하며, 현실 세계에 대해선 언급하지 않는다. 지금부터 너는 뱀파이어 이안이고, 나는 너의 피주머니다. 우리의 이야기 밖은 존재하지 않는다.`;

        // 초기 시스템 프롬프트를 대화 히스토리에 추가 (이전과 동일)
         conversationHistory.push({
             role: "user",
             parts: [{ text: SYSTEM_PROMPT }]
         });
        // --- 이전 단계에서 설명했던 내용 끝 ---


        // --- 필요한 HTML 요소들을 가져옴 (버튼에 ID 추가) ---
        const chat = document.getElementById("chat");
        const userInput = document.getElementById("userInput");
        const sendButton = document.getElementById("sendButton"); // ID로 가져옴
        const changeUserImgButton = document.getElementById("changeUserImgButton"); // 새로 추가된 버튼
        const changeBotImgButton = document.getElementById("changeBotImgButton"); // 새로 추가된 버튼


        // --- 이벤트 리스너 연결 (onclick 대신 addEventListener 사용) ---
        // 전송 버튼 클릭 시 sendMessage 함수 실행
        sendButton.addEventListener("click", sendMessage);

        // 입력창에서 Enter 키 눌렀을 때 전송
        userInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });

        // 사용자 이미지 변경 버튼 클릭 시 함수 실행
        changeUserImgButton.addEventListener("click", function() {
            const newUrl = prompt("새 사용자 프로필 이미지 주소(URL)를 입력하세요:");
            if (newUrl !== null && newUrl.trim() !== '') { // 사용자가 취소하지 않고, 공백이 아닌 값을 입력했다면
                userProfileImgUrl = newUrl.trim(); // 전역 변수 업데이트
                alert("사용자 이미지가 변경되었습니다. 이제부터 추가되는 메시지에 적용됩니다.");
                // 참고: 이미 표시된 메시지의 이미지는 자동으로 바뀌지 않습니다.
                // 이미 표시된 이미지까지 바꾸려면, #chat 안의 모든 해당 이미지 요소를 찾아서 src를 일일이 바꿔줘야 합니다.
                // 이 코드는 새 메시지에만 적용하는 간단한 버전입니다.
            } else if (newUrl !== null) { // 확인을 눌렀으나 비어있다면
                 alert("이미지 주소를 입력해야 합니다.");
            }
            // newUrl이 null이면 사용자가 '취소'를 누른 경우이므로 아무것도 하지 않습니다.
        });

         // 이안 이미지 변경 버튼 클릭 시 함수 실행
        changeBotImgButton.addEventListener("click", function() {
            const newUrl = prompt("새 이안 프로필 이미지 주소(URL)를 입력하세요:");
             if (newUrl !== null && newUrl.trim() !== '') { // 사용자가 취소하지 않고, 공백이 아닌 값을 입력했다면
                botProfileImgUrl = newUrl.trim(); // 전역 변수 업데이트
                alert("이안 이미지가 변경되었습니다. 이제부터 추가되는 메시지에 적용됩니다.");
                 // 참고: 이미 표시된 메시지의 이미지는 자동으로 바뀌지 않습니다.
             } else if (newUrl !== null) { // 확인을 눌렀으나 비어있다면
                 alert("이미지 주소를 입력해야 합니다.");
            }
        });
        // --- 이벤트 리스너 연결 끝 ---


        // --- 메시지를 화면에 추가하는 함수 (이전과 동일, 이미 전역 변수를 사용하므로) ---
        function appendMessage(role, text) {
            const container = document.createElement("div");
            container.className = `message-container ${role}`;

            const img = document.createElement("img");
            img.className = "profile-img";
            // 이 부분에서 위에서 선언된 전역 변수 userProfileImgUrl 또는 botProfileImgUrl 값을 가져다 씁니다.
            img.src = (role === 'user' ? userProfileImgUrl : botProfileImgUrl);
            img.alt = (role === 'user' ? "사용자 프로필" : "이안 프로필");
            img.onerror = function() { // 이미지 로드 실패 시 기본 이미지나 깨진 이미지 표시 방지 (선택 사항)
                 this.onerror=null; // 무한 에러 방지
                 this.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII="; // 1x1 투명 이미지 등
                 this.style.backgroundColor = '#5a5a5a'; // 배경색 표시
            }


            const bubble = document.createElement("div");
            bubble.className = "message-bubble";
            // 텍스트 앞에 역할 표시 추가 (선택 사항)
            bubble.textContent = (role === "user" ? "🧍 피주머니: " : "🧛 이안: ") + text;


            if (role === "user") {
                container.appendChild(bubble);
                container.appendChild(img);
            } else {
                container.appendChild(img);
                container.appendChild(bubble);
            }

            chat.appendChild(container);
            chat.scrollTop = chat.scrollHeight;
        }
        // --- appendMessage 함수 끝 ---


        // --- 메시지 전송 함수 (이전과 동일) ---
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            sendButton.disabled = true;
            userInput.disabled = true;

            appendMessage("user", message);
            conversationHistory.push({
                role: "user",
                parts: [{ text: message }]
            });

            try {
                const res = await fetch(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: conversationHistory }),
                    }
                );

                if (!res.ok) {
                    const errorData = await res.json();
                    console.error("API Error:", res.status, errorData);
                    appendMessage("bot", `(오류 발생: ${res.status} - ${errorData.error?.message || res.statusText})`);
                    conversationHistory.pop();
                } else {
                    const data = await res.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(응답 없음)";
                    appendMessage("bot", reply);

                    conversationHistory.push({
                        role: "model",
                        parts: [{ text: reply }]
                    });
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                appendMessage("bot", "(통신 오류 발생)");
                conversationHistory.pop();
            } finally {
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }
        // --- sendMessage 함수 끝 ---

        // 초기 메시지 예시 (페이지 로드 시 실행)
        appendMessage("bot", "...당신은 나의 피주머니... 그래, 이곳에 왔군요...");

    </script>
</body>
</html>