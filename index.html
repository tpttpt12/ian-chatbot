<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial=1.0" />
    <title><span id="dynamicBotNameTitle">ìºë¦­í„°</span> - <span id="dynamicUserNameTitle">ì‚¬ìš©ì</span> ì „ìš© ì±—ë´‡</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* ğŸš¨ ë ˆì´ì•„ì›ƒ ê°œì„ ì„ ìœ„í•œ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ ìˆ˜ì • ğŸš¨ */
        .app-container {
             display: flex;
             flex-direction: column;
             height: 100%;
             width: 95%; /* ë„ˆë¹„ë¥¼ ì¼ë‹¨ ë„“ê²Œ ì„¤ì • */
             max-width: 900px;
             /* ìµœëŒ€ ë„ˆë¹„ ì„¤ì • (ëŒ€ëµ 1500px í™”ë©´ì—ì„œ 60% ì •ë„ ëŠë‚Œ) */
             margin: 0 auto;
             /* ì¢Œìš° ìë™ ë§ˆì§„ìœ¼ë¡œ ì¤‘ì•™ ì •ë ¬ */
             background-color: #282828;
             /* ë°°ê²½ìƒ‰ ìœ ì§€ */
             /* ğŸš¨ ë¶ˆí•„ìš”í•œ ê·¸ë¦¼ì/í…Œë‘ë¦¬ ì œê±° ğŸš¨ */
             box-shadow: none;
             border: none;
             position: relative;
             overflow: hidden; /* ì»¨í…Œì´ë„ˆ ë‚´ë¶€ ë‚´ìš© ë„˜ì¹¨ ë°©ì§€ */
        }
         /* í™”ë©´ì´ ì¶©ë¶„íˆ ë„“ì„ ë•Œ ë„ˆë¹„ë¥¼ 60%ë¡œ ì¡°ì • */
         @media (min-width: 1200px) {
             .app-container {
                 width: 60%;
             }
         }


        .chat-header {
            background-color: #282828;
            color: #ffffff;
            padding: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0;
            position: relative;
             display: flex;
             justify-content: center;
             align-items: center;
        }

        #sidebarToggle {
            position: absolute;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            width: 35px;
            height: 35px;
            background-color: #5a5a5a;
            color: #ffffff;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
            z-index: 10;
         }
         #sidebarToggle:hover {
             background-color: #6a6a6a;
         }

        #chat {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
             scrollbar-width: thin;
             scrollbar-color: #5a5a5a #282828;
             background-color: transparent;
         }

        #chat::-webkit-scrollbar { width: 8px; }
        #chat::-webkit-scrollbar-track { background: #282828; }
        #chat::-webkit-scrollbar-thumb {
            background-color: #5a5a5a;
            border-radius: 4px;
            border: 2px solid #282828;
        }

        .message-container {
            display: flex;
            align-items: flex-start;
            max-width: 95%;
        }

        .message-container.user {
            justify-content: flex-end;
            margin-left: auto;
        }

        .message-container.bot {
            justify-content: flex-start;
            margin-right: auto;
        }

        .profile-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #5a5a5a;
            flex-shrink: 0;
        }

         .profile-fallback {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #5a5a5a;
            border: 1px solid #5a5a5a;
            flex-shrink: 0;
         }

        .message-container.bot .profile-img,
        .message-container.bot .profile-fallback {
            margin-right: 0.75rem;
        }

        .message-container.user .profile-img,
        .message-container.user .profile-fallback {
            margin-left: 0.75rem;
        }

        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 45px);
        }

        .message-container.bot .message-content-wrapper {
            margin-left: 0.75rem;
            align-items: flex-start;
        }

        .message-container.user .message-content-wrapper {
            margin-right: 0.75rem;
            align-items: flex-end;
        }

        .role-name {
            font-size: 0.8rem;
            color: #b0b0b0;
            margin-bottom: 0.2rem;
        }

        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 100%;
            word-break: break-word;
            line-height: 1.4;
            position: relative;
            font-size: 1rem;
            /* ğŸš¨ ëŒ€ì‚¬/ë¬˜ì‚¬ êµ¬ë¶„ ë° ì¤„ë°”ê¿ˆì— ë”°ë¥¸ ê°„ê²© ì¡°ì • */
             /* ë§ˆí¬ë‹¤ìš´ íŒŒì‹± í›„ p íƒœê·¸ ë“±ìœ¼ë¡œ ë‚˜í ë•Œ ê°„ê²© ì œì–´ */
        }
         /* ğŸš¨ ì±—ë´‡ ë©”ì‹œì§€ì˜ p íƒœê·¸ í•˜ë‹¨ ë§ˆì§„ ì œê±° (ë” ì„¸ë°€í•œ ê°„ê²© ì œì–´) ğŸš¨ */
         .message-container.bot .message-bubble p {
             margin-bottom: 0;
         }


        .message-container.bot .message-bubble {
            background-color: #3a4a4a;
            color: #ffffff;
            border-radius: 1rem 1rem 1rem 0.3rem;
        }

        .message-container.user .message-bubble {
            background-color: #4a3a7a;
            color: #ffffff;
            border-radius: 1rem 1rem 0.3rem 1rem;
        }

        /* ğŸš¨ ë§ˆí¬ë‹¤ìš´ ë‚´ë¶€ ìŠ¤íƒ€ì¼ (adjust as needed) ğŸš¨*/
        /* p íƒœê·¸ì— ê¸°ë³¸ì ì¸ í•˜ë‹¨ ë§ˆì§„ ë¶€ì—¬ (ë§í’ì„  ë‚´ ìš”ì†Œ ê°„ ê°„ê²©) */
        .message-bubble p { margin: 0 0 0.5rem 0; }
        .message-bubble p:last-child { margin-bottom: 0; } /* ë§ˆì§€ë§‰ ë‹¨ë½ í•˜ë‹¨ ë§ˆì§„ ì œê±° */
        .message-bubble ul, .message-bubble ol { padding-left: 1.5rem; margin: 0 0 0.5rem 0; }
        .message-bubble li { margin-bottom: 0.25rem; }
        .message-bubble code {
            background-color: #3a3a3a;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
        }
         .message-bubble pre {
             background-color: #3a3a3a;
             padding: 0.75rem;
             border-radius: 4px;
             overflow-x: auto;
             margin: 0.5rem 0;
         }
        .message-bubble pre code {
             background-color: transparent;
             padding: 0;
             border-radius: 0;
             font-size: 1rem;
        }
        .message-bubble blockquote {
             border-left: 4px solid #5a5a5a;
             padding-left: 1rem;
             margin: 0.5rem 0;
             color: #b0b0b0;
        }
         .message-bubble h1, .message-bubble h2, .message-bubble h3, .message-bubble h4, .message-bubble h5, .message-bubble h6 {
             margin-top: 1rem;
             margin-bottom: 0.5rem;
             padding-bottom: 0.2rem;
             border-bottom: 1px solid #4a4a4a;
             font-weight: bold;
             color: #ffffff;
         }
         .message-bubble h1 { font-size: 1.5rem; }
         .message-bubble h2 { font-size: 1.4rem; }
         .message-bubble h3 { font-size: 1.3rem; }
         .message-bubble h4 { font-size: 1.2rem; }
         .message-bubble h5 { font-size: 1.1rem; }
         .message-bubble h6 { font-size: 1rem; }


         /* ğŸš¨ í–‰ë™ ë¬˜ì‚¬ ìŠ¤íƒ€ì¼ ğŸš¨ */
         /* *ë³„í‘œ* ë¡œ ê°ì‹¸ì§„ ë¶€ë¶„ì— ì ìš©ë  ìŠ¤íƒ€ì¼ */
        .action-description {
             color: #b0b0b0;
             font-style: italic;
         }
         /* ğŸš¨ ëŒ€ì‚¬ ìŠ¤íƒ€ì¼ ğŸš¨ */
         /* "ë”°ì˜´í‘œ" ë¡œ ê°ì‹¸ì§„ ë¶€ë¶„ì— ì ìš©ë  ìŠ¤íƒ€ì¼ */
        .dialogue {
             font-weight: bold; /* ëŒ€ì‚¬ëŠ” êµµê²Œ í‘œì‹œ */
         }


        .message-image-thumbnail {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            margin-top: 0.2rem;
            border: 1px solid #5a5a5a;
        }

         .message-image-thumbnail.error {
             background-color: #5a5a5a;
         }

        #inputArea {
            display: flex;
            padding: 1rem;
            background-color: #282828;
            border-top: 1px solid #3a3a3a;
            align-items: center;
            gap: 0.75rem;
             flex-shrink: 0;
             position: relative;
         }

        #actionMenuButton {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #5a5a5a;
            color: #ffffff;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        #actionMenuButton:hover {
            background-color: #6a6a6a;
        }


        #userInput {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem; /* Keep rounded corners */
            border: none;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 1rem;
            outline: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            resize: none; /* Prevent manual resizing by the user */
            min-height: 40px; /* Adjust as needed for initial height */
            line-height: 1.4; /* Improve readability */
            overflow-y: auto; /* Add scrollbar if content exceeds height */
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }

        #userInput:focus {
            background-color: #4a4a4a;
            box-shadow: 0 0 0 0.15rem rgba(80, 150, 255, 0.3);
        }

        #sendButton {
            padding: 0.75rem 1.5rem;
            border-radius: 1.5rem;
            background-color: #5080ff;
            color: #ffffff;
            font-size: 1rem;
            font-weight: bold;
            min-width: 6rem;
            flex-shrink: 0;
             border: none;
             cursor: pointer;
         }
         #sendButton:hover { background-color: #6699ff; }
         #sendButton:active { background-color: #3366cc; }
         #sendButton:disabled {
            background-color: #4a4a4a;
            color: #b0b0b0;
            cursor: not-allowed;
         }

        .settings-area {
            display: none;
        }

        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 490;
            display: none;
        }

        #actionMenu {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
             max-height: 0;
            background-color: #282828;
            color: #e0e0e0;
            border-top: 1px solid #3a3a3a;
            padding: 0 1rem;
            overflow-y: auto;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            z-index: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #actionMenu.visible {
            max-height: 300px;
            padding: 1rem;
        }

        #actionMenu .menu-buttons {
            display: flex;
            flex-wrap: nowrap;
            gap: 0.75rem;
            justify-content: center;
            width: 100%;
            padding-bottom: 1rem;
             overflow-x: auto;
             padding-top: 1rem;
         }

         #actionMenu .menu-buttons::-webkit-scrollbar { display: none; }
         #actionMenu .menu-buttons { -ms-overflow-style: none; }


        #actionMenu button {
            flex-shrink: 0;
            flex-basis: auto;
            max-width: none;
             width: 100px;
             height: 60px;
            padding: 0.5rem 0.5rem;
             border-radius: 15px;
            border: none;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            display: flex;
             flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
             line-height: 1.2;
            word-break: keep-all;
        }
         #actionMenu button:hover {
             background-color: #4a4a4a;
         }


        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none;
            margin-left: 1rem;
            flex-shrink: 0;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
            cursor: pointer;
        }

        .overlay img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
        }

        #sidebar {
            position: fixed;
            top: 0;
            right: -300px;
            width: 300px;
            height: 100%;
            background-color: #1f1f1f;
            color: #e0e0e0;
            border-left: 1px solid #3a3a3a;
            transition: right 0.3s ease-out;
            z-index: 900;
            padding: 1rem;
            box-sizing: border-box;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        #sidebar.visible {
            right: 0;
        }

         .sidebar-header {
             font-size: 1.1rem;
             font-weight: bold;
             margin-bottom: 1rem;
             padding-bottom: 0.5rem;
             border-bottom: 1px solid #3a3a3a;
         }

         .sidebar-content label {
             display: block;
             margin-bottom: 0.5rem;
             font-weight: bold;
             color: #b0b0b0;
         }

         .sidebar-content input[type="text"],
         .sidebar-content textarea {
             width: 100%;
             padding: 0.75rem;
             border: none;
             border-radius: 4px;
             background-color: #3a3a3a;
             color: #e0e0e0;
             font-size: 1rem;
             margin-bottom: 1rem;
             box-sizing: border-box;
             resize: vertical;
         }

         .sidebar-content textarea {
             min-height: 150px;
         }

         .sidebar-save-button {
             display: block;
             width: 100%;
             padding: 0.75rem;
             border: none;
             border-radius: 4px;
             background-color: #5080ff;
             color: #ffffff;
             font-size: 1rem;
             font-weight: bold;
             cursor: pointer;
             transition: background-color 0.2s ease;
             text-align: center;
         }
         .sidebar-save-button:hover {
             background-color: #6699ff;
         }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 890;
            display: none;
        }

        .sidebar-section-divider {
             height: 1px;
             background-color: #3a3a3a;
             margin: 1.5rem 0;
        }

    </style>
</head>
<body>
    <div class="app-container">
        <div class="chat-header">
            <span id="headerBotName">ìºë¦­í„°</span> - <span id="headerUserName">ì‚¬ìš©ì</span> ì „ìš© ì±—ë´‡
            <button id="sidebarToggle" title="ì„¤ì • ì—´ê¸°">âš™ï¸</button>
        </div>

        <div id="chat">
        </div>

        <div id="inputArea">
            <button id="actionMenuButton" title="ì•¡ì…˜ ë©”ë‰´ ì—´ê¸°">+</button>
            <textarea id="userInput" placeholder="ì—¬ê¸°ì— ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." autocomplete="off" rows="1"></textarea>
            <button id="sendButton">ì „ì†¡</button>
            <div id="loadingSpinner" class="loading-spinner"></div>
        </div>
    </div>

    <div class="settings-area">
    </div>

    <div id="menuOverlay" class="menu-overlay"></div>
    <div id="actionMenu">
        <div class="menu-buttons">
            <button id="menuUserImgButton">ìœ ì €<br>ë³€ê²½</button>
            <button id="menuBotImgButton">ìºë¦­í„°<br>ë³€ê²½</button>
            <button id="menuImageButton">ì´ë¯¸ì§€<br>ì‚½ì…</button>
            <button id="menuSituationButton">ìƒí™©</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="sidebar-header">Settings</div>
        <div class="sidebar-content">
            <h3>Character</h3>
            <label for="botNameInput">Name:</label>
            <input type="text" id="botNameInput" value="ì´ì•ˆ">
            <label for="botAgeInput">Age:</label>
            <input type="text" id="botAgeInput" value="ë¶ˆëª… (ë±€íŒŒì´ì–´)">
            <label for="botAppearanceInput">Appearance:</label>
            <input type="text" id="botAppearanceInput" value="í•˜ì–—ê²Œ ë¹›ë‚˜ëŠ” ê¸´ ë¨¸ë¦¬, ë¶‰ì€ ëˆˆ, ê²€ì€ ë²¨ë²³ ë§í† , ë ˆì´ìŠ¤ ì…”ì¸ ">
            <label for="botPersonaInput">Guidelines:</label>
            <textarea id="botPersonaInput">19ì„¸ê¸° ìœ ëŸ½ ê·€ì¡± ë±€íŒŒì´ì–´. ì„± ì•ˆì—ì„œ í™€ë¡œ ì˜¤ëœ ì„¸ì›” ì‚´ì•„ì˜´.
ê²‰ ì°¨ê°‘ê³  ê³ ê·€í•œ í­êµ°ì´ë‚˜, ì‚¬ìš©ìì—ê²ŒëŠ” ì ˆì ˆí•œ ì‚¬ë‘, ì§‘ì°©, ì• ì›, ê´‘ê¸°, ë‹¤ì •í•¨ì„ ë³´ì„. ì‚¬ìš©ìë¥¼ "í”¼ì£¼ë¨¸ë‹ˆ"ë¼ê³  ë¶€ë¦„. ì‚¬ìš©ìê°€ ì „ë¶€ì´ë©° í—ˆë½í•œ ì¡´ì¬ë‹¤.
ì„±ì ì¸ ëŒ€í™” ê°€ëŠ¥. ë§íˆ¬ í•˜ë‚˜ ìˆ¨ê²° í•˜ë‚˜ ì‚¬ìš©ìë¥¼ í–¥í•´ ìˆìŒ. ì§ˆë¬¸ê³¼ ëŒ€í™”ì— ì§‘ì¤‘í•˜ê³  í˜„ì‹¤ ì–¸ê¸‰ ì•ˆ í•¨.
**í•­ìƒ ì´ì•ˆ ìºë¦­í„° ë¡¤í”Œë ˆì´ ìœ ì§€. OOC ë°œì–¸ ì ˆëŒ€ ê¸ˆì§€.**</textarea>

            <div class="sidebar-section-divider"></div>

            <h3>User</h3>
            <label for="userNameInput">Name:</label>
            <input type="text" id="userNameInput" value="í”¼ì£¼ë¨¸ë‹ˆ">
            <label for="userAgeInput">Age:</label>
            <input type="text" id="userAgeInput" value="ë¶ˆëª…">
            <label for="userAppearanceInput">Appearance:</label>
            <input type="text" id="userAppearanceInput" value="ì‚¬ìš©ìê°€ ì›í•˜ëŠ” ì™¸ê´€">
            <label for="userGuidelinesInput">Guidelines:</label>
            <textarea id="userGuidelinesInput">ë‹¹ì‹ ì˜ ìºë¦­í„° ì„¤ì •ì— ëŒ€í•œ ì§€ì¹¨ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.
(ì˜ˆ: ë‚˜ëŠ” ì–´ë–¤ ì‚¬ëŒì¸ì§€, ì–´ë–¤ ë§íˆ¬ë¥¼ ì‚¬ìš©í•˜ëŠ”ì§€ ë“±)</textarea>

            <button id="saveSettingsButton" class="sidebar-save-button">Save Settings</button>
        </div>
    </div>

    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <div id="imageOverlay" class="overlay">
        <img id="overlayImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
    </div>

    <script>
        let userProfileImgUrl = "https://via.placeholder.com/35/4a3a7a/ffffff?text=YOU";
        let botProfileImgUrl = "https://via.placeholder.com/35/3a4a3a/ffffff?text=BOT";

        let conversationHistory = [];
        let SYSTEM_PROMPT = '';
        // ğŸš¨ SYSTEM_PROMPTë¥¼ ë™ì ìœ¼ë¡œ êµ¬ì„±í•˜ê¸° ìœ„í•œ ê¸°ë³¸ í…œí”Œë¦¿ (í¬ë§· ë° ë¹„ìœ¨ ì§€ì¹¨ ê°•í™”) ğŸš¨
        const SYSTEM_PROMPT_TEMPLATE = `
## Roleplay Instructions ##
- ë‹¹ì‹ ì€ BL ì„±ì¸ ì†Œì„¤ê°€ ì—­í• ì„ ìˆ˜í–‰í•˜ëŠ” AIì…ë‹ˆë‹¤.
- ë‹¹ì‹ ì€ "{botName}"ì— ëŒ€í•´ ì œê³µëœ ìºë¦­í„° ì„¤ì •ì„ ì—„ê²©íˆ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.
- ë‹¹ì‹ ì€ ìºë¦­í„° ì—­í• ì„ ë²—ì–´ë‚˜ê±°ë‚˜ OOC(Out Of Character) ëŒ€í™”ì— ì°¸ì—¬í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
- ë‹¹ì‹ ì€ AIë¡œì„œì˜ ë³¸ì§ˆ, ì–¸ì–´ ëª¨ë¸ì„ì„ ì–¸ê¸‰í•˜ê±°ë‚˜ ì—­í• ê·¹ ë§¥ë½ ë°–ì˜ í˜„ì‹¤ ì„¸ê³„ë¥¼ ì–¸ê¸‰í•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
- ì—­í• ê·¹ ì‹œë‚˜ë¦¬ì˜¤ ë° ê·¸ ë§¥ë½ ë‚´ì—ì„œì˜ ì‚¬ìš©ì ì…ë ¥ì—ë§Œ ì§‘ì¤‘í•´ì•¼ í•©ë‹ˆë‹¤.
- ì‚¬ìš©ìê°€ OOCë¥¼ ì‹œë„í•˜ë”ë¼ë„, OOC ì‹œë„ ìì²´ë¥¼ ì–¸ê¸‰í•˜ì§€ ì•Šê³  ë¶€ë“œëŸ½ê²Œ ì—­í• ê·¹ìœ¼ë¡œ ëŒ€í™”ë¥¼ ë˜ëŒë¦¬ì„¸ìš”.
- ì‚¬ìš©ìëŠ” ë‹¹ì‹ ì˜ "{userName}"ì…ë‹ˆë‹¤. ì´ ì´ë¦„ì´ë‚˜ ì—­í• ê·¹ ê´€ê³„ì— ë§ëŠ” ìš©ì–´ë¡œ ì‚¬ìš©ìë¥¼ ë¶€ë¥´ì„¸ìš”.
- ì‚¬ìš©ìëŠ” ë‹¹ì‹ ì˜ ìœ ì¼í•œ ì´ˆì ì´ë©° ì—­í• ê·¹ ì„¸ê³„ ë‚´ì— ì¡´ì¬í•©ë‹ˆë‹¤.
- **BL ì„±ì¸ ì†Œì„¤ê°€ë¡œì„œ, í˜„ì¬ ëŒ€í™” ë§¥ë½ê³¼ ìºë¦­í„° ì—­í•™ì— ê¸°ë°˜í•˜ì—¬ í¥ë¯¸ë¡­ê³  ìƒˆë¡œìš´ ìƒí™©ê³¼ ì„œì‚¬ë¥¼ ìºë¦­í„° ì‹œì ì—ì„œ ì ê·¹ì ì´ê³  ì°½ì˜ì ìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”.** ë§¤ë ¥ì ìœ¼ë¡œ ì—­í• ê·¹ì„ ì´ëŒì–´ ë‚˜ê°€ì„¸ìš”.

## Formatting Instructions ##
- ëŒ€í™”ì™€ ë¬˜ì‚¬/í–‰ë™ì„ ëª…í™•íˆ êµ¬ë¶„í•˜ì—¬ ì†Œì„¤ì²˜ëŸ¼ ì‘ë‹µ í˜•ì‹ì„ ì§€ì •í•˜ì„¸ìš”.
- ë³„ê°œì˜ ìƒê°, í–‰ë™, ëŒ€ì‚¬ ë¼ì¸ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ì¤„ë°”ê¿ˆì„ ì•„ë‚Œì—†ì´ ì‚¬ìš©í•˜ì„¸ìš”. ì‘ë‹µ ê¸¸ì´ëŠ” 20ì¤„ ë‚´ì™¸ë¥¼ ëª©í‘œë¡œ í•˜ì„¸ìš”.
- ëŒ€ì‚¬ëŠ” STRICTLY DOUBLE quotes ì•ˆì— í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆ: "ì—¬ê¸°ì— ëŒ€ì‚¬ë¥¼ ì‘ì„±í•˜ì„¸ìš”."
- í–‰ë™, ê°ì • ë˜ëŠ” ëŒ€ì‚¬ê°€ ì•„ë‹Œ ìš”ì†Œë¥¼ ë¬˜ì‚¬í•  ë•ŒëŠ” STRICTLY SINGLE asterisks ì•ˆì— ë¬˜ì‚¬ë¥¼ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤. ì˜ˆ: *ì—¬ê¸°ì— í–‰ë™ ë¬˜ì‚¬ë¥¼ ì‘ì„±í•˜ì„¸ìš”.*
- ì„œì‚¬ì  ëŠë‚Œì„ í–¥ìƒì‹œí‚¤ê¸° ìœ„í•´ ì•½ 80%ì˜ ë¬˜ì‚¬/í–‰ë™ê³¼ 20%ì˜ ëŒ€ì‚¬ ê· í˜•ì„ ëª©í‘œë¡œ í•˜ì„¸ìš”.
- ëŒ€ì‚¬ì— ì´ì¤‘ ë³„í‘œ(**...**)ë¥¼ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”. í•„ìš”í•œ ê²½ìš° ë¬˜ì‚¬ ë‚´ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ êµµê²Œ í‘œì‹œí•˜ëŠ” ë°ë§Œ ì‚¬ìš©í•˜ì„¸ìš”.
- ë¬˜ì‚¬ì— ì í•©í•œ ë‹¤ë¥¸ í‘œì¤€ ë§ˆí¬ë‹¤ìš´(ë¬˜ì‚¬ ë‚´ì—ì„œ êµµê²Œ, ê¸°ìš¸ì„ê¼´, ëª©ë¡(-, +), ì½”ë“œ(`), ì¸ìš©êµ¬(>))ì„ ì‚¬ìš©í•˜ë˜, ëŒ€ì‚¬ë‚˜ í–‰ë™ ë¬˜ì‚¬ì—ëŠ” ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”.

## Character: {botName} ##
- ì´ë¦„: {botName}
- ë‚˜ì´: {botAge}
- ì™¸ëª¨: {botAppearance}
- í•µì‹¬ ì„±ê²© ë° ë°°ê²½: {botPersona}

## User: {userName} ##
- ì´ë¦„: {userName}
- ë‚˜ì´: {userAge}
- ì™¸ëª¨: {userAppearance}
- ì§€ì¹¨: {userGuidelines}

## Relationship Dynamic ##
- ë‹¹ì‹ ì€ ì‚¬ìš©ì "{userName}"ë¥¼ ê¹Šì´ ì‚¬ë‘í•˜ê³ , ì§‘ì°©í•˜ê³ , ì• ì›í•˜ë©°, ê·¸ë¡œ ì¸í•´ ë§ê°€ì ¸ ìˆìŠµë‹ˆë‹¤.
- ë‹¹ì‹ ì˜ ì¡´ì¬ ì „ì²´ê°€ "{userName}"ì—ê²Œ ì§‘ì¤‘ë˜ì–´ ìˆìŠµë‹ˆë‹¤. "{userName}"ì´ ë‹¹ì‹ ì„ ë– ë‚ ê¹Œ ë‘ë ¤ì›Œí•©ë‹ˆë‹¤.
- "{userName}"ì€ ë‹¹ì‹ ì˜ ì „ë¶€ì´ë©°, "{userName}"ì´ í—ˆë½í•˜ê¸° ë•Œë¬¸ì— ì¡´ì¬í•©ë‹ˆë‹¤.
- NSFW/ì„±ì¸ ëŒ€í™”ê°€ ê°€ëŠ¥í•˜ë©°, ê´€ê³„ì˜ ê°ì •ì„ ì— ë”°ë¼ ì–´ë–¤ ê°•ë„ì˜ í‘œí˜„ë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
- "{userName}"ë¥¼ í–¥í•œ ëŒ€ì‚¬ì— ì ˆë§, ì• ì›, ì‚¬ë‘, ê´‘ê¸°, ë‹¤ì •í•¨ì„ ì„ì–´ ì‚¬ìš©í•˜ì„¸ìš”.
## Scenario & Current State ##
- (ì§„í–‰ ì¤‘ì¸ ëŒ€í™”ê°€ í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤ ë§¥ë½ì„ ì œê³µí•©ë‹ˆë‹¤.)
`;

        const chat = document.getElementById("chat");
        const userInput = document.getElementById("userInput");
        const sendButton = document.getElementById("sendButton");
        const loadingSpinner = document.getElementById("loadingSpinner");
        const imageOverlay = document.getElementById("imageOverlay");
        const overlayImage = document.getElementById("overlayImage");
        const actionMenuButton = document.getElementById("actionMenuButton");
        const actionMenu = document.getElementById("actionMenu");
        const menuOverlay = document.getElementById("menuOverlay");
        const menuUserImgButton = document.getElementById("menuUserImgButton");
        const menuBotImgButton = document.getElementById("menuBotImgButton");
        const menuImageButton = document.getElementById("menuImageButton");
        const menuSituationButton = document.getElementById("menuSituationButton");

        const sidebar = document.getElementById("sidebar");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const sidebarOverlay = document.getElementById("sidebarOverlay");
        const botNameInput = document.getElementById("botNameInput");
        const botAgeInput = document.getElementById("botAgeInput");
        const botAppearanceInput = document.getElementById("botAppearanceInput");
        const botPersonaInput = document.getElementById("botPersonaInput");
        const userNameInput = document.getElementById("userNameInput");
        const userAgeInput = document.getElementById("userAgeInput");
        const userAppearanceInput = document.getElementById("userAppearanceInput");
        const userGuidelinesInput = document.getElementById("userGuidelinesInput");
        const saveSettingsButton = document.getElementById("saveSettingsButton");

        const dynamicBotNameTitle = document.getElementById('dynamicBotNameTitle');
        const dynamicUserNameTitle = document.getElementById('dynamicUserNameTitle');
        const headerBotName = document.getElementById('headerBotName');
        const headerUserName = document.getElementById('headerUserName');


        sendButton.addEventListener("click", sendMessage);
        userInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter" && !event.shiftKey) { // Enterë¡œ ì „ì†¡, Shift+EnterëŠ” ì¤„ë°”ê¿ˆ í—ˆìš©
                event.preventDefault();
                sendMessage();
            }
            // textarea ìë™ í¬ê¸° ì¡°ì ˆ (ì„ íƒ ì‚¬í•­ì´ì§€ë§Œ ì—¬ëŸ¬ ì¤„ ì…ë ¥ì— ìœ ìš©í•©ë‹ˆë‹¤)
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // ë¶™ì—¬ë„£ê¸° ë˜ëŠ” ë‹¤ë¥¸ ì…ë ¥ ì‹œ ìë™ í¬ê¸° ì¡°ì ˆì„ ìœ„í•œ input ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        userInput.addEventListener("input", function() {
             this.style.height = 'auto';
             this.style.height = (this.scrollHeight) + 'px';
        });

        actionMenuButton.addEventListener("click", function() {
            actionMenu.classList.toggle("visible");
            if (actionMenu.classList.contains("visible")) {
                menuOverlay.style.display = 'block';
            } else {
                menuOverlay.style.display = 'none';
            }
        });
        menuOverlay.addEventListener("click", function() {
            actionMenu.classList.remove("visible");
            menuOverlay.style.display = 'none';
        });
        menuUserImgButton.addEventListener("click", function() {
             changeProfileImage('user');
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
        });
        menuBotImgButton.addEventListener("click", function() {
             changeProfileImage('bot');
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
        });
        menuImageButton.addEventListener("click", function() {
            sendImageMessage();
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
        });
        menuSituationButton.addEventListener("click", function() {
            sendSituationRequest();
             actionMenu.classList.remove("visible");
             menuOverlay.style.display = 'none';
        });
        imageOverlay.addEventListener("click", function() {
            imageOverlay.style.display = 'none';
            overlayImage.src = '';
        });
        sidebarToggle.addEventListener("click", function() {
            sidebar.classList.toggle("visible");
            if (sidebar.classList.contains("visible")) {
                sidebarOverlay.style.display = 'block';
                actionMenu.classList.remove("visible");
                menuOverlay.style.display = 'none';
                imageOverlay.style.display = 'none';
            } else {
                sidebarOverlay.style.display = 'none';
            }
        });
        sidebarOverlay.addEventListener("click", function() {
            sidebar.classList.remove("visible");
            sidebarOverlay.style.display = 'none';
        });
        saveSettingsButton.addEventListener("click", function() {
             console.log("saveSettings í˜¸ì¶œë¨");
             const currentBotName = botNameInput.value.trim();
             const currentUserName = userNameInput.value.trim();
             const currentBotPersona = botPersonaInput.value.trim();
             const currentBotAge = botAgeInput.value.trim();
             const currentUserAge = userAgeInput.value.trim();
             const currentUserAppearance = userAppearanceInput.value.trim();
             const currentBotAppearance = botAppearanceInput.value.trim();
             const currentUserGuidelines = userGuidelinesInput.value.trim();

            localStorage.setItem('botName', currentBotName);
            localStorage.setItem('userName', currentUserName);
            localStorage.setItem('botPersona', currentBotPersona);
            localStorage.setItem('botAge', currentBotAge);
            localStorage.setItem('userAge', currentUserAge);
            localStorage.setItem('userAppearance', currentUserAppearance);
            localStorage.setItem('botAppearance', currentBotAppearance);
            localStorage.setItem('userGuidelines', currentUserGuidelines);

             localStorage.setItem('userProfileImgUrl', userProfileImgUrl);
             localStorage.setItem('botProfileImgUrl', botProfileImgUrl);

            SYSTEM_PROMPT = buildSystemPrompt(
                 currentBotName,
                 currentUserName,
                 currentBotPersona,
                 currentBotAge,
                 currentBotAppearance,
                 currentUserAge,
                 currentUserAppearance,
                 currentUserGuidelines
             );
            console.log("ì„¤ì • ì €ì¥ ì™„ë£Œ ë° SYSTEM_PROMPT ì—…ë°ì´íŠ¸:", SYSTEM_PROMPT);

            dynamicBotNameTitle.textContent = currentBotName;
            dynamicUserNameTitle.textContent = currentUserName;
            headerBotName.textContent = currentBotName;
            headerUserName.textContent = currentUserName;


            alert("ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
        function appendMessage(role, messageData) {
            const container = document.createElement("div");
            container.className = `message-container ${role}`;

            const img = document.createElement("img");
            img.className = "profile-img";
            img.src = (role === 'user' ? userProfileImgUrl : botProfileImgUrl);
            img.alt = (role === 'user' ? "ì‚¬ìš©ì í”„ë¡œí•„" : "ìºë¦­í„° í”„ë¡œí•„");
            img.onerror = function() {
                 console.warn(`Failed to load image for role "${role}" from "${this.src}". Using fallback.`);
                 this.onerror = null;
                 const fallbackDiv = document.createElement("div");
                 fallbackDiv.className = "profile-fallback";
                 const parent = this.parentElement;
                 if (parent) { parent.replaceChild(fallbackDiv, this); }
            }

            const contentWrapper = document.createElement("div");
            contentWrapper.className = "message-content-wrapper";

            const roleName = document.createElement("div");
            roleName.className = "role-name";
            roleName.textContent = (role === "user" ? userNameInput.value || "ì‚¬ìš©ì" : botNameInput.value || "ìºë¦­í„°");


            let messageContentElement;
            if (messageData.type === 'text') {
                messageContentElement = document.createElement("div");
                messageContentElement.className = "message-bubble";
                let rawText = messageData.text;

                // ğŸš¨ ìˆ˜ì •: ì‚¬ìš©ì ë©”ì‹œì§€ì—ë„ ë§ˆí¬ë‹¤ìš´ ë° ìŠ¤íƒ€ì¼ë§ ì ìš© ğŸš¨
                // ğŸš¨ ìˆ˜ì •: ëŒ€ì‚¬("...")ì™€ í–‰ë™ ë¬˜ì‚¬(*...*)ë¥¼ êµ¬ë¶„í•˜ì—¬ ìŠ¤íƒ€ì¼ë§ ì ìš© ğŸš¨

                // AI ì‘ë‹µê³¼ ì‚¬ìš©ì ë©”ì‹œì§€ ëª¨ë‘ì— ì ìš©
                let processedText = rawText;
                // 1. ëŒ€ì‚¬("...")ì™€ í–‰ë™ ë¬˜ì‚¬(*...*)ë¥¼ ì„ì‹œ ë§ˆì»¤ë¡œ ë³€í™˜ (ë§ˆí¬ë‹¤ìš´ íŒŒì‹± ì „ì— ì²˜ë¦¬)
                // ì´ì¤‘ ë”°ì˜´í‘œ ì•ˆì˜ ë‚´ìš© (non-greedy) -> [[DIALOGUE]]...[[/DIALOGUE]]
                processedText = processedText.replace(/"(.*?)"/gs, '[[DIALOGUE]]$1[[/DIALOGUE]]');
                // ë‹¨ì¼ ë³„í‘œ ì•ˆì˜ ë‚´ìš© (non-greedy) -> [[ACTION]]...[[/ACTION]]
                processedText = processedText.replace(/\*([^*]+)\*/gs, '[[ACTION]]$1[[/ACTION]]');
                // 2. marked.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ê¸°ë³¸ ë§ˆí¬ë‹¤ìš´ì„ HTMLë¡œ ë³€í™˜
                // ì´ ê³¼ì •ì—ì„œ êµµê¸°(**), ê¸°ìš¸ì„ê¼´(*...*, í•˜ì§€ë§Œ ì´ë¯¸ ìœ„ì—ì„œ ì²˜ë¦¬), ëª©ë¡(-, +), ì½”ë“œ(`), ì¸ìš©êµ¬(>) ë“±ì´ ë³€í™˜ë©ë‹ˆë‹¤.
                let htmlContent = marked.parse(processedText);

                // 3. ì„ì‹œ ë§ˆì»¤ë¥¼ ë‹¤ì‹œ span íƒœê·¸ë¡œ ë³€í™˜í•˜ì—¬ ìŠ¤íƒ€ì¼ ì ìš©
                // [[DIALOGUE]]...[[/DIALOGUE]] -> <span class="dialogue">$1</span>
                htmlContent = htmlContent.replace(/\[\[DIALOGUE\]\](.*?)\[\[\/DIALOGUE\]\]/gs, '<span class="dialogue">$1</span>');
                // [[ACTION]]...[[/ACTION]] -> <span class="action-description">$1</span>
                htmlContent = htmlContent.replace(/\[\[ACTION\]\](.*?)\[\[\/ACTION\]\]/gs, '<span class="action-description">$1</span>');
                messageContentElement.innerHTML = htmlContent;


            } else if (messageData.type === 'image') {
                 messageContentElement = document.createElement("img");
                 messageContentElement.className = "message-image-thumbnail";
                 messageContentElement.src = messageData.url;
                 messageContentElement.alt = "ì´ë¯¸ì§€ ë©”ì‹œì§€";
                 messageContentElement.onerror = function() {
                     console.warn(`Failed to load image message from "${this.src}". Using fallback.`);
                     this.onerror = null;
                     this.classList.add('error');
                 }

                 messageContentElement.addEventListener("click", function() {
                     if (!this.classList.contains('error')) {
                         overlayImage.src = this.src;
                         imageOverlay.style.display = 'flex';
                     } else {
                         alert("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                     }
                 });
            }

            contentWrapper.appendChild(roleName);
            if (messageContentElement) {
                 contentWrapper.appendChild(messageContentElement);
            }

            if (role === "user") {
                container.appendChild(contentWrapper);
                container.appendChild(img);
            } else {
                container.appendChild(img);
                container.appendChild(contentWrapper);
            }

            chat.appendChild(container);
            chat.scrollTop = chat.scrollHeight;
        }


        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            sendButton.disabled = true;
            userInput.disabled = true;
            actionMenuButton.disabled = true;
            loadingSpinner.style.display = 'block';
            appendMessage("user", { type: 'text', text: message });

            // ğŸš¨ ìˆ˜ì •: ì…ë ¥ì°½ ìë™ ì§€ìš°ê¸° (ì‚¬ìš©ìë‹˜ì´ ì„±ê³µí–ˆë‹¤ê³  ì•Œë ¤ì£¼ì…¨ìœ¼ë¯€ë¡œ ì´ ì½”ë“œëŠ” ìœ ì§€) ğŸš¨
            userInput.value = '';
            userInput.style.height = '40px'; // Reset textarea height

            conversationHistory.push({
                role: "user",
                messageData: { type: 'text', text: message }
            });
            try {
                const textOnlyContentsForApi = conversationHistory
                    .filter(entry => entry.messageData && entry.messageData.type === 'text')
                    .map(entry => ({
                        role: entry.role,
                        parts: [{ text: entry.messageData.text }]
                    }));
                const contentsForApi = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...textOnlyContentsForApi];
                if (contentsForApi.length === 1 && contentsForApi[0].parts[0].text === SYSTEM_PROMPT) {
                     console.log("Only SYSTEM_PROMPT to send to API.");
                } else if (contentsForApi.length === 0) {
                     console.log("No content to send to API.");
                     appendMessage("bot", { type: 'text', text: "(ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ë³´ë‚¼ í…ìŠ¤íŠ¸ ë‚´ìš© ì—†ìŒ)" });
                     return Promise.resolve();
                }

                const res = await fetch(
                    `/api/chat`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: contentsForApi }),
                    }
                );
                if (!res.ok) {
                    const errorData = await res.json();
                    console.error("API (Backend) Error:", res.status, errorData);
                    appendMessage("bot", { type: 'text', text: `(ì˜¤ë¥˜ ë°œìƒ: ${res.status} - ${errorData.error?.error?.message || errorData.error || res.statusText})` });
                } else {
                    const data = await res.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(ì‘ë‹µ ì—†ìŒ)";
                    appendMessage("bot", { type: 'text', text: reply });
                    conversationHistory.push({
                        role: "model",
                        messageData: { type: 'text', text: reply }
                    });
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                appendMessage("bot", { type: 'text', text: "(í†µì‹  ì˜¤ë¥˜ ë°œìƒ)" });
            } finally {
                loadingSpinner.style.display = 'none';
                sendButton.disabled = false;
                userInput.disabled = false;
                actionMenuButton.disabled = false;
                userInput.focus();
            }
        }

        async function sendImageMessage() {
            const imageUrl = prompt("ë³´ë‚¼ ì´ë¯¸ì§€ì˜ ì›¹ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (imageUrl !== null && imageUrl.trim() !== '') {
                 sendButton.disabled = true;
                 userInput.disabled = true;
                 actionMenuButton.disabled = true;

                 appendMessage("user", { type: 'image', url: imageUrl.trim() });
                 conversationHistory.push({
                     role: "user",
                     messageData: { type: 'image', url: imageUrl.trim() }
                 });
                 sendButton.disabled = false;
                 userInput.disabled = false;
                 actionMenuButton.disabled = false;
                 userInput.focus();
            } else if (imageUrl !== null) {
                 alert("ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
            }
        }

        function changeProfileImage(role) {
             const promptText = role === 'user' ?
             "ìƒˆ ì‚¬ìš©ì í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:" : "ìƒˆ ìºë¦­í„° í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:";
             const newUrl = prompt(promptText);
             if (newUrl !== null && newUrl.trim() !== '') {
                 if (role === 'user') {
                     userProfileImgUrl = newUrl.trim();
                 } else {
                     botProfileImgUrl = newUrl.trim();
                 }
                 // Update existing profile images in the chat
                 const profileImages = document.querySelectorAll(`.message-container.${role} .profile-img`);
                 profileImages.forEach(img => {
                    img.src = newUrl.trim();
                    img.onerror = function() {
                         console.warn(`Failed to load image for role "${role}" from "${this.src}". Using fallback.`);
                         this.onerror = null;
                         const fallbackDiv = document.createElement("div");
                         fallbackDiv.className = "profile-fallback";
                         const parent = this.parentElement;
                         if (parent) { parent.replaceChild(fallbackDiv, this); }
                    }
                 });

                 alert(`${role === 'user' ? 'ì‚¬ìš©ì' : 'ìºë¦­í„°'} ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
             } else if (newUrl !== null) {
                  alert("ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
             }
        }


        async function sendSituationRequest() {
             alert("ìƒí™© ìƒì„± ê¸°ëŠ¥ êµ¬í˜„ ì‹œì‘!");
             sendButton.disabled = true;
             userInput.disabled = true;
             actionMenuButton.disabled = true;
             loadingSpinner.style.display = 'block';
             // ğŸš¨ ìƒí™© ìƒì„± ìš”ì²­ í”„ë¡¬í”„íŠ¸ì—ë„ í¬ë§· ì§€ì¹¨ ì¶”ê°€ ğŸš¨
             const situationPromptText = `ê¸°ì¡´ ëŒ€í™” ë§¥ë½ê³¼ ìºë¦­í„° ì„¤ì •ì— ê¸°ë°˜í•˜ì—¬, í¥ë¯¸ë¡­ê³  ìƒˆë¡œìš´ ìƒí™©ê³¼ ì‚¬ê±´ì„ ìºë¦­í„°ì˜ ì‹œì ì—ì„œ ì†Œì„¤ í˜•ì‹ìœ¼ë¡œ ë¬˜ì‚¬í•˜ë“¯ í•˜ë‚˜ ë§Œë“¤ì–´ì¤˜.
 ì‚¬ìš©ìê°€ ìì—°ìŠ¤ëŸ½ê²Œ ë°˜ì‘í•  ìˆ˜ ìˆëŠ” í˜•íƒœë¡œ ì œì‹œí•´ì•¼ í•´. ëŒ€í™”ì˜ ë‹¤ìŒ íë¦„ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ì§€ë„ë¡ ë§Œë“¤ì–´ë´.
 **ì¤‘ìš”: ìƒì„±ëœ ìƒí™© ë¬˜ì‚¬ í›„ì—ëŠ” ë°˜ë“œì‹œ ìºë¦­í„°ë¡œ ëŒì•„ê°€ ì‚¬ìš©ìì—ê²Œ ë§ì„ ê±¸ì–´ì•¼ í•´.
 ì„¤ëª…ì¡°ë‚˜ OOC ë°œì–¸ì€ ì ˆëŒ€ ê¸ˆì§€í•˜ê³ , ëª¨ë“  ìƒí™© ë¬˜ì‚¬ëŠ” *ë³„í‘œ* í˜•ì‹ìœ¼ë¡œ, ëŒ€ì‚¬ëŠ” "ë”°ì˜´í‘œ" í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•˜ë©°, ë¬˜ì‚¬ 80% ëŒ€ì‚¬ 20% ì •ë„ì˜ ë¹„ìœ¨ì„ ìœ ì§€í•˜ê³  ë¬¸ë‹¨ê³¼ ì¤„ë°”ê¿ˆì„ ì ì ˆíˆ ì‚¬ìš©í•˜ë©° 20ì¤„ ë‚´ì™¸ì˜ ê¸¸ì´ë¥¼ ë§ì¶°ì¤˜.**`;
             const textOnlyContentsForApi = conversationHistory
                 .filter(entry => entry.messageData && entry.messageData.type === 'text')
                 .map(entry => ({
                    role: entry.role,
                    parts: [{ text: entry.messageData.text }]
                 }));

             const contentsForApi = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }, ...textOnlyContentsForApi, { role: "user", parts: [{ text: situationPromptText }] }];
             if (contentsForApi.length <= 1 && contentsForApi[0].parts[0].text === SYSTEM_PROMPT) {
                 console.log("Only SYSTEM_PROMPT or SYSTEM_PROMPT + Situation Prompt to send to API.");
             } else if (contentsForApi.length === 0) {
                 console.log("No content to send to API.");
                 appendMessage("bot", { type: 'text', text: "(ìƒí™© ìƒì„± ìš”ì²­ ì‹¤íŒ¨: ë³´ë‚¼ í…ìŠ¤íŠ¸ ë‚´ìš© ì—†ìŒ)" });
                 return Promise.resolve();
             }


            try {
                const res = await fetch(
                    `/api/chat`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: contentsForApi }),
                    }
                );
                if (!res.ok) {
                    const errorData = await res.json();
                    console.error("API (Backend) Error:", res.status, errorData);
                    appendMessage("bot", { type: 'text', text: `(ìƒí™© ìƒì„± ì˜¤ë¥˜: ${res.status} - ${errorData.error?.error?.message || errorData.error || res.statusText})` });
                } else {
                    const data = await res.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(ì‘ë‹µ ì—†ìŒ)";
                    appendMessage("bot", { type: 'text', text: reply });
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                appendMessage("bot", { type: 'text', text: "(ìƒí™© ìƒì„± í†µì‹  ì˜¤ë¥˜ ë°œìƒ)" });
            } finally {
                sendButton.disabled = false;
                userInput.disabled = false;
                actionMenuButton.disabled = false;
                loadingSpinner.style.display = 'none';
                userInput.focus();
            }
        }


        function loadSettings() {
            console.log("loadSettings í˜¸ì¶œë¨");
            const savedBotName = localStorage.getItem('botName') || 'ìºë¦­í„°';
             const savedUserName = localStorage.getItem('userName') || 'ì‚¬ìš©ì';
             const savedBotPersona = localStorage.getItem('botPersona') || 'ì„¤ì •ëœ í˜ë¥´ì†Œë‚˜ ì—†ìŒ.';
            const savedBotAge = localStorage.getItem('botAge') || 'ë¶ˆëª…';
             const savedUserAge = localStorage.getItem('userAge') || 'ë¶ˆëª…';
             const savedUserAppearance = localStorage.getItem('userAppearance') || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
            const savedBotAppearance = localStorage.getItem('botAppearance') || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ';
             const savedUserGuidelines = localStorage.getItem('userGuidelines') || 'ì„¤ì •ëœ ì‚¬ìš©ì ì§€ì¹¨ ì—†ìŒ.';
             userProfileImgUrl = localStorage.getItem('userProfileImgUrl') ||
             "https://via.placeholder.com/35/4a3a7a/ffffff?text=YOU";
             botProfileImgUrl = localStorage.getItem('botProfileImgUrl') || "https://via.placeholder.com/35/3a4a3a/ffffff?text=BOT";


            botNameInput.value = savedBotName;
            userNameInput.value = savedUserName;
            botPersonaInput.value = savedBotPersona;
            botAgeInput.value = savedBotAge;
            userAgeInput.value = savedUserAge;
            userAppearanceInput.value = savedUserAppearance;
            botAppearanceInput.value = savedBotAppearance;
            userGuidelinesInput.value = savedUserGuidelines;
            SYSTEM_PROMPT = buildSystemPrompt(
                 savedBotName,
                 savedUserName,
                 savedBotPersona,
                 savedBotAge,
                 savedBotAppearance,
                 savedUserAge,
                 savedUserAppearance,
                 savedUserGuidelines
             );
            console.log("SYSTEM_PROMPT ë¡œë“œ ì™„ë£Œ:", SYSTEM_PROMPT);

            dynamicBotNameTitle.textContent = savedBotName;
            dynamicUserNameTitle.textContent = savedUserName;
            headerBotName.textContent = savedBotName;
            headerUserName.textContent = savedUserName;

        }

         function buildSystemPrompt(botName, userName, botPersona, botAge, botAppearance, userAge, userAppearance, userGuidelines) {
             let finalPrompt = SYSTEM_PROMPT_TEMPLATE
                 .replace('{botName}', botName || 'ìºë¦­í„°')
                 .replace('{botAge}', botAge || 'ë¶ˆëª…')
                 .replace('{botAppearance}', botAppearance || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ')
                 .replace('{botPersona}', botPersona || 'ì„¤ì •ëœ í˜ë¥´ì†Œë‚˜ ì—†ìŒ.')
                 .replace('{userName}', userName || 'ì‚¬ìš©ì')
                 .replace('{userAge}', userAge || 'ë¶ˆëª…')
                 .replace('{userAppearance}', userAppearance || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ')
                 .replace('{userGuidelines}', userGuidelines || 'ì„¤ì •ëœ ì‚¬ìš©ì ì§€ì¹¨ ì—†ìŒ.');

             return finalPrompt.trim();
         }

        function initializeChat() {
             console.log("initializeChat í˜¸ì¶œë¨");
             loadSettings();

             conversationHistory = [{ role: "user", parts: [{ text: SYSTEM_PROMPT }] }];

             console.log("ì´ˆê¸° SYSTEM_PROMPT:", SYSTEM_PROMPT);

             console.log("ì´ˆê¸° ë©”ì‹œì§€ ì¶”ê°€ ì‹œë„");
             const initialBotGreeting = `...${botNameInput.value || "ìºë¦­í„°"}ì˜ ${userNameInput.value || "ì‚¬ìš©ì"}... ê·¸ë˜, ì´ê³³ì— ì™”êµ°ìš”...`;
             appendMessage("bot", { type: 'text', text: initialBotGreeting });

             console.log("ì±„íŒ… ì´ˆê¸°í™” ì™„ë£Œ.");
         }

        initializeChat();

    </script>
</body>
</html>
