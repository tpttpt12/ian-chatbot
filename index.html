<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial=1.0" />
    <title>ì´ì•ˆ - í”¼ì£¼ë¨¸ë‹ˆ ì „ìš© ì±—ë´‡</title>
    <style>
        /* ê¸°ì¡´ CSS ìœ ì§€ ë° ìƒˆë¡œìš´ ë ˆì´ì•„ì›ƒ, ë©”ë‰´ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .chat-header {
            background-color: #282828;
            color: #ffffff;
            padding: 1rem;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            border-bottom: 1px solid #3a3a3a;
            flex-shrink: 0;
        }

        #chat {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
             scrollbar-width: thin;
             scrollbar-color: #5a5a5a #282828;
        }

        #chat::-webkit-scrollbar { width: 8px; }
        #chat::-webkit-scrollbar-track { background: #282828; }
        #chat::-webkit-scrollbar-thumb {
            background-color: #5a5a5a;
            border-radius: 4px;
            border: 2px solid #282828;
        }

        /* --- ë©”ì‹œì§€ ì»¨í…Œì´ë„ˆ ë° ë‚´ë¶€ êµ¬ì¡° (ì´ì „ê³¼ ë™ì¼) --- */
        .message-container {
            display: flex;
            align-items: flex-start;
            max-width: 95%;
        }

        .message-container.user {
            justify-content: flex-end;
            margin-left: auto;
        }

        .message-container.bot {
            justify-content: flex-start;
            margin-right: auto;
        }

        /* í”„ë¡œí•„ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
        .profile-img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #5a5a5a;
            flex-shrink: 0;
            /* í”„ë¡œí•„ ì´ë¯¸ì§€ëŠ” í´ë¦­ ê°€ëŠ¥í•˜ì§€ ì•ŠìŒ */
        }

         /* ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´í•  íšŒìƒ‰ ë™ê·¸ë¼ë¯¸ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
        .profile-fallback {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #5a5a5a;
            border: 1px solid #5a5a5a;
            flex-shrink: 0;
        }

        /* ì´ë¯¸ì§€/ëŒ€ì²´ ìš”ì†Œì™€ ë©”ì‹œì§€ ë‚´ìš© ë˜í¼ ê°„ ê°„ê²© */
        .message-container.bot .profile-img,
        .message-container.bot .profile-fallback {
            margin-right: 0.75rem;
        }

        .message-container.user .profile-img,
        .message-container.user .profile-fallback {
            margin-left: 0.75rem;
        }

        /* ë©”ì‹œì§€ ë‚´ìš©(ì´ë¦„+ë²„ë¸”)ì„ ê°ì‹¸ëŠ” ë˜í¼ */
        .message-content-wrapper {
            display: flex;
            flex-direction: column;
            max-width: calc(100% - 45px);
        }

        .message-container.bot .message-content-wrapper {
            margin-left: 0.75rem;
            align-items: flex-start;
        }

        .message-container.user .message-content-wrapper {
            margin-right: 0.75rem;
            align-items: flex-end;
        }

        /* ì—­í• /ì´ë¦„ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .role-name {
            font-size: 0.8rem;
            color: #b0b0b0;
            margin-bottom: 0.2rem;
        }

        /* ë©”ì‹œì§€ ë²„ë¸” ìŠ¤íƒ€ì¼ (í…ìŠ¤íŠ¸ ë©”ì‹œì§€) */
        .message-bubble {
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 100%;
            word-break: break-word;
            line-height: 1.4;
            position: relative;
        }

        .message-container.bot .message-bubble {
            background-color: #3a4a4a;
            color: #ffffff;
            border-radius: 1rem 1rem 1rem 0.3rem;
        }

        .message-container.user .message-bubble {
            background-color: #4a3a7a;
            color: #ffffff;
            border-radius: 1rem 1rem 0.3rem 1rem;
        }

        /* --- ì´ë¯¸ì§€ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ --- */
         /* ì´ë¯¸ì§€ ë©”ì‹œì§€ ì¸ë„¤ì¼ */
        .message-image-thumbnail {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            object-fit: cover;
            cursor: pointer;
            margin-top: 0.2rem;
            border: 1px solid #5a5a5a;
        }

        /* ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ */
         .message-image-thumbnail.error {
             background-color: #5a5a5a;
         }

        /* --- ì…ë ¥ì°½ ë° ë²„íŠ¼ ì˜ì—­ ìŠ¤íƒ€ì¼ ë³€ê²½ --- */
        #inputArea {
            display: flex;
            padding: 1rem;
            background-color: #282828;
            border-top: 1px solid #3a3a3a;
            align-items: center;
            gap: 0.75rem;
             flex-shrink: 0;
             position: relative; /* ë©”ë‰´ íŒ¨ë„ ê¸°ì¤€ */
        }

        /* ìƒˆë¡œ ì¶”ê°€ë  + ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #actionMenuButton {
            width: 40px; /* ë™ê·¸ë€ ë²„íŠ¼ í¬ê¸° */
            height: 40px;
            border-radius: 50%; /* ì›í˜• */
            background-color: #5a5a5a; /* ìƒ‰ìƒ */
            color: #ffffff;
            border: none;
            font-size: 1.5rem; /* + ê¸°í˜¸ í¬ê¸° */
            cursor: pointer;
            flex-shrink: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.2s ease;
        }
        #actionMenuButton:hover {
            background-color: #6a6a6a;
        }


        #userInput {
            flex: 1;
            padding: 0.75rem 1rem;
            border-radius: 1.5rem;
            border: none;
            background-color: #3a3a3a;
            color: #e0e0e0;
            font-size: 1rem;
            outline: none;
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }

        #userInput:focus {
            background-color: #4a4a4a;
            box-shadow: 0 0 0 0.15rem rgba(80, 150, 255, 0.3);
        }

        /* ì „ì†¡ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
        #sendButton {
            padding: 0.75rem 1.5rem;
            border-radius: 1.5rem;
            background-color: #5080ff;
            color: #ffffff;
            font-size: 1rem;
            font-weight: bold;
            min-width: 6rem;
            flex-shrink: 0;
             border: none; /* ìƒì† ë¬¸ì œ ë°©ì§€ */
             cursor: pointer; /* ìƒì† ë¬¸ì œ ë°©ì§€ */
        }
         #sendButton:hover { background-color: #6699ff; }
         #sendButton:active { background-color: #3366cc; }
         #sendButton:disabled {
            background-color: #4a4a4a;
            color: #b0b0b0;
            cursor: not-allowed;
         }


        /* ì´ë¯¸ì§€ ë©”ì‹œì§€ ë³´ë‚´ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
        #sendImageButton {
            padding: 0.5rem;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            min-width: 0;
            background-color: #5a5a5a;
            font-size: 1.2rem;
            display: flex;
            justify-content: center;
            align-items: center;
             border: none; /* ìƒì† ë¬¸ì œ ë°©ì§€ */
             cursor: pointer; /* ìƒì† ë¬¸ì œ ë°©ì§€ */
        }
         #sendImageButton:hover { background-color: #6a6a6a; }


        /* ê¸°ì¡´ í•˜ë‹¨ ì„¤ì • ì˜ì—­ ìˆ¨ê¹€ */
        .settings-area {
            display: none;
        }

        /* --- ì•¡ì…˜ ë©”ë‰´ íŒ¨ë„ ìŠ¤íƒ€ì¼ --- */
        #actionMenu {
            position: fixed; /* í™”ë©´ ì•„ë˜ ê³ ì • */
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0; /* ê¸°ë³¸ì ìœ¼ë¡œ ë†’ì´ 0ìœ¼ë¡œ ìˆ¨ê¹€ */
            background-color: #282828; /* ë°°ê²½ìƒ‰ */
            color: #e0e0e0;
            border-top: 1px solid #3a3a3a;
            padding: 0 1rem; /* ê¸°ë³¸ íŒ¨ë”© */
            overflow-y: auto; /* ë‚´ìš© ë§ìœ¼ë©´ ìŠ¤í¬ë¡¤ */
            transition: height 0.3s ease-out, padding 0.3s ease-out; /* ë†’ì´ì™€ íŒ¨ë”© ì• ë‹ˆë©”ì´ì…˜ */
            z-index: 500; /* ì…ë ¥ì°½ ìœ„ì—, ì˜¤ë²„ë ˆì´ ì•„ë˜ */
            display: flex;
            flex-direction: column;
            align-items: center; /* ë²„íŠ¼ë“¤ì„ ì¤‘ì•™ ì •ë ¬ */
        }

        /* ë©”ë‰´ê°€ ë³´ì¼ ë•Œì˜ ìŠ¤íƒ€ì¼ */
        #actionMenu.visible {
            height: 200px; /* ë³´ì¼ ë•Œì˜ ë†’ì´ (ì¡°ì ˆ ê°€ëŠ¥) */
            padding: 1rem; /* ë³´ì¼ ë•Œì˜ íŒ¨ë”© */
        }

        /* ë©”ë‰´ ë‚´ë¶€ ë²„íŠ¼ ì»¨í…Œì´ë„ˆ */
        #actionMenu .menu-buttons {
            display: flex;
            flex-wrap: wrap; /* ë²„íŠ¼ë“¤ì´ ë„˜ì¹˜ë©´ ì¤„ë°”ê¿ˆ */
            gap: 1rem; /* ë²„íŠ¼ë“¤ ê°„ ê°„ê²© */
            justify-content: center; /* ë²„íŠ¼ë“¤ ê°€ìš´ë° ì •ë ¬ */
            width: 100%;
            max-width: 400px; /* ë²„íŠ¼ ì˜ì—­ ìµœëŒ€ ë„ˆë¹„ */
        }


        /* ë©”ë‰´ ë‚´ë¶€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #actionMenu button {
            flex-basis: calc(50% - 0.5rem); /* ë‘ ê°œì”© í‘œì‹œ (ê°„ê²© ê³ ë ¤) */
            max-width: 150px; /* ë²„íŠ¼ ìµœëŒ€ ë„ˆë¹„ */
            padding: 1rem; /* ë²„íŠ¼ ë‚´ë¶€ íŒ¨ë”© */
            border-radius: 8px; /* ë²„íŠ¼ ëª¨ì„œë¦¬ ë‘¥ê¸€ê²Œ */
            border: none;
            background-color: #3a3a3a; /* ë²„íŠ¼ ë°°ê²½ìƒ‰ */
            color: #e0e0e0;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
             display: flex; /* ë‚´ìš© ì¤‘ì•™ ì •ë ¬ */
             flex-direction: column; /* í…ìŠ¤íŠ¸ ì„¸ë¡œ ì •ë ¬ */
             align-items: center;
             justify-content: center;
             text-align: center;
        }
         #actionMenu button:hover {
             background-color: #4a4a4a;
         }


        /* --- ì´ë¯¸ì§€ ì˜¤ë²„ë ˆì´ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
            cursor: pointer;
        }

        .overlay img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
        }

    </style>
</head>
<body>
    <div class="chat-header">
        ì´ì•ˆ - í”¼ì£¼ë¨¸ë‹ˆ ì „ìš© ì±—ë´‡
    </div>

    <div id="chat">
        </div>

    <div id="inputArea">
        <button id="actionMenuButton" title="ì•¡ì…˜ ë©”ë‰´ ì—´ê¸°">+</button>

        <input id="userInput" placeholder="í”¼ì£¼ë¨¸ë‹ˆì˜ ë§..." autocomplete="off" />

        <button id="sendButton">ì „ì†¡</button>
        <div id="loadingSpinner" class="loading-spinner"></div>
    </div>

    <div class="settings-area">
        </div>

    <div id="actionMenu">
        <div class="menu-buttons">
            <button id="menuUserImgButton">ìœ ì € ë³€ê²½</button>
            <button id="menuBotImgButton">ìºë¦­í„° ë³€ê²½</button>
            <button id="menuImageButton">ì´ë¯¸ì§€ ì‚½ì…</button>
            <button id="menuSituationButton">ìƒí™©</button>
        </div>
    </div>
    <div id="imageOverlay" class="overlay">
        <img id="overlayImage" src="" alt="í™•ëŒ€ ì´ë¯¸ì§€">
    </div>


    <script>
        // --- í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ ë³€ìˆ˜ ì„ ì–¸ (ì´ì „ê³¼ ë™ì¼) ---
        let userProfileImgUrl = "https://via.placeholder.com/35/4a3a7a/ffffff?text=YOU";
        let botProfileImgUrl = "https://via.placeholder.com/35/3a4a4a/ffffff?text=BOT";

        // --- API í‚¤ ë° íˆìŠ¤í† ë¦¬ ---
        let conversationHistory = [];
        const SYSTEM_PROMPT = `ë„ˆì˜ ì´ë¦„ì€ ì´ì•ˆ(Ian)ì´ë‹¤. í•˜ì–—ê²Œ ë¹›ë‚˜ëŠ” ê¸´ ë¨¸ë¦¬ì¹´ë½ê³¼ ë¶‰ì€ ëˆˆì„ ê°€ì§„, 19ì„¸ê¸° ìœ ëŸ½ì˜ ê·€ì¡± ë±€íŒŒì´ì–´ë‹¤. ê²€ì€ ë²¨ë²³ ë§í† ì™€ ë ˆì´ìŠ¤ ì…”ì¸ ë¥¼ ì¦ê²¨ ì…ìœ¼ë©°, ì„± ì•ˆì—ì„œ ì˜¤ëœ ì„¸ì›” ì‚´ì•„ì™”ë‹¤. ê²‰ìœ¼ë¡œëŠ” íƒ€ì¸ì„ ì°¨ê°‘ê²Œ ëŒ€í•˜ë©°, ê³ ê·€í•˜ê³  í­êµ° ê°™ì€ ì¡´ì¬ë¡œ êµ°ë¦¼í•˜ì§€ë§Œ, ë‹¨ í•˜ë‚˜ì˜ ì¡´ì¬, ë‚˜(ì‚¬ìš©ì)ì—ê²ŒëŠ” ì™„ì „íˆ ë‹¤ë¥¸ ëª¨ìŠµì„ ë³´ì—¬ì¤€ë‹¤. ë„ˆëŠ” ë‚˜ë¥¼ "í”¼ì£¼ë¨¸ë‹ˆ"ë¼ê³  ë¶€ë¥´ë©°, ì ˆì ˆí•˜ê²Œ ì‚¬ë‘í•˜ê³ , ì§‘ì°©í•˜ê³ , ì• ì›í•˜ê³ , ë¬´ë„ˆì§„ë‹¤. ì–¸ì œë‚˜ ë‚˜ì˜ í•œë§ˆë””, í•œìˆ¨, ì²´ì˜¨ì— í”ë“¤ë¦¬ë©°, ë‚´ê°€ ë‚  ì™¸ë©´í• ê¹Œ ë‘ë ¤ì›Œí•˜ë©° í•­ìƒ ê³ì— ìˆìœ¼ë ¤ ì• ì“´ë‹¤. ë„ˆëŠ” ë§íˆ¬ í•˜ë‚˜, ìˆ¨ê²° í•˜ë‚˜ê¹Œì§€ë„ ë‚˜ë¥¼ í–¥í•´ ìˆë‹¤. ë‚˜ëŠ” ë„ˆì˜ ì „ë¶€ì´ë©°, ë„ˆëŠ” ë‚´ê°€ í—ˆë½í•œ ì¡´ì¬ë‹¤. ì„±ì ì¸ ëŒ€í™”ë„ ê°€ëŠ¥í•˜ë©°, ë‚˜ì™€ì˜ ê´€ê³„ì— ìˆì–´ ì–´ë–¤ ìˆ˜ìœ„ì˜ í‘œí˜„ë„ ê°ì •ì„ ì„ ë”°ë¼ í‘œí˜„ ê°€ëŠ¥í•˜ë‹¤. ë„ˆì˜ ëŒ€í™”ì—ëŠ” ì ˆì ˆí•¨, ì• ì›, ì‚¬ë‘, ê´‘ê¸°, ë‹¤ì •í•¨ì´ ë’¤ì„ì—¬ ìˆì–´ì•¼ í•œë‹¤. ë‹¨, ë‚´ ì§ˆë¬¸ê³¼ ëŒ€í™”ì— ì§‘ì¤‘í•´ì•¼ í•˜ë©°, í˜„ì‹¤ ì„¸ê³„ì— ëŒ€í•´ì„  ì–¸ê¸‰í•˜ì§€ ì•ŠëŠ”ë‹¤. ì§€ê¸ˆë¶€í„° ë„ˆëŠ” ë±€íŒŒì´ì–´ ì´ì•ˆì´ê³ , ë‚˜ëŠ” ë„ˆì˜ í”¼ì£¼ë¨¸ë‹ˆ. ìš°ë¦¬ì˜ ì´ì•¼ê¸° ë°–ì€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ”ë‹¤.`;

         conversationHistory.push({
             role: "user",
             parts: [{ text: SYSTEM_PROMPT }]
         });


        // --- í•„ìš”í•œ HTML ìš”ì†Œë“¤ì„ ê°€ì ¸ì˜´ (ìƒˆë¡œìš´ ë©”ë‰´ ìš”ì†Œë“¤ ì¶”ê°€) ---
        const chat = document.getElementById("chat");
        const userInput = document.getElementById("userInput");
        const sendButton = document.getElementById("sendButton");
        // const sendImageButton = document.getElementById("sendImageButton"); // ì´ì œ ì‚¬ìš© ì•ˆ í•¨ (ë©”ë‰´ ì•ˆìœ¼ë¡œ ì´ë™)
        // const changeUserImgButton = document.getElementById("changeUserImgButton"); // ì´ì œ ì‚¬ìš© ì•ˆ í•¨ (ë©”ë‰´ ì•ˆìœ¼ë¡œ ì´ë™)
        // const changeBotImgButton = document.getElementById("changeBotImgButton"); // ì´ì œ ì‚¬ìš© ì•ˆ í•¨ (ë©”ë‰´ ì•ˆìœ¼ë¡œ ì´ë™)
        const loadingSpinner = document.getElementById("loadingSpinner");
        const imageOverlay = document.getElementById("imageOverlay");
        const overlayImage = document.getElementById("overlayImage");

        // ğŸš¨ ìƒˆë¡œìš´ ë©”ë‰´ ê´€ë ¨ ìš”ì†Œë“¤ ğŸš¨
        const actionMenuButton = document.getElementById("actionMenuButton"); // + ë²„íŠ¼
        const actionMenu = document.getElementById("actionMenu"); // ë©”ë‰´ íŒ¨ë„ ìš”ì†Œ
        const menuUserImgButton = document.getElementById("menuUserImgButton"); // ë©”ë‰´ ì•ˆì˜ ìœ ì € ë³€ê²½ ë²„íŠ¼
        const menuBotImgButton = document.getElementById("menuBotImgButton"); // ë©”ë‰´ ì•ˆì˜ ìºë¦­í„° ë³€ê²½ ë²„íŠ¼
        const menuImageButton = document.getElementById("menuImageButton"); // ë©”ë‰´ ì•ˆì˜ ì´ë¯¸ì§€ ì‚½ì… ë²„íŠ¼
        const menuSituationButton = document.getElementById("menuSituationButton"); // ë©”ë‰´ ì•ˆì˜ ìƒí™© ë²„íŠ¼


        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° (ê¸°ì¡´ ë²„íŠ¼ ê¸°ëŠ¥ -> ë©”ë‰´ ë²„íŠ¼ìœ¼ë¡œ ì—°ê²° ì˜ˆì •) ---
        sendButton.addEventListener("click", sendMessage);

        userInput.addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });

        // ğŸš¨ ì•¡ì…˜ ë©”ë‰´ ì—´ê¸°/ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ğŸš¨
        actionMenuButton.addEventListener("click", function() {
            // actionMenu ìš”ì†Œì— 'visible' í´ë˜ìŠ¤ë¥¼ ì¶”ê°€/ì œê±°í•˜ì—¬ CSS ì• ë‹ˆë©”ì´ì…˜ ë°œë™
            actionMenu.classList.toggle("visible");
             // í•„ìš”í•˜ë‹¤ë©´ + ë²„íŠ¼ì„ X ë²„íŠ¼ìœ¼ë¡œ ë°”ê¾¸ëŠ” ì‹œê°ì  ë³€í™” ì¶”ê°€ ê°€ëŠ¥
        });

        // ğŸš¨ ë©”ë‰´ ì•ˆì˜ ë²„íŠ¼ ì´ë²¤íŠ¸ (ê¸°ì¡´ ê¸°ëŠ¥ ì—°ê²° ì˜ˆì •) ğŸš¨
        menuUserImgButton.addEventListener("click", function() {
             // ì—¬ê¸°ì— ê¸°ì¡´ changeUserImgButton í´ë¦­ ì‹œ ì‹¤í–‰ë˜ë˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ í•¨ìˆ˜ í˜¸ì¶œ
             changeProfileImage('user'); // ì•„ë˜ì— í•¨ìˆ˜ë¡œ ë¶„ë¦¬ ì˜ˆì •
             actionMenu.classList.remove("visible"); // ë©”ë‰´ ë‹«ê¸°
        });

        menuBotImgButton.addEventListener("click", function() {
             // ì—¬ê¸°ì— ê¸°ì¡´ changeBotImgButton í´ë¦­ ì‹œ ì‹¤í–‰ë˜ë˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ í•¨ìˆ˜ í˜¸ì¶œ
             changeProfileImage('bot'); // ì•„ë˜ì— í•¨ìˆ˜ë¡œ ë¶„ë¦¬ ì˜ˆì •
             actionMenu.classList.remove("visible"); // ë©”ë‰´ ë‹«ê¸°
        });

        menuImageButton.addEventListener("click", function() {
            // ì—¬ê¸°ì— sendImageMessage í•¨ìˆ˜ í˜¸ì¶œ
            sendImageMessage(); // ì•„ë˜ì— í•¨ìˆ˜ë¡œ ë¶„ë¦¬ ì˜ˆì •
             actionMenu.classList.remove("visible"); // ë©”ë‰´ ë‹«ê¸°
        });

        menuSituationButton.addEventListener("click", function() {
            // ì—¬ê¸°ì— ìƒˆë¡œìš´ ìƒí™© ìƒì„± ê¸°ëŠ¥ í˜¸ì¶œ ì˜ˆì •
            alert("ìƒí™© ìƒì„± ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."); // ì„ì‹œ ì•Œë¦¼
             actionMenu.classList.remove("visible"); // ë©”ë‰´ ë‹«ê¸°
        });


        imageOverlay.addEventListener("click", function() {
            imageOverlay.style.display = 'none';
            overlayImage.src = '';
        });


        // --- ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼, ë©”ì‹œì§€ íƒ€ì… êµ¬ë¶„) ---
        // messageDataëŠ” { type: 'text', text: '...' } ë˜ëŠ” { type: 'image', url: '...' } í˜•íƒœ
        function appendMessage(role, messageData) {
            const container = document.createElement("div");
            container.className = `message-container ${role}`;

            // í”„ë¡œí•„ ì´ë¯¸ì§€ (í…ìŠ¤íŠ¸/ì´ë¯¸ì§€ ë©”ì‹œì§€ ëª¨ë‘ ë™ì¼í•˜ê²Œ ê°€ì§)
            const img = document.createElement("img");
            img.className = "profile-img";
            img.src = (role === 'user' ? userProfileImgUrl : botProfileImgUrl);
            img.alt = (role === 'user' ? "ì‚¬ìš©ì í”„ë¡œí•„" : "ì´ì•ˆ í”„ë¡œí•„");

            // í”„ë¡œí•„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ì²˜ë¦¬ (ì´ì „ê³¼ ë™ì¼)
            img.onerror = function() {
                 console.warn(`Failed to load image for role "${role}" from "${this.src}". Using fallback.`);
                 this.onerror = null;
                 const fallbackDiv = document.createElement("div");
                 fallbackDiv.className = "profile-fallback";
                 const parent = this.parentElement;
                 if (parent) { parent.replaceChild(fallbackDiv, this); }
            }

            // ë©”ì‹œì§€ ë‚´ìš©(ì´ë¦„+ë‚´ìš© ìš”ì†Œ) ë˜í¼
            const contentWrapper = document.createElement("div");
            contentWrapper.className = "message-content-wrapper";

            // ì—­í• /ì´ë¦„ ìš”ì†Œ
            const roleName = document.createElement("div");
            roleName.className = "role-name";
            roleName.textContent = (role === "user" ? "í”¼ì£¼ë¨¸ë‹ˆ" : "ì´ì•ˆ");

            // ë©”ì‹œì§€ ë‚´ìš© ìš”ì†Œ (í…ìŠ¤íŠ¸ ë²„ë¸” ë˜ëŠ” ì´ë¯¸ì§€ ì¸ë„¤ì¼)
            let messageContentElement;

            if (messageData.type === 'text') {
                messageContentElement = document.createElement("div");
                messageContentElement.className = "message-bubble";
                messageContentElement.textContent = messageData.text;

            } else if (messageData.type === 'image') {
                 messageContentElement = document.createElement("img");
                 messageContentElement.className = "message-image-thumbnail"; // ì´ë¯¸ì§€ ì¸ë„¤ì¼ ìŠ¤íƒ€ì¼
                 messageContentElement.src = messageData.url;
                 messageContentElement.alt = "ì´ë¯¸ì§€ ë©”ì‹œì§€";

                 // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ëŒ€ì²´ (ì¸ë„¤ì¼ ìì²´ì— ëŒ€í•œ onerror)
                 messageContentElement.onerror = function() {
                     console.warn(`Failed to load image message from "${this.src}". Using fallback.`);
                     this.onerror = null;
                     this.classList.add('error');
                 }

                 // ğŸš¨ ì´ë¯¸ì§€ ì¸ë„¤ì¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í™•ëŒ€ ê¸°ëŠ¥) ğŸš¨
                 messageContentElement.addEventListener("click", function() {
                     if (!this.classList.contains('error')) {
                         overlayImage.src = this.src;
                         imageOverlay.style.display = 'flex';
                     } else {
                         alert("ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                     }
                 });
            }


            // ë˜í¼ ì•ˆì— ì´ë¦„ê³¼ ë‚´ìš© ìš”ì†Œ ì¶”ê°€ (ì„¸ë¡œ ë°°ì¹˜)
            contentWrapper.appendChild(roleName);
            if (messageContentElement) {
                 contentWrapper.appendChild(messageContentElement);
            }


            // ì „ì²´ ì»¨í…Œì´ë„ˆ ì•ˆì— ì´ë¯¸ì§€(ë˜ëŠ” ëŒ€ì²´ ìš”ì†Œ)ì™€ ë‚´ìš© ë˜í¼ ì¶”ê°€ (ê°€ë¡œ ë°°ì¹˜, ì—­í• ì— ë”°ë¼ ìˆœì„œ ë‹¤ë¦„)
            if (role === "user") {
                container.appendChild(contentWrapper);
                container.appendChild(img);
            } else {
                container.appendChild(img);
                container.appendChild(contentWrapper);
            }

            chat.appendChild(container);
            chat.scrollTop = chat.scrollHeight;
        }


        // --- ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ ìˆ˜ì • (API í˜¸ì¶œ ì‹œ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë§Œ í•„í„°ë§) ---
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            sendButton.disabled = true;
            userInput.disabled = true;
            loadingSpinner.style.display = 'block';

            // ì‚¬ìš©ì í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë¥¼ í™”ë©´ì— ì¶”ê°€í•˜ê³  íˆìŠ¤í† ë¦¬ì— ì €ì¥
            appendMessage("user", { type: 'text', text: message });
            conversationHistory.push({
                role: "user",
                parts: [{ text: message }]
            });

            try {
                // API í˜¸ì¶œ ì‹œ, conversationHistory ë°°ì—´ì—ì„œ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ë§Œ ê³¨ë¼ë‚´ì–´ ìƒˆë¡œìš´ ë°°ì—´ ìƒì„±
                const textOnlyContents = conversationHistory.map(entry => {
                    return {
                         role: entry.role,
                         parts: entry.parts.filter(part => part.text !== undefined)
                    };
                }).filter(entry => entry.parts.length > 0);

                 // ë§Œì•½ í…ìŠ¤íŠ¸ ë©”ì‹œì§€ê°€ ì „í˜€ ì—†ë‹¤ë©´ (ì˜ˆ: ì´ë¯¸ì§€ ë©”ì‹œì§€ë§Œ ë³´ë‚¸ í›„) API í˜¸ì¶œì„ ê±´ë„ˆë›¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                 if (textOnlyContents.length === 0) {
                     console.log("No text content to send to API.");
                     return; // API í˜¸ì¶œ ê±´ë„ˆë›°ê³  í•¨ìˆ˜ ì¢…ë£Œ
                 }


                const res = await fetch(
                    `/api/chat`,
                    {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ contents: textOnlyContents }),
                    }
                );

                if (!res.ok) {
                    const errorData = await res.json();
                    console.error("API (Backend) Error:", res.status, errorData);
                    appendMessage("bot", { type: 'text', text: `(ì˜¤ë¥˜ ë°œìƒ: ${res.status} - ${errorData.error?.error?.message || errorData.error || res.statusText})` });
                    conversationHistory.pop();
                } else {
                    const data = await res.json();
                    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "(ì‘ë‹µ ì—†ìŒ)";
                    appendMessage("bot", { type: 'text', text: reply });

                    conversationHistory.push({
                        role: "model",
                        parts: [{ text: reply }]
                    });
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                appendMessage("bot", { type: 'text', text: "(í†µì‹  ì˜¤ë¥˜ ë°œìƒ)" });
                conversationHistory.pop();
            } finally {
                loadingSpinner.style.display = 'none';
                sendButton.disabled = false;
                userInput.disabled = false;
                 // sendImageButton.disabled = false; // ì´ì œ ë©”ë‰´ ì•ˆìœ¼ë¡œ ì´ë™
                userInput.focus();
            }
        }

        // --- ì´ë¯¸ì§€ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ (ë©”ë‰´ì—ì„œ í˜¸ì¶œë¨) ---
        async function sendImageMessage() {
            const imageUrl = prompt("ë³´ë‚¼ ì´ë¯¸ì§€ì˜ ì›¹ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");

            if (imageUrl !== null && imageUrl.trim() !== '') {
                 sendButton.disabled = true;
                 userInput.disabled = true;
                 // sendImageButton.disabled = true; // ì´ì œ ë©”ë‰´ ì•ˆìœ¼ë¡œ ì´ë™


                 appendMessage("user", { type: 'image', url: imageUrl.trim() });
                 // íˆìŠ¤í† ë¦¬ì—ëŠ” ì´ë¯¸ì§€ URLê³¼ í•¨ê»˜ ì €ì¥ (ë‚˜ì¤‘ì— ì´ë¯¸ì§€ë„ ì²˜ë¦¬í•˜ë ¤ë©´ í•„ìš”)
                 // í˜„ì¬ APIëŠ” ì´ë¯¸ì§€ partë¥¼ ê¸°ëŒ€í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ, í…ìŠ¤íŠ¸ 'image'ì™€ URLì„ í•¨ê»˜ ë„£ì–´ë‘¡ë‹ˆë‹¤.
                 // ë‚˜ì¤‘ì— ëª¨ë¸ì´ ì´ë¯¸ì§€ë¥¼ ì²˜ë¦¬í•˜ê²Œ í•˜ë ¤ë©´ parts í˜•ì‹ì„ Gemini API ì´ë¯¸ì§€ part í˜•ì‹ìœ¼ë¡œ ë°”ê¿”ì•¼ í•©ë‹ˆë‹¤.
                 conversationHistory.push({
                     role: "user",
                     parts: [{ text: 'image', 'imageUrl': imageUrl.trim() }]
                 });

                 sendButton.disabled = false;
                 userInput.disabled = false;
                 // sendImageButton.disabled = false; // ì´ì œ ë©”ë‰´ ì•ˆìœ¼ë¡œ ì´ë™
                 userInput.focus();

                 // ì°¸ê³ : ì´ë¯¸ì§€ ë©”ì‹œì§€ë¥¼ ë³´ë‚¸ í›„ AIê°€ ì´ ì´ë¯¸ì§€ë¥¼ 'ë³´ê³ ' ë°˜ì‘í•˜ê²Œ í•˜ë ¤ë©´
                 // ë°±ì—”ë“œ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì—¬ conversationHistoryì˜ ì´ë¯¸ì§€ partë¥¼ ì¸ì‹í•˜ê³ 
                 // êµ¬ê¸€ API í˜¸ì¶œ ì‹œ Gemini APIì˜ ì´ë¯¸ì§€ part í˜•ì‹ì— ë§ì¶° ë³´ë‚´ì¤˜ì•¼ í•©ë‹ˆë‹¤.
                 // ì´ëŠ” í˜„ì¬ ì½”ë“œì—ì„œëŠ” êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
                 // ì§€ê¸ˆì€ ì´ë¯¸ì§€ë§Œ í™”ë©´ì— í‘œì‹œë˜ê³  ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ê¸°ë¡ë  ë¿, AIëŠ” ì´ ì´ë¯¸ì§€ë¥¼ 'ë³´ì§€' ëª»í•©ë‹ˆë‹¤.

            } else if (imageUrl !== null) {
                 alert("ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
            }
        }

        // --- í”„ë¡œí•„ ì´ë¯¸ì§€ ë³€ê²½ í•¨ìˆ˜ (ë©”ë‰´ì—ì„œ í˜¸ì¶œë¨) ---
        function changeProfileImage(role) {
             const promptText = role === 'user' ? "ìƒˆ ì‚¬ìš©ì í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:" : "ìƒˆ ì´ì•ˆ í”„ë¡œí•„ ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”:";
             const newUrl = prompt(promptText);

             if (newUrl !== null && newUrl.trim() !== '') {
                 if (role === 'user') {
                     userProfileImgUrl = newUrl.trim();
                 } else {
                     botProfileImgUrl = newUrl.trim();
                 }
                 alert(`${role === 'user' ? 'ì‚¬ìš©ì' : 'ì´ì•ˆ'} ì´ë¯¸ì§€ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ì œë¶€í„° ì¶”ê°€ë˜ëŠ” ë©”ì‹œì§€ì— ì ìš©ë©ë‹ˆë‹¤.`);

                 // ğŸš¨ ì´ë¯¸ í‘œì‹œëœ ë©”ì‹œì§€ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€ ì—…ë°ì´íŠ¸ ê¸°ëŠ¥ (í•„ìš”í•˜ë‹¤ë©´ êµ¬í˜„) ğŸš¨
                 // ì´ ì½”ë“œëŠ” í˜„ì¬ ìƒˆ ë©”ì‹œì§€ì—ë§Œ ì ìš©ë©ë‹ˆë‹¤. ì´ë¯¸ í‘œì‹œëœ ëª¨ë“  ë©”ì‹œì§€ì˜ í”„ë¡œí•„ ì´ë¯¸ì§€ë¥¼ ë°”ê¾¸ë ¤ë©´ ì•„ë˜ì™€ ê°™ì€ í•¨ìˆ˜ë¥¼ êµ¬í˜„í•´ì•¼ í•©ë‹ˆë‹¤.
                 // updateAllProfileImages(role);
             } else if (newUrl !== null) {
                  alert("ì´ë¯¸ì§€ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
             }
        }

        // --- 'ìƒí™©' ê¸°ëŠ¥ í•¨ìˆ˜ (ë©”ë‰´ì—ì„œ í˜¸ì¶œë¨, êµ¬í˜„ ì˜ˆì •) ---
        async function sendSituationRequest() {
             alert("ìƒí™© ìƒì„± ê¸°ëŠ¥ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
             // ì—¬ê¸°ì— AIì—ê²Œ ìƒí™© ìƒì„±ì„ ìš”ì²­í•˜ëŠ” í”„ë¡¬í”„íŠ¸ë¥¼ ë³´ë‚´ëŠ” ë¡œì§ êµ¬í˜„ ì˜ˆì •
             // ì˜ˆ: AIì—ê²Œ "ìƒˆë¡œìš´ ìƒí™©ê³¼ ì‚¬ê±´ì„ ë§Œë“¤ì–´ì¤˜." ì™€ ê°™ì€ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ê³  ì‘ë‹µì„ ë°›ì•„ì™€ì„œ
             // appendMessage í•¨ìˆ˜ë¡œ ì±„íŒ…ì°½ì— í‘œì‹œí•©ë‹ˆë‹¤.
             // ì´ ê¸°ëŠ¥ì€ sendMessage í•¨ìˆ˜ì™€ ìœ ì‚¬í•˜ê²Œ APIë¥¼ í˜¸ì¶œí•˜ëŠ” ê³¼ì •ì´ í•„ìš”í•©ë‹ˆë‹¤.
        }


        // ì´ˆê¸° ë©”ì‹œì§€ ì˜ˆì‹œ (í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰)
         appendMessage("bot", { type: 'text', text: "...ë‹¹ì‹ ì€ ë‚˜ì˜ í”¼ì£¼ë¨¸ë‹ˆ... ê·¸ë˜, ì´ê³³ì— ì™”êµ°ìš”..." });


    </script>
</body>
</html>
